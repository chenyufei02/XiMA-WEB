<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®æŒ‡æŒ¥ä¸­å¿ƒ - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- 1. å…¨å±€å˜é‡ä¸åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --text-muted: #6c6c80;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --accent-yellow: #ff9f43;
            --border-color: rgba(255,255,255,0.08);
            --header-height: 70px;
            --sidebar-width: 240px;
            --transition-speed: 0.3s;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- 2. ä¾§è¾¹æ æ ·å¼ (SideBar) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: width var(--transition-speed);
        }

        /* [ä¿®æ”¹] é¡¹ç›®æ ‡é¢˜åŒºåŸŸï¼šå…è®¸æ¢è¡Œï¼Œè§£å†³é•¿æ ‡é¢˜æˆªæ–­é—®é¢˜ */
        .project-title-area {
            min-height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-blue);
            padding: 10px 15px; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è· */
            font-size: 16px;
            letter-spacing: 0.5px;
            cursor: default;
            /* ä¿®æ”¹ï¼šå…è®¸æ¢è¡Œ */
            white-space: normal;
            line-height: 1.3;
            text-align: center;
            background: rgba(0,0,0,0.1);
        }

        .project-title-area i {
            margin-right: 8px;
            font-size: 20px;
            flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
        }

        .nav-menu {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(115, 103, 240, 0.15), transparent);
            color: var(--accent-purple);
            border-left-color: var(--accent-purple);
        }

        .nav-item i {
            margin-right: 15px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* --- 3. å³ä¾§ä¸»å†…å®¹åŒº (Main Content) --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            min-width: 0;
            background-image: radial-gradient(circle at 10% 10%, rgba(40,40,55,0.5) 0%, transparent 20%);
        }

        /* é¡¶éƒ¨ Header */
        .header {
            height: var(--header-height);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            background: rgba(30, 30, 45, 0.95);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* å†…å®¹æ»šåŠ¨å®¹å™¨ */
        .scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            scroll-behavior: smooth;
        }

        /* ğŸ”¥ [æ–°å¢] è‡ªåŠ¨åŒ–ç›‘æ§é©¾é©¶èˆ±æ ·å¼ */
        .monitor-dashboard {
            background: #232333; border: 1px solid #3b3b4f; border-radius: 16px;
            margin-bottom: 35px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .monitor-header {
            background: rgba(0,0,0,0.2); padding: 15px 25px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .monitor-title { font-size: 16px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px; }
        .monitor-body { display: flex; padding: 25px; gap: 30px; }

        .monitor-panel {
            flex: 1; background: rgba(40, 40, 60, 0.4); border-radius: 12px;
            padding: 20px; border: 1px solid rgba(255,255,255,0.05); position: relative;
        }
        .monitor-panel.dji { border-top: 3px solid var(--accent-blue); }
        .monitor-panel.report { border-top: 3px solid var(--accent-green); }

        .panel-head { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .panel-title { font-size: 14px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .status-indicator {
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            padding: 4px 10px; border-radius: 20px;
            background: rgba(40, 199, 111, 0.1); color: var(--accent-green); border: 1px solid rgba(40, 199, 111, 0.2);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .metric-item { display: flex; flex-direction: column; gap: 5px; }
        .metric-label { font-size: 12px; color: var(--text-muted); }
        .metric-value { font-size: 18px; color: #fff; font-weight: 600; font-family: 'Consolas', monospace; }
        .countdown-box { margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center; }
        .countdown-val { font-size: 14px; color: var(--accent-yellow); font-weight: bold; }

        .log-terminal {
            background: #101015; padding: 15px; border-top: 1px solid var(--border-color);
            font-family: 'Consolas', monospace; font-size: 12px; color: #ccc;
            height: 120px; overflow-y: auto;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.02); padding-bottom: 2px; }
        .log-time { color: #666; margin-right: 10px; }
        .log-tag.info { color: var(--accent-blue); }
        .log-tag.success { color: var(--accent-green); }
        .log-tag.error { color: var(--accent-red); }

        /* --- 4. ç»Ÿè®¡å¡ç‰‡åŒº (Stats Cards) --- */
        .overview-row {
            display: flex;
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            flex: 1;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* å¡ç‰‡ä¾§è¾¹å½©è‰²æ¡ */
        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .stat-card.purple::before { background-color: var(--accent-purple); }
        .stat-card.red::before { background-color: var(--accent-red); }
        .stat-card.green::before { background-color: var(--accent-green); }
        .stat-card.blue::before { background-color: var(--accent-blue); }

        .stat-icon-box {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255,255,255,0.05);
        }

        .stat-info h3 {
            margin: 0 0 5px 0;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }

        .stat-info small {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: normal;
            margin-left: 5px;
        }

        .stat-info p {
            margin: 0;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* --- 5. æ¥¼æ ‹è¯¦æƒ…å¡ç‰‡ (Building Cards) --- */
        .building-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding-bottom: 50px;
        }

        .building-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .building-card:hover {
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-color: rgba(115, 103, 240, 0.3);
        }

        /* å¡ç‰‡å¤´éƒ¨ */
        .b-header {
            padding: 20px 30px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .b-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
        }

        .b-meta {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .b-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .b-meta i { color: var(--accent-purple); }

        /* çŠ¶æ€å¾½ç«  */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-danger { background: rgba(234, 84, 85, 0.15); color: var(--accent-red); border: 1px solid rgba(234, 84, 85, 0.2); }
        .status-success { background: rgba(40, 199, 111, 0.15); color: var(--accent-green); border: 1px solid rgba(40, 199, 111, 0.2); }
        .status-warning { background: rgba(255, 159, 67, 0.15); color: var(--accent-yellow); border: 1px solid rgba(255, 159, 67, 0.2); }
        .status-primary { background: rgba(115, 103, 240, 0.15); color: var(--accent-purple); border: 1px solid rgba(115, 103, 240, 0.2); }
        .status-info { background: rgba(0, 207, 232, 0.15); color: var(--accent-blue); border: 1px solid rgba(0, 207, 232, 0.2); }

        /* å›¾è¡¨å®¹å™¨ */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border-top: 1px solid rgba(255,255,255,0.02);
        }

        .chart-box {
            height: 320px;
            padding: 20px;
            position: relative;
            border-right: 1px solid var(--border-color);
        }

        .chart-box:last-child {
            border-right: none;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid var(--accent-blue);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chart-container {
            width: 100%;
            height: 260px;
        }

        /* --- 6. Element UI è¦†ç›–ä¸ Loading --- */
        /* --- æŒ‰é’®æ ·å¼ç»Ÿä¸€ (å¤ç”¨è®¡åˆ’é¡µé£æ ¼) --- */
        .el-button--default {
            background: transparent !important;
            border: 1px solid var(--text-secondary) !important;
            color: var(--text-secondary) !important;
            transition: all 0.3s;
        }
        .el-button--default:hover {
            color: #fff !important;
            border-color: #fff !important;
            background: rgba(255,255,255,0.05) !important;
        }

        /* ä¿æŒ Primary å’Œ Success æŒ‰é’®åŸæœ‰æ ·å¼ */
        .el-button--primary {
            background: linear-gradient(45deg, #7367f0, #9e95f5) !important;
            border: none !important;
            color: white !important;
        }
        .el-button--success {
            background: linear-gradient(45deg, #28c76f, #48da89) !important;
            border: none !important;
            color: white !important;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 80px 0;
            color: var(--text-muted);
        }
        .empty-state i { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state p { font-size: 16px; }

        .ai-float-ball {
            position: fixed;
            top: 50%;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #7367f0, #ce9ffc);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(115, 103, 240, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            z-index: 999;
            transition: transform 0.3s;
            user-select: none;
            touch-action: none;
        }
        .ai-float-ball:hover { transform: scale(1.1); }
        .ai-float-ball i { font-size: 24px; margin-bottom: 2px; }
        .ai-float-ball span { font-size: 10px; }

        .ai-result-box {
            background: #f5f5f7;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            color: #333;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div class="project-title-area" :title="dashboardData.projectName">
            <i class="el-icon-office-building"></i>
            <span>{{ dashboardData.projectName || 'æ­£åœ¨åŠ è½½...' }}</span>
        </div>

        <div class="nav-menu">
            <div class="nav-item active">
                <i class="el-icon-data-board"></i> æ•°æ®çœ‹æ¿
            </div>
            <div class="nav-item" @click="goToConfig('boundary')">
                <i class="el-icon-map-location"></i> ç”µå­å›´æ 
            </div>
            <div class="nav-item" @click="goToConfig('floor')">
                <i class="el-icon-office-building"></i> æ¥¼å±‚é…ç½®
            </div>
            <div class="nav-item" @click="goToConfig('plan')">
                <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
            </div>
        </div>
    </div>

    <div class="ai-float-ball"
         @click="handleBallClick"
         @mousedown="startDrag"
         :style="{ left: ballLeft + 'px', top: ballTop + 'px', right: 'auto' }"
         ref="aiBall">
        <i class="el-icon-s-custom"></i>
        <span>AI åˆ†æ</span>
    </div>

    <el-dialog title="AI æ™ºèƒ½é¡¹ç›®åˆ†æ" :visible.sync="showAiDialog" width="500px">
        <div v-loading="aiLoading" element-loading-text="Kimi æ­£åœ¨æ€è€ƒä¸­...">
            <div v-if="!aiResult" class="ai-empty">
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè®© AI ä¸ºæ‚¨åˆ†æå½“å‰é¡¹ç›®è¿›åº¦çš„é£é™©ä¸å»ºè®®ã€‚</p>
            </div>
            <div v-else class="ai-result-box">
                <div class="ai-avatar"><i class="el-icon-s-custom"></i></div>
                <div class="ai-text">{{ aiResult }}</div>
            </div>
        </div>
        <span slot="footer" class="dialog-footer">
            <el-button @click="showAiDialog = false">å…³ é—­</el-button>
            <el-button type="primary" @click="doAiAnalysis" :disabled="aiLoading">å¼€å§‹åˆ†æ</el-button>
            <el-button type="success" @click="sendAiMail" :disabled="!aiResult || sendingMail" icon="el-icon-message">
                {{ sendingMail ? 'å‘é€ä¸­...' : 'å‘é€è‡³é‚®ç®±' }}
            </el-button>
        </span>
    </el-dialog>

    <div class="main-content">
        <div class="header">
            <div style="flex:1"></div>

            <div class="header-controls" style="display: flex; align-items: center; gap: 10px;">
                <el-button
                    type="primary"
                    size="small"
                    icon="el-icon-cloudy"
                    :loading="syncing"
                    @click="handleSyncDji">
                    åŒæ­¥å¸ç©ºç…§ç‰‡
                </el-button>

                <el-button
                    type="success"
                    size="small"
                    icon="el-icon-refresh"
                    :loading="calculating"
                    @click="handleRecalculate">
                    åˆ·æ–°è¿›åº¦è®¡ç®—
                </el-button>

                <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 5px;"></div>

                <el-button
                    size="small"
                    icon="el-icon-s-home"
                    @click="goHome">
                    è¿”å›ç³»ç»Ÿé¦–é¡µ
                </el-button>
            </div>
        </div>

        <div class="scroll-container">

            <div v-if="loading" style="height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary);">
                <i class="el-icon-loading" style="font-size: 40px; color: var(--accent-purple); margin-bottom: 20px;"></i>
                <p>æ­£åœ¨ä»æ˜Ÿé™…é“¾è·¯æ‹‰å–å®æ—¶æ•°æ®...</p>
            </div>

            <div v-else>
                <div class="monitor-dashboard">
                    <div class="monitor-header">
                        <div class="monitor-title"><i class="el-icon-monitor"></i> è‡ªåŠ¨åŒ–ç›‘æ§æƒ…å†µå±•ç¤º (Auto-Monitor Hub)</div>
                        <div style="font-size:12px; color:rgba(255,255,255,0.5)">System Online â€¢ å®æ—¶åˆ·æ–°ä¸­</div>
                    </div>
                    <div class="monitor-body">
                        <div class="monitor-panel dji">
                            <div class="panel-head">
                                <span class="panel-title"><i class="el-icon-camera"></i> å¸ç©º2 æ— äººæœºå·¡æ£€</span>
                                <div class="status-indicator"><div class="status-dot"></div> è‡ªåŠ¨åŒæ­¥å¼€å¯</div>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">ç´¯è®¡é‡‡é›†(å¼ )</span>
                                    <span class="metric-value">{{ monitorData.totalPhotos || 0 }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">ä¸Šæ¬¡åŒæ­¥æ—¶é—´</span>
                                    <span class="metric-value" style="font-size:14px; margin-top:3px;">{{ monitorData.lastSyncTime || 'æœªçŸ¥' }}</span>
                                </div>
                            </div>
                            <div class="countdown-box">
                                <span style="font-size:12px; color:#aaa; margin-right:5px;">è·ç¦»ä¸‹æ¬¡åŒæ­¥:</span>
                                <span class="countdown-val">{{ monitorData.nextSyncTime || '--' }}</span>
                            </div>
                        </div>

                        <div class="monitor-panel report">
                            <div class="panel-head">
                                <span class="panel-title"><i class="el-icon-message"></i> æ™ºèƒ½é¡¹ç›®æ—¥æŠ¥</span>
                                <div class="status-indicator" style="background:rgba(115,103,240,0.1); color:var(--accent-purple); border-color:rgba(115,103,240,0.2);">
                                    <div class="status-dot" style="background:var(--accent-purple); box-shadow:0 0 8px var(--accent-purple);"></div>
                                    {{ monitorData.reportEnabled ? 'æ¯æ—¥æ¨é€ä¸­' : 'æœåŠ¡æš‚åœ' }}
                                </div>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-label">å®‰å…¨è¿è¡Œ(å¤©)</span>
                                    <span class="metric-value">{{ monitorData.runDays || 0 }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">ç´¯è®¡æ±‡æŠ¥(å°)</span>
                                    <span class="metric-value">{{ monitorData.totalReports || 0 }}</span>
                                </div>
                            </div>
                            <div class="countdown-box">
                                <span style="font-size:12px; color:#aaa; margin-right:5px;">ä¸‹æ¬¡å‘é€:</span>
                                <span class="countdown-val">{{ monitorData.nextReportTime || '--' }}</span>
                                <div style="font-size:10px; color:#666; margin-top:3px;">æ¥æ”¶äºº: {{ monitorData.receiverName || 'ç®¡ç†å‘˜' }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="log-terminal">
                        <div v-if="!monitorData.logs || monitorData.logs.length === 0" style="padding:10px;">æš‚æ— æ—¥å¿—...</div>
                        <div v-for="(log, i) in monitorData.logs" :key="i" class="log-line">
                            <span class="log-time">[{{ log.time }}]</span>
                            <span :class="['log-tag', log.type.toLowerCase()]">[{{ log.type }}]</span>
                            <span style="margin-left:8px;">{{ log.message }}</span>
                        </div>
                    </div>
                </div>
                <div class="overview-row">
                    <div class="stat-card purple">
                        <div class="stat-icon-box" style="color:var(--accent-purple)"><i class="el-icon-time"></i></div>
                        <div class="stat-info">
                            <h3>{{ dashboardData.safeRunDays }}<small>å¤©</small></h3>
                            <p>å®‰å…¨è¿è¡Œå¤©æ•°</p>
                        </div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon-box" style="color:var(--accent-red)"><i class="el-icon-warning-outline"></i></div>
                        <div class="stat-info">
                            <h3>{{ dashboardData.delayedCount }}<small>æ ‹</small></h3>
                            <p>æ»åé¢„è­¦æ¥¼æ ‹</p>
                        </div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon-box" style="color:var(--accent-green)"><i class="el-icon-circle-check"></i></div>
                        <div class="stat-info">
                            <h3>{{ dashboardData.normalCount }}<small>æ ‹</small></h3>
                            <p>è¿›åº¦æ­£å¸¸æ¥¼æ ‹</p>
                        </div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon-box" style="color:var(--accent-blue)"><i class="el-icon-camera"></i></div>
                        <div class="stat-info">
                            <h3 style="font-size: 20px; line-height: 28px;">{{ formatLastUpdate(dashboardData.lastUpdateDate) }}</h3>
                            <p>æœ€è¿‘é£æµ‹æ—¶é—´</p>
                        </div>
                    </div>
                </div>

                <div class="building-container">
                    <div v-for="(b, index) in dashboardData.buildings" :key="b.buildingId" class="building-card">

                        <div class="b-header">
                            <div class="b-title">
                                {{ b.buildingName }}
                                <span v-if="b.planName" style="font-size:12px; font-weight:normal; color:var(--text-secondary); margin-left: 5px;">
                                    (æ¨¡å‹: {{b.planName}})
                                </span>
                                <div :class="['status-badge', getStatusClass(b.statusColor)]">
                                    <i :class="getStatusIcon(b.statusColor)"></i>
                                    {{ b.statusTag }}
                                </div>
                            </div>
                            <div class="b-meta">
                                <span><i class="el-icon-office-building"></i> å½“å‰: {{ b.currentFloor }} å±‚</span>
                                <span><i class="el-icon-s-data"></i> é«˜åº¦: {{ b.currentHeight ? b.currentHeight.toFixed(1) : 0 }}m</span>
                                <span><i class="el-icon-date"></i> æ›´æ–°: {{ b.lastMeasureDate }}</span>
                            </div>
                        </div>

                        <div class="charts-row">
                            <div class="chart-box">
                                <div class="chart-header">
                                    <span class="chart-title">æ¥¼å±‚ç”Ÿé•¿è¶‹åŠ¿</span>
                                    <span class="chart-subtitle">è®¡åˆ’ vs å®é™…</span>
                                </div>
                                <div :id="'chart-trend-' + index" class="chart-container"></div>
                            </div>
                            <div class="chart-box">
                                <div class="chart-header" style="border-left-color: var(--accent-blue);">
                                    <span class="chart-title">ç‰©ç†é«˜åº¦ç”Ÿé•¿</span>
                                    <span class="chart-subtitle">å•ä½ï¼šç±³</span>
                                </div>
                                <div :id="'chart-height-' + index" class="chart-container"></div>
                            </div>
                            <div class="chart-box">
                                <div class="chart-header" style="border-left-color: var(--accent-green);">
                                    <span class="chart-title">è¿›åº¦åå·®åˆ†æ</span>
                                    <span class="chart-subtitle">æ­£æ•°=è¶…å‰ï¼Œè´Ÿæ•°=æ»å</span>
                                </div>
                                <div :id="'chart-diff-' + index" class="chart-container"></div>
                            </div>
                        </div>
                    </div>

                    <div v-if="dashboardData.buildings.length === 0" class="empty-state">
                        <i class="el-icon-document-delete"></i>
                        <p>æš‚æ— æ¥¼æ ‹æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»å·¦ä¾§ã€Œç”µå­å›´æ ã€è¿›è¡Œç»‘å®šé…ç½®ã€‚</p>
                        <el-button type="primary" size="small" @click="goToConfig('boundary')" style="margin-top: 15px;">å‰å¾€é…ç½®</el-button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            projectId: 1,
            loading: true,
            syncing: false,
            calculating: false,
            dashboardData: {
                projectName: '',
                safeRunDays: 0,
                delayedCount: 0,
                normalCount: 0,
                buildings: [],
                // ğŸ”¥ [æ–°å¢] ç›‘æ§æ•°æ®
                monitorData: {
                    djiConnected: false, totalPhotos: 0, lastSyncTime: '--', nextSyncTime: '--',
                    reportEnabled: false, runDays: 0, totalReports: 0, lastReportTime: '--', nextReportTime: '--', receiverName: '--',
                    logs: []
                },
                monitorTimer: null,
            },
            showAiDialog: false, // æ§åˆ¶å¼¹çª—æ˜¾ç¤º
            aiLoading: false,    // æ§åˆ¶AIæ€è€ƒä¸­çš„åŠ è½½çŠ¶æ€
            aiResult: '',        // å­˜å‚¨AIåˆ†æçš„æ–‡å­—ç»“æœ
            sendingMail: false ,  // æ§åˆ¶é‚®ä»¶å‘é€ä¸­çš„çŠ¶æ€
            // === æ–°å¢æ‹–æ‹½ç›¸å…³å˜é‡ ===
            ballLeft: document.documentElement.clientWidth - 80, // åˆå§‹é å³
            ballTop: document.documentElement.clientHeight / 2 - 30, // åˆå§‹å±…ä¸­
            isDragging: false,
            hasDragged: false, // åˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ‹–æ‹½
            dragStartX: 0,
            dragStartY: 0,
        },
        mounted() {
            // å°è¯•è¯»å–ä¸Šæ¬¡çš„é¡¹ç›®IDï¼Œå¦‚æœURLä¸­æ²¡æœ‰å‚æ•°ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜
            const pid = localStorage.getItem('currentProjectId');
            if(pid) this.projectId = pid;
            this.fetchData();
            // ğŸ”¥ [æ–°å¢] å¯åŠ¨ç›‘æ§æ•°æ®åˆ·æ–°
            this.fetchMonitorData();
            this.monitorTimer = setInterval(this.fetchMonitorData, 30000);
        },
        beforeDestroy() {
            if (this.monitorTimer) clearInterval(this.monitorTimer);
        },
        methods: {
            // è¿”å›é¦–é¡µ
            goHome() {
                localStorage.removeItem('fromDashboard'); // æ¸…é™¤æ ‡è®°
                window.location.href = 'index.html';
            },

            // [æ ¸å¿ƒä¿®å¤] è·³è½¬é…ç½®é¡µï¼šåŒæ—¶è®°å½•æ¥æºå’Œå½“å‰é¡¹ç›®ID
            goToConfig(type) {
                localStorage.setItem('fromDashboard', 'true');
                // ç¡®ä¿é¡¹ç›®IDè¢«ä¼ å…¥ï¼Œè§£å†³ä¸‹çº§é¡µé¢åç§°æ˜¾ç¤ºLoadingçš„é—®é¢˜
                if(this.projectId) {
                    localStorage.setItem('currentProjectId', this.projectId);
                }

                if(type === 'boundary') window.location.href = 'boundary.html';
                else if(type === 'floor') window.location.href = 'floor-config.html';
                else if(type === 'plan') window.location.href = 'plan-config.html';
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatLastUpdate(dateStr) {
                if (!dateStr || dateStr === 'æš‚æ— ') return 'æš‚æ— æ•°æ®';
                return dateStr.replace('T', ' ');
            },

            // è·å–çŠ¶æ€æ ·å¼ç±»
            getStatusClass(color) {
                return 'status-' + (color || 'info');
            },

            // è·å–çŠ¶æ€å›¾æ ‡
            getStatusIcon(color) {
                if (color === 'danger') return 'el-icon-warning';
                if (color === 'success') return 'el-icon-success';
                if (color === 'warning') return 'el-icon-timer';
                return 'el-icon-info';
            },

            // API: åŒæ­¥å¤§ç–†
            handleSyncDji() {
                this.syncing = true;
                const token = localStorage.getItem('token');
                axios.post(`/api/projects/${this.projectId}/sync`, {}, { headers: { 'Authorization': token ? 'Bearer ' + token : '' } })
                .then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.$message.success("äº‘ç«¯ç…§ç‰‡åŒæ­¥ä»»åŠ¡å·²å®Œæˆï¼");

                        // ğŸ”¥ [ä¿®æ”¹] å»æ‰ setTimeoutï¼Œç›´æ¥åˆ·æ–°ï¼Œå¹¶åŠ ä¸€ä¸ªéšæœºå‚æ•°é˜²æ­¢ç¼“å­˜
                        this.fetchData();
                        this.fetchMonitorData();
                    } else {
                        this.$message.error(res.data.message || "åŒæ­¥æŒ‡ä»¤å‘é€å¤±è´¥");
                    }
                }).catch(err => {
                    this.$message.error("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                }).finally(() => {
                    this.syncing = false;
                });
            },

            // API: é‡æ–°è®¡ç®—
            handleRecalculate() {
                this.calculating = true;
                const token = localStorage.getItem('token');
                axios.post(`/api/progress/calculate?projectId=${this.projectId}`, {}, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.$message.success("è¿›åº¦é‡ç®—å®Œæˆï¼");
                        this.fetchData();
                    } else {
                        this.$message.error(res.data.message || "è®¡ç®—å¤±è´¥");
                    }
                }).catch(err => {
                    this.$message.error("è¯·æ±‚å¤±è´¥");
                }).finally(() => {
                    this.calculating = false;
                });
            },

            // API: è·å–æ•°æ®
            fetchData() {
                const token = localStorage.getItem('token');
                axios.get(`/api/progress/dashboard/${this.projectId}`, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.dashboardData = res.data.data;
                        this.loading = false;

                        // [æ–°å¢] æˆåŠŸè·å–æ•°æ®åï¼Œæ›´æ–°ç¼“å­˜ä¸­çš„é¡¹ç›®IDï¼ŒåŒé‡ä¿é™©
                        if(this.dashboardData.projectId) {
                            localStorage.setItem('currentProjectId', this.dashboardData.projectId);
                        }

                        this.$nextTick(() => {
                            this.renderCharts();
                        });
                    } else {
                        this.$message.error("æ•°æ®è·å–å¤±è´¥");
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.error("ç½‘ç»œè¯·æ±‚å¼‚å¸¸");
                    this.loading = false;
                });
            },
            // ğŸ”¥ [æ–°å¢] è·å–ç›‘æ§é¢æ¿æ•°æ®æ¥å£
            fetchMonitorData() {
                const token = localStorage.getItem('token');
                axios.get(`/api/projects/${this.projectId}/monitor`, { headers: { 'Authorization': token ? 'Bearer ' + token : '' } })
                .then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.monitorData = res.data.data;
                    }
                }).catch(console.error);
            },

            // ECharts æ¸²æŸ“é€»è¾‘
            renderCharts() {
                this.dashboardData.buildings.forEach((b, index) => {
                    if (!b.dates || b.dates.length === 0) return;

                    const commonGrid = { top: 35, bottom: 25, left: 40, right: 15, containLabel: true };
                    const xAxis = { type: 'category', data: b.dates, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' } };
                    const yAxis = { type: 'value', splitLine: { lineStyle: { color: '#333', type: 'dashed' } }, axisLabel: { color: '#888' } };

                    // Chart 1: è¶‹åŠ¿
                    const chartTrend = echarts.init(document.getElementById('chart-trend-' + index));
                    chartTrend.setOption({
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['è®¡åˆ’', 'å®é™…'], textStyle: { color: '#a2a2b8' }, bottom: 0, icon: 'circle' },
                        grid: commonGrid,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        series: [
                            { name: 'è®¡åˆ’', type: 'line', data: b.planFloors, lineStyle: { color: '#28c76f', width: 2 }, showSymbol: false, itemStyle: {color: '#28c76f'} },
                            { name: 'å®é™…', type: 'line', data: b.actualFloors, lineStyle: { color: '#7367f0', width: 2 }, itemStyle: { color: '#7367f0' } }
                        ]
                    });


                    // --- å›¾2: ç‰©ç†é«˜åº¦ (é¢ç§¯å›¾) ---
                    const chartHeight = echarts.init(document.getElementById('chart-height-' + index));
                    chartHeight.setOption({
                        tooltip: {
                            trigger: 'axis',
                            // ğŸŸ¡ è‡ªå®šä¹‰æç¤ºæ¡†ï¼šå¦‚æœç…§ç‰‡å°‘ï¼Œåœ¨æµ®å±‚é‡Œä¹Ÿæç¤º
                            formatter: function (params) {
                                let res = params[0].name + '<br/>';
                                params.forEach(item => {
                                    // è·å–æˆ‘ä»¬åœ¨ data é‡Œå¡è¿›å»çš„ photoCount
                                    const count = item.data.photoCount;
                                    // å¦‚æœ count å­˜åœ¨ä¸”å°äº3ï¼ŒåŠ ä¸ªçº¢è‰²è­¦å‘Šå­—æ ·
                                    const warn = (count !== undefined && count < 3)
                                        ? ' <span style="color:orange;font-weight:bold;">(âš ï¸ç…§ç‰‡ä¸è¶³)</span>'
                                        : '';
                                    res += item.marker + item.seriesName + ': ' + item.value + 'm' + warn + '<br/>';
                                });
                                return res;
                            }
                        },
                        grid: { top: 30, bottom: 30, left: 40, right: 20 },
                        xAxis: { type: 'category', data: b.dates, axisLine: { lineStyle: { color: '#555' } } },
                        yAxis: { type: 'value', splitLine: { lineStyle: { color: '#333' } } },
                        series: [
                            {
                                name: 'é«˜åº¦(m)',
                                type: 'line',
                                // ğŸŸ¡ å…³é”®ä¿®æ”¹ï¼šé‡ç»„æ•°æ®ç»“æ„ï¼ŒæŠŠ photoCount å¡è¿›å»
                                data: b.dates.map((d, i) => ({
                                    value: b.actualHeights[i],
                                    // å‡å¦‚åç«¯è¿˜æ²¡æœ‰ä¼  photoCounts æ•°ç»„ï¼Œé»˜è®¤ç»™ä¸ªå®‰å…¨å€¼(10)ï¼Œé˜²æ­¢æŠ¥é”™
                                    photoCount: (b.photoCounts && b.photoCounts[i] !== undefined) ? b.photoCounts[i] : 10
                                })),
                                smooth: true,
                                lineStyle: { color: '#00cfe8' },
                                areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(0, 207, 232, 0.5)'}, {offset: 1, color: 'rgba(0, 207, 232, 0)'}]) },

                                // ğŸŸ¡ æ ¸å¿ƒé€»è¾‘ï¼šåŠ¨æ€å˜è‰²
                                itemStyle: {
                                    color: function(params) {
                                        // å¦‚æœç…§ç‰‡æ•° < 3ï¼Œæ˜¾ç¤ºæ©™è‰²è­¦ç¤º
                                        if (params.data.photoCount < 3) {
                                            return '#ff9f43';
                                        }
                                        return '#00cfe8'; // æ­£å¸¸è“è‰²
                                    },
                                    borderWidth: 2
                                },
                                // å¼ºåˆ¶æ˜¾ç¤ºæ•°æ®ç‚¹ï¼Œä¸ç„¶å˜è‰²äº†ä¹Ÿçœ‹ä¸è§
                                showSymbol: true,
                                symbolSize: function(val, params) {
                                    // è­¦å‘Šç‚¹ç¨å¾®å¤§ä¸€ç‚¹ï¼Œæ›´æ˜¾çœ¼
                                    return params.data.photoCount < 3 ? 8 : 4;
                                }
                            }
                        ]
                    });

                    // Chart 3: åå·®
                    const chartDiff = echarts.init(document.getElementById('chart-diff-' + index));
                    chartDiff.setOption({
                        tooltip: { trigger: 'axis' },
                        grid: commonGrid,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        series: [{
                            name: 'åå·®å±‚æ•°', type: 'bar', data: b.deviations,
                            itemStyle: {
                                color: (params) => params.value >= 0 ? '#28c76f' : '#ea5455',
                                borderRadius: [3, 3, 0, 0]
                            }
                        }]
                    });

                    window.addEventListener('resize', () => {
                        chartTrend.resize(); chartHeight.resize(); chartDiff.resize();
                    });
                });
            },

            // === 1. ä¿®å¤ AI è¯·æ±‚ (åŠ å…¥ Token) ===
            doAiAnalysis() {
                this.aiLoading = true;
                const token = localStorage.getItem('token'); // è·å– Token

                axios.post('/api/ai/analyze',
                    { projectId: this.projectId },
                    { headers: { 'Authorization': token ? 'Bearer ' + token : '' } } // âœ… åŠ ä¸Š Header
                )
                .then(res => {
                    // å…¼å®¹ code å’Œ status
                    if ((res.data.code || res.data.status) === 200) {
                        this.aiResult = res.data.data;
                    } else {
                        this.$message.error(res.data.message || "åˆ†æå¤±è´¥");
                    }
                })
                .catch(err => this.$message.error("è¯·æ±‚AIæœåŠ¡å¤±è´¥: " + err))
                .finally(() => this.aiLoading = false);
            },

            sendAiMail() {
                this.sendingMail = true;
                const token = localStorage.getItem('token'); // è·å– Token

                axios.post('/api/ai/send-report',
                    { projectId: this.projectId, content: this.aiResult },
                    { headers: { 'Authorization': token ? 'Bearer ' + token : '' } } // âœ… åŠ ä¸Š Header
                )
                .then(res => {
                    if ((res.data.code || res.data.status) === 200) {
                        this.$message.success("é‚®ä»¶å·²å‘é€ï¼");
                        this.fetchMonitorData();
                    } else {
                        this.$message.error(res.data.message);
                    }
                })
                .finally(() => this.sendingMail = false);
            },
            // === 2. æ‚¬æµ®çƒæ‹–æ‹½é€»è¾‘ ===
            startDrag(e) {
                this.isDragging = true;
                this.hasDragged = false;
                this.dragStartX = e.clientX - this.ballLeft;
                this.dragStartY = e.clientY - this.ballTop;

                // ç»‘å®šå…¨å±€äº‹ä»¶ï¼Œé˜²æ­¢æ‹–å‡º div ä¸¢å¤±ç„¦ç‚¹
                document.addEventListener('mousemove', this.onDrag);
                document.addEventListener('mouseup', this.stopDrag);
            },
            onDrag(e) {
                if (!this.isDragging) return;
                this.hasDragged = true;
                this.ballLeft = e.clientX - this.dragStartX;
                this.ballTop = e.clientY - this.dragStartY;
            },
            stopDrag() {
                this.isDragging = false;
                document.removeEventListener('mousemove', this.onDrag);
                document.removeEventListener('mouseup', this.stopDrag);
            },
            handleBallClick() {
                // å¦‚æœåªæ˜¯ç‚¹å‡»ï¼ˆæ²¡æœ‰å‘ç”Ÿæ‹–æ‹½ï¼‰ï¼Œæ‰æ‰“å¼€å¼¹çª—
                if (!this.hasDragged) {
                    this.showAiDialog = true;
                }
            }
        }
    })
</script>
</body>
</html>