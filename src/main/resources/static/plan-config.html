<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ–½å·¥è®¡åˆ’é…ç½® - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* =========================================================
           1. å…¨å±€æ ·å¼å˜é‡
           ========================================================= */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --border-color: rgba(255,255,255,0.08);
            --header-height: 70px;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* =========================================================
           2. ä¾§è¾¹æ æ ·å¼
           ========================================================= */
        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }

        /* é¡¹ç›®æ ‡é¢˜åŒºåŸŸ (å·²åŒ…å« CSS ä¿®å¤ï¼šå…è®¸æ¢è¡Œ) */
        .project-title-area {
            min-height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-blue);
            padding: 10px 15px;
            font-size: 16px;
            letter-spacing: 0.5px;
            cursor: default;
            white-space: normal; /* å…è®¸æ¢è¡Œ */
            line-height: 1.3;
            text-align: center;
            background: rgba(0,0,0,0.1);
        }
        .project-title-area i { margin-right: 8px; font-size: 20px; flex-shrink: 0; }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .logo-area i { color: var(--accent-purple); margin-right: 10px; font-size: 24px; }

        .nav-menu { flex: 1; padding: 20px 15px; overflow-y: auto; }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(115, 103, 240, 0.15), transparent);
            color: var(--accent-purple);
            border-left-color: var(--accent-purple);
        }

        .nav-item i { margin-right: 15px; font-size: 18px; width: 20px; text-align: center; }

        .back-home {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            transition: color 0.2s;
            background: rgba(0,0,0,0.1);
        }
        .back-home:hover { color: #fff; background: rgba(255,255,255,0.05); }

        /* =========================================================
           3. ä¸»å†…å®¹åŒºæ ·å¼
           ========================================================= */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: radial-gradient(circle at 10% 10%, rgba(40,40,55,0.5) 0%, transparent 20%);
        }

        .header-bar {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            background: rgba(30, 30, 45, 0.95);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-scroll {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .card-box {
            background: var(--card-bg);
            padding: 25px 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tips-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
            background: rgba(40, 199, 111, 0.1);
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-green);
        }

        /* =========================================================
           4. Element UI è¦†ç›–æ ·å¼
           ========================================================= */
        .el-form-item__label { color: var(--text-secondary); }
        .el-input__inner, .el-range-input {
            background-color: #151521;
            border-color: var(--border-color);
            color: #fff;
        }
        .el-input__inner:focus, .el-range-input:focus { border-color: var(--accent-green); }
        .el-date-editor .el-range-separator { color: #fff; }

        .el-select-dropdown {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .el-select-dropdown__item { color: var(--text-secondary); }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover { background-color: rgba(255,255,255,0.05); }

        .el-table, .el-table__expanded-cell { background-color: transparent !important; color: var(--text-primary); }
        .el-table th, .el-table tr { background-color: transparent !important; }
        .el-table td, .el-table th.is-leaf { border-bottom: 1px solid var(--border-color); }
        .el-table--enable-row-hover .el-table__body tr:hover > td { background-color: rgba(40, 199, 111, 0.1) !important; }
        .el-table::before { background-color: transparent; }

        .el-picker-panel {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .el-date-table th { color: var(--text-primary); }
        .el-date-table td.in-range div { background-color: rgba(40, 199, 111, 0.2); }
        .el-date-table td.in-range div:hover { background-color: rgba(40, 199, 111, 0.4); }
        .el-picker-panel__icon-btn { color: var(--text-secondary); }
        .el-date-picker__header-label { color: #fff; }

        .el-button--default { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }
        .el-button--default:hover { color: #fff; border-color: #fff; }
        .el-button--primary { background: linear-gradient(45deg, var(--accent-green), #48da89); border: none; font-weight: bold; }
        .el-button--primary:hover { box-shadow: 0 4px 12px rgba(40, 199, 111, 0.4); }
        .el-button--success { background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)); border: none; }

        .empty-tips {
            text-align: center;
            padding: 60px 0;
            color: var(--text-secondary);
        }
        .empty-tips i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <template v-if="isProjectMode">
            <div class="project-title-area" :title="projectName">
                <i class="el-icon-office-building"></i> {{ projectName || 'åŠ è½½ä¸­...' }}
            </div>
            <div class="nav-menu">
                <div class="nav-item" @click="goToPage('dashboard.html')">
                    <i class="el-icon-data-board"></i> æ•°æ®çœ‹æ¿
                </div>
                <div class="nav-item" @click="goToPage('boundary.html')">
                    <i class="el-icon-map-location"></i> ç”µå­å›´æ 
                </div>
                <div class="nav-item" @click="goToPage('floor-config.html')">
                    <i class="el-icon-office-building"></i> æ¥¼å±‚é…ç½®
                </div>
                <div class="nav-item active">
                    <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
                </div>
            </div>
            <div class="back-home" @click="goToPage('index.html')">
                <i class="el-icon-back"></i> è¿”å›ç³»ç»Ÿé¦–é¡µ
            </div>
        </template>

        <template v-else>
            <div class="logo-area" @click="goHome">
                <i class="el-icon-monitor"></i> XiMA æ™ºé€ 
            </div>
            <div class="nav-menu">
                <div class="nav-item" @click="goHome">
                    <i class="el-icon-menu"></i> é¡¹ç›®æ¦‚è§ˆ
                </div>
                <div class="nav-item active">
                    <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
                </div>
                <div class="nav-item" @click="goToPage('import.html')">
                    <i class="el-icon-upload"></i> é¡¹ç›®å¯¼å…¥
                </div>
                <div class="nav-item">
                    <i class="el-icon-setting"></i> ç³»ç»Ÿè®¾ç½®
                </div>
            </div>
        </template>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <div class="page-title">
                <i class="el-icon-date"></i> æ–½å·¥è®¡åˆ’é…ç½®
            </div>
            <div style="display: flex; gap: 10px;">
                <el-button
                    size="small"
                    icon="el-icon-back"
                    @click="goBack"
                    v-if="isProjectMode">
                    è¿”å›çœ‹æ¿
                </el-button>
                <el-button
                    size="small"
                    icon="el-icon-s-home"
                    @click="goHome">
                    è¿”å›é¦–é¡µ
                </el-button>
            </div>
        </div>

        <div class="content-scroll">
            <div class="card-box">
                <div class="section-title">
                    <span><i class="el-icon-search"></i> é€‰æ‹©é…ç½®å¯¹è±¡</span>
                </div>
                <el-form :inline="true" size="small">
                    <el-form-item label="å½“å‰é¡¹ç›® ID">
                        <el-input v-model="projectId" disabled style="width: 80px; text-align: center;"></el-input>
                    </el-form-item>
                    <el-form-item label="é€‰æ‹©ç›®æ ‡æ¥¼æ ‹">
                        <el-select v-model="currentBuildingId" placeholder="è¯·é€‰æ‹©æ¥¼æ ‹" @change="onBuildingChange" style="width: 240px;">
                            <el-option v-for="b in buildingList" :key="b.id" :label="b.name" :value="b.id">
                                <span style="float: left">{{ b.name }}</span>
                                <span style="float: right; color: #8492a6; font-size: 12px; margin-left:10px" v-if="b.planBuildingName">ğŸ”— {{ b.planBuildingName }}</span>
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-form>
            </div>

            <div class="card-box" v-if="currentBuildingId">
                <div class="section-title">
                    <span><i class="el-icon-magic-stick"></i> æ‰¹é‡ç”Ÿæˆç­–ç•¥</span>
                </div>

                <div class="tips-text">
                    <i class="el-icon-info"></i> ç³»ç»Ÿå°†æ ¹æ®æ‚¨è¾“å…¥çš„ã€Œæ€»å±‚æ•°ã€å’Œã€Œæ€»å·¥æœŸã€ï¼Œè‡ªåŠ¨é‡‡ç”¨çº¿æ€§æ’å€¼ç®—æ³•åˆ†é…æ¯ä¸€å±‚çš„è®¡åˆ’å¼€å§‹ä¸ç»“æŸæ—¶é—´ã€‚ç”Ÿæˆé¢„è§ˆåï¼Œæ‚¨ä»å¯åœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­é’ˆå¯¹ç‰¹å®šå±‚ï¼ˆå¦‚èŠ‚å‡æ—¥ã€åœå·¥æœŸï¼‰è¿›è¡Œå¾®è°ƒã€‚
                </div>

                <el-form :inline="true" size="small" label-width="100px">
                    <el-form-item label="åœ°ä¸Šæ€»å±‚æ•°">
                        <el-input-number v-model="totalFloors" :min="1" :max="150" controls-position="right"></el-input-number>
                    </el-form-item>

                    <el-form-item label="è®¡åˆ’æ€»å·¥æœŸ">
                        <el-date-picker
                            v-model="dateRange"
                            type="daterange"
                            unlink-panels
                            range-separator="è‡³"
                            start-placeholder="å¼€å·¥æ—¥æœŸ"
                            end-placeholder="å®Œå·¥æ—¥æœŸ"
                            value-format="yyyy-MM-dd"
                            style="width: 320px;">
                        </el-date-picker>
                    </el-form-item>

                    <el-form-item>
                        <el-button type="primary" icon="el-icon-cpu" @click="generatePlanPreview">ä¸€é”®ç”Ÿæˆé¢„è§ˆ</el-button>
                    </el-form-item>
                </el-form>

                <div v-if="planList.length > 0" style="margin-top: 30px;">
                    <div style="border-top: 1px solid var(--border-color); margin-bottom: 20px;"></div>

                    <div style="margin-bottom: 15px; font-weight: bold; color: var(--text-primary); display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ“Š è¿›åº¦è®¡åˆ’é¢„è§ˆ (å…± {{ planList.length }} å±‚)</span>
                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">* ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¾®è°ƒæ—¥æœŸ</span>
                    </div>

                    <el-table :data="planList" border size="mini" height="500" style="width: 100%;">
                        <el-table-column prop="floor" label="æ¥¼å±‚ (F)" width="100" align="center">
                            <template slot-scope="scope">
                                <span style="font-weight: bold;">{{ scope.row.floor }}F</span>
                            </template>
                        </el-table-column>

                        <el-table-column label="è®¡åˆ’å¼€å§‹æ—¶é—´" align="center">
                            <template slot-scope="scope">
                                <el-date-picker v-model="scope.row.startDate" type="date" value-format="yyyy-MM-dd" size="mini" style="width: 100%;"></el-date-picker>
                            </template>
                        </el-table-column>

                        <el-table-column label="è®¡åˆ’å®Œæˆæ—¶é—´" align="center">
                            <template slot-scope="scope">
                                <el-date-picker v-model="scope.row.endDate" type="date" value-format="yyyy-MM-dd" size="mini" style="width: 100%;"></el-date-picker>
                            </template>
                        </el-table-column>

                        <el-table-column label="å·¥æœŸ(å¤©)" width="100" align="center">
                            <template slot-scope="scope">
                                <span style="color: var(--accent-green); font-weight: bold;">
                                    {{ calculateDays(scope.row.startDate, scope.row.endDate) }}
                                </span>
                            </template>
                        </el-table-column>

                        <el-table-column label="å¾®è°ƒæ“ä½œ" width="120" align="center">
                            <template slot-scope="scope">
                                <el-tooltip content="æ•´ä½“æå‰1å¤©" placement="top">
                                    <i class="el-icon-top" style="cursor: pointer; margin-right: 10px; color: var(--accent-blue);" @click="shiftDate(scope.$index, -1)"></i>
                                </el-tooltip>
                                <el-tooltip content="æ•´ä½“æ¨å1å¤©" placement="top">
                                    <i class="el-icon-bottom" style="cursor: pointer; color: var(--accent-red);" @click="shiftDate(scope.$index, 1)"></i>
                                </el-tooltip>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div style="margin-top: 30px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
                        <el-button type="success" size="medium" icon="el-icon-check" style="width: 240px; font-weight: bold;" @click="savePlan">
                            ç¡®è®¤å¹¶ä¿å­˜ç”Ÿæ•ˆ
                        </el-button>
                    </div>
                </div>
            </div>

            <div class="card-box" v-else>
                <div class="empty-tips">
                    <i class="el-icon-office-building"></i>
                    <p>è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªæ¥¼æ ‹å¼€å§‹é…ç½®è¿›åº¦</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            projectId: 1,
            token: localStorage.getItem('token'),

            // é¡µé¢çŠ¶æ€
            isProjectMode: false,
            projectName: '',

            // æ•°æ®æ¨¡å‹
            buildingList: [],
            currentBuildingId: null,
            totalFloors: 30,
            dateRange: [], // [start, end]
            planList: []
        },
        mounted() {
            // 1. è·å– ID å’Œ Token (ä¿®å¤ï¼šä¼˜å…ˆä» localStorage è·å– currentProjectId)
            const pid = localStorage.getItem('currentProjectId');
            const fromDash = localStorage.getItem('fromDashboard');
            if(pid) this.projectId = pid;
            if(this.token && !this.token.startsWith('Bearer ')) this.token = 'Bearer ' + this.token;

            // 2. åˆ¤æ–­æ¨¡å¼
            if (fromDash === 'true') {
                this.isProjectMode = true;
                this.fetchProjectInfo();
            }

            // 3. åŠ è½½æ¥¼æ ‹
            this.loadBuildings();
        },
        methods: {
            // [æ ¸å¿ƒä¿®å¤] è·å–é¡¹ç›®ä¿¡æ¯ï¼šä½¿ç”¨ç¨³å¥é€»è¾‘ï¼ˆå…¼å®¹ code/statusï¼Œå¢åŠ é”™è¯¯å¤„ç†ï¼‰
            fetchProjectInfo() {
                if(!this.projectId) return;

                axios.get(`/api/projects/${this.projectId}`, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    // å…¼å®¹ code æˆ– status å­—æ®µ
                    if((res.data.code || res.data.status) === 200) {
                        this.projectName = res.data.data.projectName;
                    }
                }).catch(e => {
                    console.error("è·å–é¡¹ç›®åå¤±è´¥", e);
                    this.projectName = "æœªçŸ¥é¡¹ç›®";
                });
            },

            // é¡µé¢è·³è½¬
            goToPage(url) {
                if(url === 'index.html') localStorage.removeItem('fromDashboard');
                window.location.href = url;
            },
            goHome() {
                localStorage.removeItem('fromDashboard');
                window.location.href = 'index.html';
            },
            goBack() {
                if(this.isProjectMode) window.location.href = 'dashboard.html';
                else window.location.href = 'index.html';
            },

            // åŠ è½½æ¥¼æ ‹ API
            loadBuildings() {
                axios.get(`/api/buildings/list?projectId=${this.projectId}`, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    if(res.data.code === 200 || res.data.status === 200) {
                        this.buildingList = res.data.data;
                    }
                });
            },

            onBuildingChange() {
                this.planList = []; // åˆ‡æ¢æ¥¼æ ‹æ—¶æ¸…ç©ºåˆ—è¡¨
            },

            // æ ¸å¿ƒç®—æ³•ï¼šç”Ÿæˆé¢„è§ˆ
            generatePlanPreview() {
                if(!this.dateRange || this.dateRange.length < 2) {
                    this.$message.warning("è¯·å…ˆé€‰æ‹©è®¡åˆ’å·¥æœŸèŒƒå›´");
                    return;
                }

                const start = moment(this.dateRange[0]);
                const end = moment(this.dateRange[1]);
                const daysTotal = end.diff(start, 'days') + 1; // æ€»å¤©æ•°

                if(daysTotal <= 0) return;

                const daysPerFloor = daysTotal / this.totalFloors;
                this.planList = [];

                for(let i=1; i<=this.totalFloors; i++) {
                    // çº¿æ€§æ’å€¼ç®—æ³•
                    const offsetStart = Math.floor((i - 1) * daysPerFloor);
                    const offsetEnd = Math.floor(i * daysPerFloor) - 1;

                    let fStart = start.clone().add(offsetStart, 'days');
                    let fEnd = start.clone().add(offsetEnd, 'days');

                    // ä¿®æ­£ï¼šç¡®ä¿ç»“æŸä¸æ—©äºå¼€å§‹
                    if(fEnd.isBefore(fStart)) fEnd = fStart.clone();

                    this.planList.push({
                        floor: i,
                        startDate: fStart.format('YYYY-MM-DD'),
                        endDate: fEnd.format('YYYY-MM-DD')
                    });
                }
                this.$message.success("é¢„è§ˆå·²ç”Ÿæˆï¼Œè¯·æ ¸å¯¹");
            },

            calculateDays(s, e) {
                if(!s || !e) return 0;
                return moment(e).diff(moment(s), 'days') + 1;
            },

            // å¾®è°ƒé€»è¾‘
            shiftDate(index, days) {
                const row = this.planList[index];
                row.startDate = moment(row.startDate).add(days, 'days').format('YYYY-MM-DD');
                row.endDate = moment(row.endDate).add(days, 'days').format('YYYY-MM-DD');
            },

            // ä¿å­˜
            savePlan() {
                const payload = {
                    projectId: this.projectId,
                    buildingId: this.currentBuildingId,
                    items: this.planList
                };

                axios.post('/api/progress/plan/save', payload, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    if(res.data.code === 200 || res.data.status === 200) {
                        this.$message.success("è®¡åˆ’è¿›åº¦ä¿å­˜æˆåŠŸï¼");
                    } else {
                        this.$message.error("ä¿å­˜å¤±è´¥ï¼š" + res.data.message);
                    }
                }).catch(() => {
                    this.$message.error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                });
            }
        }
    })
</script>
</body>
</html>