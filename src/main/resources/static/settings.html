<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿè®¾ç½® - XiMA æ™ºèƒ½å»ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
<style>
    /* --- 1. å…¨å±€æ·±è‰²ä¸»é¢˜å®šä¹‰ (å¤ç”¨ Index) --- */
    :root {
        --bg-color: #1e1e2d;
        --sidebar-bg: #151521;
        --card-bg: #2b2b40;
        --text-primary: #e1e1e6;
        --text-secondary: #a2a2b8;
        --accent-purple: #7367f0;
        --accent-blue: #00cfe8;
        --accent-green: #28c76f;
        --accent-red: #ea5455;
        --border-color: rgba(255,255,255,0.08);
        --hover-bg: rgba(255, 255, 255, 0.05);
    }

    body, html {
        margin: 0; padding: 0; height: 100%;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
    }

    #app { display: flex; height: 100vh; width: 100vw; }

    /* --- 2. ä¾§è¾¹æ æ ·å¼ --- */
    .sidebar {
        width: 260px;
        background-color: var(--sidebar-bg);
        display: flex; flex-direction: column;
        border-right: 1px solid var(--border-color);
        flex-shrink: 0; z-index: 1000;
    }
    .logo-area {
        height: 80px; display: flex; align-items: center; justify-content: center;
        font-size: 22px; font-weight: 700; color: white;
        border-bottom: 1px solid var(--border-color);
        letter-spacing: 1px; text-shadow: 0 0 10px rgba(115, 103, 240, 0.3);
    }
    .logo-area i { color: var(--accent-purple); margin-right: 12px; font-size: 26px; }
    .nav-menu { flex: 1; padding: 25px 15px; overflow-y: auto; }
    .nav-item {
        display: flex; align-items: center; padding: 14px 20px;
        margin-bottom: 8px; border-radius: 8px; color: var(--text-secondary);
        cursor: pointer; transition: all 0.3s ease; font-size: 15px; font-weight: 500;
    }
    .nav-item:hover { background-color: var(--hover-bg); color: #fff; transform: translateX(5px); }
    .nav-item.active {
        background: linear-gradient(90deg, rgba(115, 103, 240, 0.25), transparent);
        color: var(--accent-purple); border-left: 4px solid var(--accent-purple);
    }
    .nav-item i { margin-right: 15px; font-size: 20px; width: 24px; text-align: center; }

    /* --- 3. ä¸»å†…å®¹åŒºåŸŸ --- */
    .main-content {
        flex: 1; display: flex; flex-direction: column;
        overflow: hidden; position: relative;
        background: radial-gradient(circle at top right, #252535 0%, var(--bg-color) 40%);
    }
    .top-header {
        height: 80px; display: flex; justify-content: space-between; align-items: center;
        padding: 0 40px; background-color: rgba(30, 30, 45, 0.8);
        backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);
        flex-shrink: 0; z-index: 100;
    }
    .page-title h2 { margin: 0; font-size: 26px; font-weight: 600; letter-spacing: 0.5px; }
    .user-profile { display: flex; align-items: center; gap: 20px; }
    .user-info { text-align: right; line-height: 1.4; }
    .user-name { font-weight: bold; font-size: 14px; color: #fff; }
    .user-role { font-size: 12px; color: var(--text-secondary); }
    .avatar {
        width: 42px; height: 42px;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: white; font-size: 18px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .logout-btn { cursor: pointer; color: var(--accent-red); font-size: 22px; transition: transform 0.2s; padding: 8px; }
    .logout-btn:hover { transform: scale(1.1); }
    .content-scroll { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }

    /* --- 4. è®¾ç½®é¡µä¸“å±æ ·å¼ --- */
    .setting-card {
        background: var(--card-bg); padding: 40px; border-radius: 16px;
        max-width: 900px; margin: 0 auto;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .section-title {
        font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 20px;
        border-left: 4px solid var(--accent-purple); padding-left: 12px;
    }
    .el-form-item__label { color: var(--text-secondary); }
    .el-input__inner { background: #151521; border-color: var(--border-color); color: #fff; }
    .el-input__inner:focus { border-color: var(--accent-purple); }
    .el-divider { background-color: var(--border-color); }
    .el-divider__text { background-color: var(--card-bg); color: var(--text-secondary); }

    /* è¡¨æ ¼æ ·å¼ */
    .el-table { background-color: transparent !important; }
    .el-table th, .el-table tr { background-color: transparent !important; }
    .el-table th { border-bottom: 1px solid var(--border-color) !important; color: var(--text-secondary); }
    .el-table td { border-bottom: 1px solid var(--border-color) !important; color: var(--text-primary); }
    .el-table--enable-row-hover .el-table__body tr:hover>td { background-color: rgba(255,255,255,0.05) !important; }

    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-color); }
    ::-webkit-scrollbar-thumb { background: #3b3b58; border-radius: 4px; }

    /* --- âœ… 5. çº¯æ–‡æœ¬å¤§å¼¹çª—æ ·å¼ (æ ¸å¿ƒä¿®æ”¹) --- */

    /* å¼¹çª—æœ¬ä½“æ ·å¼ä¿®æ­£ */
    .ai-pure-text-dialog {
        /* é«˜åº¦å¼ºåˆ¶æ‹‰å¤§ */
        height: 80vh !important;
        margin-top: 5vh !important;
        display: flex;
        flex-direction: column;
        background-color: #2b2b40 !important;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .ai-pure-text-dialog .el-dialog__body {
        flex: 1;
        overflow: hidden;
        padding: 0 !important; /* å»æ‰å†…è¾¹è·ï¼Œäº¤ç»™å†…éƒ¨å®¹å™¨ */
        display: flex;
        flex-direction: column;
    }

    /* æ–‡æœ¬å†…å®¹æ¡† */
    .text-content-box {
        flex: 1;
        background-color: #1e1e2d;
        color: #e1e1e6;
        padding: 40px;            /* å®½æ•çš„å†…è¾¹è· */
        margin: 20px;             /* ç»™ä¸€ç‚¹å¤–è¾¹è· */
        border-radius: 8px;
        font-size: 16px;          /* å­—ä½“å¤§ */
        line-height: 1.8;         /* è¡Œé«˜å¤§ */
        white-space: pre-wrap;    /* ğŸ”¥ æ ¸å¿ƒï¼šä¿ç•™æ¢è¡Œç¬¦ */
        overflow-y: auto;         /* å‚ç›´æ»šåŠ¨ */
        font-family: 'Microsoft YaHei', sans-serif;
        border: 1px solid #3b3b4d;
    }
</style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div class="logo-area"><i class="el-icon-monitor"></i> XiMA æ™ºé€ </div>
        <div class="nav-menu">
            <div class="nav-item" @click="goToPage('index.html')">
                <i class="el-icon-menu"></i> é¡¹ç›®æ¦‚è§ˆ
            </div>
            <div class="nav-item" @click="goToPage('plan-config.html')">
                <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
            </div>
            <div class="nav-item" @click="goToPage('import.html')">
                <i class="el-icon-upload"></i> é¡¹ç›®å¯¼å…¥
            </div>
            <div class="nav-item active"> <i class="el-icon-setting"></i> ç³»ç»Ÿè®¾ç½®
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div class="page-title"><h2>ç³»ç»Ÿé…ç½®ä¸­å¿ƒ</h2></div>
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-name">{{ username }}</div>
                    <div class="user-role">ç®¡ç†å‘˜</div>
                </div>
                <div class="avatar">{{ username.substring(0,1).toUpperCase() }}</div>
                <i class="el-icon-switch-button logout-btn" @click="logout" title="é€€å‡ºç™»å½•"></i>
            </div>
        </div>

        <div class="content-scroll">
            <div class="setting-card">
                <div class="section-title">é€šçŸ¥è®¢é˜…è®¾ç½®</div>
                <el-form label-width="120px" :model="form">
                    <el-form-item label="æ¥æ”¶é‚®ç®±">
                        <el-input v-model="form.email" style="width: 280px;" @input="checkEmailChange" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±"></el-input>
                        <el-button
                            v-if="form.email !== originalEmail"
                            type="warning" plain size="small"
                            @click="sendCode"
                            :disabled="coding || time > 0"
                            style="margin-left: 10px;">
                            {{ time > 0 ? time + 's' : 'å‘é€éªŒè¯ç ' }}
                        </el-button>
                    </el-form-item>

                    <el-form-item label="éªŒè¯ç " v-if="form.email !== originalEmail">
                        <el-input v-model="form.code" style="width: 150px;" placeholder="6ä½éªŒè¯ç "></el-input>
                        <span style="color: #ea5455; font-size: 12px; margin-left: 10px;">
                            <i class="el-icon-warning"></i> æ£€æµ‹åˆ°é‚®ç®±å˜æ›´ï¼Œéœ€éªŒè¯åä¿å­˜
                        </span>
                    </el-form-item>

                    <el-form-item label="æ¯æ—¥æŠ¥å‘Šæ—¶é—´">
                        <el-time-select v-model="form.reportTime" :picker-options="{ start: '06:00', step: '01:00', end: '23:00' }" placeholder="é€‰æ‹©æ¨é€æ—¶é—´">
                        </el-time-select>
                        <el-button type="text" @click="form.reportTime = ''" style="color: var(--text-secondary); margin-left: 10px;">æ¸…ç©º (æš‚ä¸å‘é€)</el-button>
                    </el-form-item>

                    <el-divider content-position="left">é¡¹ç›® AI æ—¥æŠ¥ç®¡ç†</el-divider>

                    <el-table :data="form.projectSettings" style="width: 100%;">
                        <el-table-column prop="projectName" label="é¡¹ç›®åç§°"></el-table-column>
                        <el-table-column label="AI æ™ºèƒ½æ—¥æŠ¥" width="150">
                            <template slot-scope="scope">
                                <el-switch
                                    v-model="scope.row.enableAiReport"
                                    active-color="#7367f0"
                                    inactive-color="#3b3b4d">
                                </el-switch>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="150">
                            <template slot-scope="scope">
                                <el-button type="text" icon="el-icon-view" @click="previewReport(scope.row)">é¢„è§ˆæ—¥æŠ¥</el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div style="margin-top: 40px; text-align: center;">
                        <el-button type="primary" @click="save" :loading="saving" icon="el-icon-check">ä¿å­˜æ‰€æœ‰è®¾ç½®</el-button>
                    </div>
                </el-form>
            </div>
        </div>
    </div>

    <el-dialog
        :title="'ã€' + previewProjectName + 'ã€‘AI æ™ºèƒ½æ·±åº¦åˆ†ææŠ¥å‘Š'"
        :visible.sync="previewVisible"
        width="1500px"
        top="5vh"
        append-to-body
        custom-class="ai-pure-text-dialog">

        <div v-if="previewLoading" style="text-align: center; padding: 120px 0;">
            <i class="el-icon-loading" style="font-size: 50px; color: #7367f0;"></i>
            <p style="margin-top: 20px; font-size: 18px; color: #fff;">
                æ­£åœ¨åˆ†æ {{ form.reportTime || 'å®æ—¶' }} å·¥ç¨‹æ•°æ®...
            </p>
        </div>

        <div v-else class="text-content-box" style="height: 65vh; overflow-y: auto; background-color: #1e1e2d; padding: 40px; border-radius: 8px; border: 1px solid #3b3b4d;">
            <div style="white-space: pre-wrap; color: #e1e1e6; font-size: 16px; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">{{ previewContent }}</div>
        </div>

        <span slot="footer">
            <el-button @click="previewVisible = false" size="medium">å…³ é—­</el-button>
            <el-button type="primary" @click="previewVisible = false" size="medium" icon="el-icon-document-copy">å¤åˆ¶æŠ¥å‘Š</el-button>
        </span>
    </el-dialog>

</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            username: '',
            form: { email: '', code: '', reportTime: '', projectSettings: [] },
            originalEmail: '',
            time: 0,
            coding: false,
            saving: false,
            // é¢„è§ˆç›¸å…³
            previewVisible: false,
            previewLoading: false,
            previewContent: '',
            previewProjectName: ''
        },
        created() {
            this.checkLogin();
            this.loadData();
        },
        methods: {
            checkLogin() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('username');
                if (!token) { window.location.href = 'login.html'; return; }
                this.username = user || 'Admin';
            },
            goToPage(url) {
                if(url === 'plan-config.html') localStorage.removeItem('fromDashboard');
                window.location.href = url;
            },
            logout() {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            },
            loadData() {
                const token = localStorage.getItem('token');
                axios.get('/api/settings/info', { headers: { 'Authorization': 'Bearer ' + token } })
                    .then(res => {
                        const d = res.data.data;
                        this.form.email = d.email;
                        this.originalEmail = d.email;
                        this.form.reportTime = d.reportTime;
                        this.form.projectSettings = d.projects.map(p => ({
                            id: p.id,
                            projectName: p.projectName,
                            enableAiReport: p.enableAiReport === 1
                        }));
                    });
            },
            // âœ… æ–°å¢ï¼šè°ƒç”¨åç«¯çœŸå®æ•°æ®æ¥å£
            previewReport(project) {
                this.previewProjectName = project.projectName;
                this.previewVisible = true;
                this.previewLoading = true;
                this.previewContent = '';

                const token = localStorage.getItem('token');

                axios.post('/api/settings/preview-report', { projectId: project.id }, {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => {
                    if(res.data.status === 200) {
                        this.previewContent = res.data.data;
                    } else {
                        this.previewContent = '<p style="color:red">ç”Ÿæˆå¤±è´¥: ' + res.data.message + '</p>';
                    }
                }).catch(err => {
                    this.previewContent = '<p style="color:red">ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡ä¸å¯ç”¨</p>';
                }).finally(() => {
                    this.previewLoading = false;
                });
            },
            sendCode() {
                this.coding = true;
                axios.post('/api/settings/send-verify', { email: this.form.email })
                    .then(res => {
                        if(res.data.status === 200) {
                            this.$message.success('éªŒè¯ç å·²å‘é€è‡³æ–°é‚®ç®±');
                            this.time = 60;
                            const timer = setInterval(() => { this.time--; if(this.time<=0) clearInterval(timer); }, 1000);
                        } else this.$message.error(res.data.message);
                    }).finally(() => this.coding = false);
            },
            save() {
                this.saving = true;
                const token = localStorage.getItem('token');
                axios.post('/api/settings/save', this.form, { headers: { 'Authorization': 'Bearer ' + token } })
                    .then(res => {
                        if(res.data.status === 200) {
                            this.$message.success('é…ç½®å·²æ›´æ–°');
                            this.originalEmail = this.form.email;
                            this.form.code = '';
                        } else this.$message.error(res.data.message);
                    }).finally(() => this.saving = false);
            },
            checkEmailChange() {}
        }
    })
</script>
</body>
</html>