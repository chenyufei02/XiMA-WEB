<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¥¼å±‚å‚æ•°é…ç½® - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* =========================================================
           1. å…¨å±€æ ·å¼å˜é‡
           ========================================================= */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --border-color: rgba(255,255,255,0.08);
            --header-height: 70px;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* =========================================================
           2. ä¾§è¾¹æ æ ·å¼
           ========================================================= */
        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }

        .project-title-area {
            min-height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-blue);
            padding: 10px 15px;
            font-size: 16px;
            letter-spacing: 0.5px;
            cursor: default;
            white-space: normal;
            line-height: 1.3;
            text-align: center;
            background: rgba(0,0,0,0.1);
        }
        .project-title-area i { margin-right: 8px; font-size: 20px; flex-shrink: 0; }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .logo-area i { color: var(--accent-purple); margin-right: 10px; font-size: 24px; }

        .nav-menu { flex: 1; padding: 20px 15px; overflow-y: auto; }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(115, 103, 240, 0.15), transparent);
            color: var(--accent-purple);
            border-left-color: var(--accent-purple);
        }

        .nav-item i { margin-right: 15px; font-size: 18px; width: 20px; text-align: center; }

        .back-home {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            transition: color 0.2s;
            background: rgba(0,0,0,0.1);
        }
        .back-home:hover { color: #fff; background: rgba(255,255,255,0.05); }

        /* =========================================================
           3. ä¸»å†…å®¹åŒºæ ·å¼
           ========================================================= */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: radial-gradient(circle at 10% 10%, rgba(40,40,55,0.5) 0%, transparent 20%);
        }

        .header-bar {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            background: rgba(30, 30, 45, 0.95);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-scroll {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .card-box {
            background: var(--card-bg);
            padding: 25px 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-area {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px dashed rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .mode-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        /* =========================================================
           4. Element UI è¦†ç›–æ ·å¼
           ========================================================= */
        .el-form-item__label { color: var(--text-secondary); }
        .el-input__inner, .el-input-number__decrease, .el-input-number__increase {
            background-color: #151521;
            border-color: var(--border-color);
            color: #fff;
        }
        .el-input__inner:focus { border-color: var(--accent-purple); }

        .el-select-dropdown {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .el-select-dropdown__item { color: var(--text-secondary); }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover { background-color: rgba(255,255,255,0.05); }

        .el-table, .el-table__expanded-cell { background-color: transparent !important; color: var(--text-primary); }
        .el-table th, .el-table tr { background-color: transparent !important; }
        .el-table td, .el-table th.is-leaf { border-bottom: 1px solid var(--border-color); }
        .el-table--enable-row-hover .el-table__body tr:hover > td { background-color: rgba(115, 103, 240, 0.1) !important; }
        .el-table::before { background-color: transparent; }

        .el-button--default { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }
        .el-button--default:hover { color: #fff; border-color: #fff; }
        .el-button--primary { background: linear-gradient(45deg, var(--accent-purple), #9f96f6); border: none; }
        .el-button--primary:hover { box-shadow: 0 4px 12px rgba(115, 103, 240, 0.4); }

        .el-radio { color: var(--text-primary); margin-right: 30px; }
        .el-radio__input.is-checked + .el-radio__label { color: var(--accent-blue); }
        .el-radio__inner { background: transparent; border-color: var(--text-secondary); }
        .el-radio__input.is-checked .el-radio__inner { border-color: var(--accent-blue); background: var(--accent-blue); }

        .empty-tips {
            text-align: center;
            padding: 60px 0;
            color: var(--text-secondary);
        }
        .empty-tips i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }

        /* --- ä¿®å¤ï¼šSwitch å¼€å…³æ–‡å­—é¢œè‰²é€‚é…æ·±è‰²æ¨¡å¼ --- */
        .el-switch__label {
            color: var(--text-secondary) !important; /* æœªé€‰ä¸­æ—¶çš„æ–‡å­—é¢œè‰² (æµ…ç°) */
        }
        .el-switch__label.is-active {
            color: var(--accent-blue) !important;    /* é€‰ä¸­æ—¶çš„æ–‡å­—é¢œè‰² (é«˜äº®è“) */
        }


    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <template v-if="isProjectMode">
            <div class="project-title-area" :title="projectName">
                <i class="el-icon-office-building"></i> {{ projectName || 'åŠ è½½ä¸­...' }}
            </div>
            <div class="nav-menu">
                <div class="nav-item" @click="goToPage('dashboard.html')">
                    <i class="el-icon-data-board"></i> æ•°æ®çœ‹æ¿
                </div>
                <div class="nav-item" @click="goToPage('boundary.html')">
                    <i class="el-icon-map-location"></i> ç”µå­å›´æ 
                </div>
                <div class="nav-item active">
                    <i class="el-icon-office-building"></i> æ¥¼å±‚é…ç½®
                </div>
                <div class="nav-item" @click="goToPage('plan-config.html')">
                    <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
                </div>
            </div>
            <div class="back-home" @click="goHome">
                <i class="el-icon-back"></i> è¿”å›ç³»ç»Ÿé¦–é¡µ
            </div>
        </template>

        <template v-else>
            <div class="logo-area" @click="goHome">
                <i class="el-icon-monitor"></i> XiMA æ™ºé€ 
            </div>
            <div class="nav-menu">
                <div class="nav-item" @click="goHome">
                    <i class="el-icon-menu"></i> é¡¹ç›®æ¦‚è§ˆ
                </div>
                <div class="nav-item" @click="goToPage('plan-config.html')">
                    <i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦
                </div>
                <div class="nav-item" @click="goToPage('import.html')">
                    <i class="el-icon-upload"></i> é¡¹ç›®å¯¼å…¥
                </div>
            </div>
        </template>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <div class="page-title">
                <i class="el-icon-s-operation"></i> æ¥¼å±‚å‚æ•°é…ç½®
            </div>
            <div style="display: flex; gap: 10px;">
                <el-button
                    size="small"
                    icon="el-icon-back"
                    @click="goBack"
                    v-if="isProjectMode">
                    è¿”å›çœ‹æ¿
                </el-button>
                <el-button
                    size="small"
                    icon="el-icon-s-home"
                    @click="goHome">
                    è¿”å›é¦–é¡µ
                </el-button>
            </div>
        </div>

        <div class="content-scroll">
            <div class="card-box">
                <div class="section-title">
                    <span><i class="el-icon-search"></i> é€‰æ‹©é…ç½®å¯¹è±¡</span>
                </div>
                <el-form :inline="true" size="small">
                    <el-form-item label="å½“å‰é¡¹ç›® ID">
                        <el-input v-model="projectId" disabled style="width: 80px; text-align: center;"></el-input>
                    </el-form-item>
                    <el-form-item label="é€‰æ‹©ç›®æ ‡æ¥¼æ ‹">
                        <el-select v-model="currentBuildingId" placeholder="è¯·é€‰æ‹©æ¥¼æ ‹" @change="loadFloorData" style="width: 240px;">
                            <el-option v-for="b in buildingList" :key="b.id" :label="b.name" :value="b.id">
                                <span style="float: left">{{ b.name }}</span>
                                <span style="float: right; color: #8492a6; font-size: 12px; margin-left:10px" v-if="b.planBuildingName">ğŸ”— {{ b.planBuildingName }}</span>
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-form>
            </div>

            <div class="card-box" v-if="currentBuildingId">
                <div class="section-title">
                    <span><i class="el-icon-cpu"></i> æ¥¼å±‚ç”Ÿæˆç­–ç•¥</span>
                </div>

                <div style="margin-bottom: 10px;" v-if="floorList.length > 0">
                     <el-switch
                        v-model="showGenerator"
                        active-text="é‡æ–°ç”Ÿæˆ"
                        inactive-text="æŸ¥çœ‹ç°æœ‰">
                    </el-switch>
                </div>

                <div class="config-area" v-if="showGenerator || floorList.length === 0">
                    <div style="margin-bottom: 20px;">
                        <el-radio-group v-model="configMode">
                            <el-radio label="A">æ¨¡å¼ A: ç»Ÿä¸€æ ‡å‡†å±‚é«˜ (é€‚ç”¨äºåŠå…¬æ¥¼æ ‡å‡†æ®µ)</el-radio>
                            <el-radio label="B">æ¨¡å¼ B: é¦–å±‚ç‰¹æ®Š + æ ‡å‡†å±‚ (æ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°ä½å®…)</el-radio>
                            <el-radio label="C">æ¨¡å¼ C: çº¯æ‰‹åŠ¨å½•å…¥</el-radio>
                        </el-radio-group>
                    </div>

                    <div v-if="configMode === 'A' || configMode === 'B'">
                        <el-form :inline="true" size="small">
                            <el-form-item label="æ€»å±‚æ•°">
                                <el-input-number v-model="params.totalFloors" :min="1" :max="150" controls-position="right"></el-input-number>
                            </el-form-item>

                            <el-form-item label="é¦–å±‚é«˜åº¦(m)" v-if="configMode === 'B'">
                                <el-input-number v-model="params.firstHeight" :precision="2" :step="0.1" :min="1" controls-position="right"></el-input-number>
                            </el-form-item>

                            <el-form-item label="æ ‡å‡†å±‚é«˜(m)">
                                <el-input-number v-model="params.stdHeight" :precision="2" :step="0.1" :min="1" controls-position="right"></el-input-number>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" icon="el-icon-magic-stick" @click="generatePreview">ç”Ÿæˆ/é‡ç½®è¡¨æ ¼</el-button>
                            </el-form-item>
                        </el-form>
                        <div class="mode-desc" v-if="configMode === 'B'">
                            <i class="el-icon-info"></i> ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ {{ params.totalFloors }} å±‚æ•°æ®ã€‚ç¬¬ 1 å±‚é«˜åº¦ä¸º {{ params.firstHeight }}mï¼Œå…¶ä½™å±‚é«˜åº¦ä¸º {{ params.stdHeight }}mã€‚
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;" v-if="floorList.length > 0">
                    <div style="margin-bottom: 15px; font-weight: bold; color: var(--text-primary); display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            ğŸ“Š æ¥¼å±‚æ•°æ®é…ç½® (å…± {{ floorList.length }} å±‚)
                            <span style="font-size:12px; font-weight:normal; color:#28c76f; margin-left:10px" v-if="isEditMode"><i class="el-icon-check"></i> å·²åŠ è½½ç°æœ‰é…ç½®</span>
                        </span>
                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">* ä¿®æ”¹ä»»æ„å±‚é«˜ä¼šè‡ªåŠ¨é‡ç®—ä¸Šæ–¹æ‰€æœ‰æ¥¼å±‚çš„ç´¯è®¡æ ‡é«˜</span>
                    </div>

                    <el-table :data="floorList" border size="mini" height="450" style="width: 100%;">
                        <el-table-column prop="floorNumber" label="æ¥¼å±‚ (F)" width="100" align="center">
                            <template slot-scope="scope">
                                <span style="font-weight: bold;">{{ scope.row.floorNumber }}F</span>
                            </template>
                        </el-table-column>

                        <el-table-column label="æœ¬å±‚å±‚é«˜ (ç±³)" width="200" align="center">
                            <template slot-scope="scope">
                                <el-input-number
                                    v-model="scope.row.floorHeight"
                                    :precision="2"
                                    :step="0.1"
                                    size="mini"
                                    controls-position="right"
                                    style="width: 140px;"
                                    @change="recalcCumulative(scope.$index)">
                                </el-input-number>
                            </template>
                        </el-table-column>

                        <el-table-column label="å±‚é¡¶ç´¯è®¡æ ‡é«˜ (ç±³)" align="center">
                            <template slot-scope="scope">
                                <span style="font-weight: bold; color: var(--accent-blue); font-size: 14px;">{{ scope.row.cumulativeHeight }} m</span>
                            </template>
                        </el-table-column>

                        <el-table-column label="æ“ä½œ" width="120" align="center">
                            <template slot-scope="scope">
                                <el-button type="text" icon="el-icon-delete" style="color: #ea5455" @click="removeFloor(scope.$index)">åˆ é™¤</el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div style="margin-top: 15px;">
                        <el-button size="small" type="primary" plain icon="el-icon-plus" style="width: 100%" @click="addFloor">æ·»åŠ ä¸€å±‚</el-button>
                    </div>

                    <div style="margin-top: 30px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
                        <el-button type="primary" icon="el-icon-check" style="width: 240px; font-weight: bold;" @click="saveToBackend" :disabled="floorList.length === 0">
                            ç¡®è®¤å¹¶ä¿å­˜é…ç½®
                        </el-button>
                    </div>
                </div>
            </div>

            <div class="card-box" v-else>
                <div class="empty-tips">
                    <i class="el-icon-office-building"></i>
                    <p>è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªæ¥¼æ ‹å¼€å§‹é…ç½®</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            projectId: 1,
            token: localStorage.getItem('token'),

            // é¡µé¢çŠ¶æ€
            isProjectMode: false,
            projectName: '',
            isEditMode: false, // æ˜¯å¦å¤„äºç¼–è¾‘å·²æœ‰æ•°æ®æ¨¡å¼
            showGenerator: true, // æ§åˆ¶ç”Ÿæˆå™¨æ˜¾ç¤º

            // æ¥¼æ ‹æ•°æ®
            buildingList: [],
            currentBuildingId: null,

            // é…ç½®å‚æ•°
            configMode: 'B',
            params: {
                totalFloors: 10,
                firstHeight: 4.5,
                stdHeight: 3.0
            },
            floorList: []
        },
        mounted() {
            // 1. è·å–åŸºç¡€å‚æ•°
            const pid = localStorage.getItem('currentProjectId');
            const fromDash = localStorage.getItem('fromDashboard');
            if(pid) this.projectId = pid;

            // 2. å¤„ç† Token
            if (this.token && !this.token.startsWith('Bearer ')) {
                this.token = 'Bearer ' + this.token;
            }

            // 3. åˆ¤æ–­æ˜¯å¦æ˜¯é¡¹ç›®æ¨¡å¼
            if (fromDash === 'true') {
                this.isProjectMode = true;
                this.fetchProjectInfo();
            }

            // 4. åŠ è½½æ¥¼æ ‹åˆ—è¡¨
            this.loadBuildings();
        },
        methods: {
            fetchProjectInfo() {
                if(!this.projectId) return;
                axios.get(`/api/projects/${this.projectId}`, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.projectName = res.data.data.projectName;
                    }
                }).catch(e => {
                    console.error("è·å–é¡¹ç›®åå¤±è´¥", e);
                    this.projectName = "æœªçŸ¥é¡¹ç›®";
                });
            },

            goToPage(url) {
                if(url === 'index.html') localStorage.removeItem('fromDashboard');
                window.location.href = url;
            },
            goHome() {
                localStorage.removeItem('fromDashboard');
                window.location.href = 'index.html';
            },
            goBack() {
                if(this.isProjectMode) window.location.href = 'dashboard.html';
                else window.location.href = 'index.html';
            },

            loadBuildings() {
                axios.get(`/api/buildings/list?projectId=${this.projectId}`, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.buildingList = res.data.data;
                    }
                });
            },

            // åŠ è½½æ¥¼å±‚æ•°æ®ï¼ˆæ”¯æŒå›æ˜¾ï¼‰
            loadFloorData() {
                this.floorList = [];
                this.isEditMode = false;
                this.showGenerator = true;

                if(!this.currentBuildingId) return;

                axios.get(`/api/floors/list?buildingId=${this.currentBuildingId}`, {
                    headers: { 'Authorization': this.token }
                }).then(res => {
                    const data = res.data.data;
                    if (data && data.length > 0) {
                        this.floorList = data;
                        this.isEditMode = true;

                        // è‡ªåŠ¨æ”¶èµ·ç”Ÿæˆå™¨
                        this.showGenerator = false;
                        this.params.totalFloors = data.length;

                        this.$message.success(`å·²åŠ è½½è¯¥æ¥¼æ ‹çš„ ${data.length} å±‚é…ç½®æ•°æ®`);
                    } else {
                        this.$message.info("è¯¥æ¥¼æ ‹æš‚æ— é…ç½®ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹å·¥å…·ç”Ÿæˆ");
                    }
                }).catch(e => {
                    this.$message.error("åŠ è½½æ¥¼å±‚æ•°æ®å¤±è´¥");
                });
            },

            generatePreview() {
                this.floorList = [];
                let currentH = 0;
                for (let i = 1; i <= this.params.totalFloors; i++) {
                    let h = this.params.stdHeight;
                    if (this.configMode === 'B' && i === 1) h = this.params.firstHeight;

                    currentH += h;
                    this.floorList.push({
                        floorNumber: i,
                        floorHeight: parseFloat(h.toFixed(2)),
                        cumulativeHeight: parseFloat(currentH.toFixed(2))
                    });
                }
                this.isEditMode = false;
                this.$message.success("é¢„è§ˆæ•°æ®å·²ç”Ÿæˆ");
            },

            recalcCumulative(startIndex) {
                let currentH = (startIndex > 0) ? this.floorList[startIndex - 1].cumulativeHeight : 0;
                for (let i = startIndex; i < this.floorList.length; i++) {
                    currentH += this.floorList[i].floorHeight;
                    this.floorList[i].cumulativeHeight = parseFloat(currentH.toFixed(2));
                }
            },

            addFloor() {
                const lastCumulative = this.floorList.length > 0
                    ? this.floorList[this.floorList.length-1].cumulativeHeight
                    : 0;
                const nextFloorNum = this.floorList.length + 1;

                this.floorList.push({
                    floorNumber: nextFloorNum,
                    floorHeight: 3.0,
                    cumulativeHeight: parseFloat((lastCumulative + 3.0).toFixed(2))
                });
                this.params.totalFloors = this.floorList.length;
            },

            removeFloor(index) {
                this.floorList.splice(index, 1);
                this.floorList.forEach((item, idx) => item.floorNumber = idx + 1);
                this.recalcCumulative(0);
                this.params.totalFloors = this.floorList.length;
            },

            saveToBackend() {
                if(this.floorList.length === 0) return;

                axios.post(`/api/floors/save?projectId=${this.projectId}&buildingId=${this.currentBuildingId}`,
                    this.floorList,
                    { headers: { 'Authorization': this.token } }
                ).then(res => {
                    if ((res.data.code || res.data.status) === 200) {
                        this.$message.success("é…ç½®ä¿å­˜æˆåŠŸï¼");
                        this.isEditMode = true;
                    } else {
                        this.$message.error(res.data.message || "ä¿å­˜å¤±è´¥");
                    }
                }).catch(() => {
                    this.$message.error("ä¿å­˜è¯·æ±‚å¤±è´¥");
                });
            }
        }
    })
</script>
</body>
</html>