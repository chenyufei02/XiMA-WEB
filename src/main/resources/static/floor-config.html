<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¥¼å±‚å‚æ•°é…ç½® - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* --- å…¨å±€æš—é»‘ä¸»é¢˜ --- */
        :root {
            --bg-color: #1e1e2d;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-blue: #00cfe8;
            --accent-purple: #7367f0;
            --border-color: rgba(255,255,255,0.08);
        }

        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }

        .card-box {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .config-area {
            margin-top: 20px;
            padding: 25px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px dashed rgba(255,255,255,0.1);
        }

        .mode-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 15px; }

        /* --- Element UI æš—é»‘è¦†ç›– --- */
        .el-form-item__label { color: var(--text-secondary) !important; }
        .el-radio { color: var(--text-primary) !important; margin-right: 30px; }
        .el-radio__input.is-checked + .el-radio__label { color: var(--accent-blue) !important; }
        .el-radio__inner { background: transparent; border-color: var(--text-secondary); }
        .el-radio__input.is-checked .el-radio__inner { border-color: var(--accent-blue); background: var(--accent-blue); }

        /* è¾“å…¥æ¡†é€‚é… */
        .el-input__inner, .el-input-number__decrease, .el-input-number__increase {
            background-color: #151521 !important;
            border-color: var(--border-color) !important;
            color: white !important;
        }
        .el-input.is-disabled .el-input__inner { background-color: rgba(255,255,255,0.05) !important; color: #999 !important; }

        /* ä¸‹æ‹‰æ¡†é€‚é… */
        .el-select-dropdown { background-color: var(--card-bg) !important; border: 1px solid var(--border-color) !important; }
        .el-select-dropdown__item { color: var(--text-secondary) !important; }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover { background-color: rgba(255,255,255,0.05) !important; }

        /* è¡¨æ ¼æš—é»‘é€‚é… */
        .el-table, .el-table__expanded-cell { background-color: transparent !important; color: var(--text-primary) !important; }
        .el-table th, .el-table tr { background-color: transparent !important; }
        .el-table--border::after, .el-table--group::after, .el-table::before { background-color: var(--border-color) !important; }
        .el-table td, .el-table th.is-leaf { border-bottom: 1px solid var(--border-color) !important; }
        .el-table--enable-row-hover .el-table__body tr:hover > td { background-color: rgba(115, 103, 240, 0.1) !important; }

        /* æŒ‰é’® */
        .el-button--primary { background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)); border: none; }
        .el-button--text { color: #ea5455; }
        .btn-home { color: var(--text-secondary); border-color: var(--text-secondary); background: transparent; }
        .btn-home:hover { color: white; border-color: white; }
    </style>
</head>
<body>

<div id="app">
    <div class="card-box">
        <div class="header-title">
            <span><i class="el-icon-office-building" style="color: var(--accent-purple)"></i> æ¥¼å±‚å‚æ•°é…ç½®</span>
            <el-button size="small" icon="el-icon-s-home" class="btn-home" @click="goBack">è¿”å›é¦–é¡µ</el-button>
        </div>
        <el-form :inline="true" size="small">
            <el-form-item label="å½“å‰é¡¹ç›® ID">
                <el-input v-model="projectId" disabled style="width: 80px;"></el-input>
            </el-form-item>
            <el-form-item label="é€‰æ‹©æ¥¼æ ‹">
                <el-select v-model="currentBuildingId" placeholder="è¯·é€‰æ‹©æ¥¼æ ‹" @change="loadFloorData">
                    <el-option v-for="b in buildingList" :key="b.id" :label="b.name" :value="b.id"></el-option>
                </el-select>
            </el-form-item>
        </el-form>
    </div>

    <div class="card-box" v-if="currentBuildingId">
        <div style="margin-bottom: 20px; font-weight: bold; color: white;">ğŸš€ é…ç½®ç”Ÿæˆç­–ç•¥</div>

        <el-radio-group v-model="configMode" style="margin-bottom: 20px;">
            <el-radio label="A">æ¨¡å¼A: ç»Ÿä¸€æ ‡å‡†å±‚é«˜</el-radio>
            <el-radio label="B">æ¨¡å¼B: é¦–å±‚ç‰¹æ®Š + æ ‡å‡†å±‚ (æ¨è)</el-radio>
            <el-radio label="C">æ¨¡å¼C: çº¯æ‰‹åŠ¨å½•å…¥</el-radio>
        </el-radio-group>

        <div class="config-area" v-if="configMode === 'A' || configMode === 'B'">
            <div class="mode-desc" v-if="configMode === 'A'">é€‚ç”¨äºæ‰€æœ‰æ¥¼å±‚é«˜åº¦ä¸€è‡´çš„æƒ…å†µï¼ˆå¦‚åŠå…¬æ¥¼æ ‡å‡†æ®µï¼‰ã€‚</div>
            <div class="mode-desc" v-if="configMode === 'B'">é€‚ç”¨äºé¦–å±‚æ˜¯å¤§å ‚/å•†é“ºï¼ˆè¾ƒé«˜ï¼‰ï¼Œå…¶ä½™ä¸ºæ ‡å‡†ä½å®…çš„æƒ…å†µã€‚</div>

            <el-form :inline="true" size="small">
                <el-form-item label="æ€»å±‚æ•°">
                    <el-input-number v-model="params.totalFloors" :min="1" :max="100"></el-input-number>
                </el-form-item>

                <el-form-item label="é¦–å±‚é«˜åº¦(m)" v-if="configMode === 'B'">
                    <el-input-number v-model="params.firstHeight" :precision="2" :step="0.1" :min="1"></el-input-number>
                </el-form-item>

                <el-form-item label="æ ‡å‡†å±‚é«˜(m)">
                    <el-input-number v-model="params.stdHeight" :precision="2" :step="0.1" :min="1"></el-input-number>
                </el-form-item>

                <el-form-item>
                    <el-button type="primary" icon="el-icon-cpu" @click="generatePreview">ç”Ÿæˆé¢„è§ˆæ•°æ®</el-button>
                </el-form-item>
            </el-form>
        </div>

        <div style="margin-top: 20px;">
            <div style="margin-bottom: 10px; font-weight: bold; color: var(--text-secondary); display: flex; justify-content: space-between;">
                <span>ğŸ“Š æ¥¼å±‚æ•°æ®é¢„è§ˆ (å…± {{ floorList.length }} å±‚)</span>
                <span style="font-size: 12px; font-weight: normal;">* å¯ç›´æ¥åœ¨è¡¨æ ¼ä¸­å¾®è°ƒ</span>
            </div>

            <el-table :data="floorList" border size="mini" height="400">
                <el-table-column prop="floorNumber" label="æ¥¼å±‚ (F)" width="80" align="center"></el-table-column>

                <el-table-column label="æœ¬å±‚å±‚é«˜ (ç±³)" width="150" align="center">
                    <template slot-scope="scope">
                        <el-input-number v-model="scope.row.floorHeight" :precision="2" :step="0.1" size="mini"
                            style="width: 100%;" @change="recalcCumulative(scope.$index)"></el-input-number>
                    </template>
                </el-table-column>

                <el-table-column label="å±‚é¡¶ç´¯è®¡æ ‡é«˜ (ç±³)" align="center">
                    <template slot-scope="scope">
                        <span style="font-weight: bold; color: var(--accent-blue);">{{ scope.row.cumulativeHeight }}</span>
                    </template>
                </el-table-column>

                <el-table-column label="æ“ä½œ" width="80" align="center" v-if="configMode === 'C'">
                    <template slot-scope="scope">
                        <el-button type="text" icon="el-icon-delete" @click="removeFloor(scope.$index)">åˆ é™¤</el-button>
                    </template>
                </el-table-column>
            </el-table>

            <div style="margin-top: 10px;" v-if="configMode === 'C'">
                <el-button size="mini" type="primary" plain icon="el-icon-plus" @click="addFloor">æ·»åŠ ä¸€å±‚</el-button>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <el-button type="primary" icon="el-icon-check" style="width: 200px;" @click="saveToBackend" :disabled="floorList.length === 0">
                    ä¿å­˜é…ç½®
                </el-button>
            </div>
        </div>
    </div>

    <div class="card-box" v-else style="text-align: center; padding: 60px;">
        <i class="el-icon-back" style="font-size: 40px; color: var(--text-secondary); margin-bottom: 10px;"></i>
        <div style="color: var(--text-secondary);">è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªæ¥¼æ ‹</div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            projectId: 1,
            token: localStorage.getItem('token'),
            buildingList: [],
            currentBuildingId: null,
            configMode: 'B',
            params: { totalFloors: 10, firstHeight: 4.5, stdHeight: 3.0 },
            floorList: []
        },
        mounted() {
            const pid = localStorage.getItem('currentProjectId');
            if(pid) this.projectId = pid;
            if (this.token && !this.token.startsWith('Bearer ')) this.token = 'Bearer ' + this.token;
            this.loadBuildings();
        },
        methods: {
            loadBuildings() {
                axios.get(`/api/buildings/list?projectId=${this.projectId}`, { headers: { 'Authorization': this.token } })
                .then(res => { if((res.data.code||res.data.status) === 200) this.buildingList = res.data.data; });
            },
            loadFloorData() {
                this.floorList = [];
                axios.get(`/api/floors/list?buildingId=${this.currentBuildingId}`, { headers: { 'Authorization': this.token } })
                .then(res => {
                    const data = res.data.data;
                    if (data && data.length > 0) {
                        this.floorList = data;
                        this.$message.success("å·²åŠ è½½å†å²é…ç½®");
                        this.params.totalFloors = data.length;
                    } else {
                        this.$message.info("æš‚æ— é…ç½®ï¼Œè¯·ç”Ÿæˆ");
                    }
                });
            },
            generatePreview() {
                this.floorList = [];
                let currentH = 0;
                for (let i = 1; i <= this.params.totalFloors; i++) {
                    let h = this.params.stdHeight;
                    if (this.configMode === 'B' && i === 1) h = this.params.firstHeight;
                    currentH += h;
                    this.floorList.push({
                        floorNumber: i,
                        floorHeight: parseFloat(h.toFixed(2)),
                        cumulativeHeight: parseFloat(currentH.toFixed(2))
                    });
                }
                this.$message.success("é¢„è§ˆç”Ÿæˆå®Œæ¯•");
            },
            recalcCumulative(startIndex) {
                let currentH = (startIndex > 0) ? this.floorList[startIndex - 1].cumulativeHeight : 0;
                for (let i = startIndex; i < this.floorList.length; i++) {
                    currentH += this.floorList[i].floorHeight;
                    this.floorList[i].cumulativeHeight = parseFloat(currentH.toFixed(2));
                }
            },
            addFloor() {
                const lastCumulative = this.floorList.length > 0 ? this.floorList[this.floorList.length-1].cumulativeHeight : 0;
                this.floorList.push({
                    floorNumber: this.floorList.length + 1,
                    floorHeight: 3.0,
                    cumulativeHeight: parseFloat((lastCumulative + 3.0).toFixed(2))
                });
            },
            removeFloor(index) {
                this.floorList.splice(index, 1);
                this.floorList.forEach((item, idx) => item.floorNumber = idx + 1);
                this.recalcCumulative(0);
            },
            saveToBackend() {
                axios.post(`/api/floors/save?projectId=${this.projectId}&buildingId=${this.currentBuildingId}`,
                    this.floorList, { headers: { 'Authorization': this.token } }
                ).then(res => {
                    if ((res.data.code||res.data.status) === 200) this.$message.success("ä¿å­˜æˆåŠŸï¼");
                    else this.$message.error(res.data.message);
                });
            },
            goBack() { window.location.href = 'index.html'; }
        }
    })
</script>
</body>
</html>