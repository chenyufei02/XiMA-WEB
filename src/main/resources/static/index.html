<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>XiMA 智能建造控制台</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* --- 1. 全局深色主题定义 --- */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --border-color: rgba(255,255,255,0.08);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-primary); overflow: hidden; }

        #app { display: flex; height: 100vh; }

        /* 侧边栏 */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .logo-area { height: 80px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; border-bottom: 1px solid var(--border-color); }
        .logo-area i { color: var(--accent-purple); margin-right: 10px; font-size: 24px; }
        .nav-menu { flex: 1; padding: 20px; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; margin-bottom: 10px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.3s; }
        .nav-item:hover, .nav-item.active { background: linear-gradient(90deg, rgba(115, 103, 240, 0.25), transparent); color: var(--accent-purple); border-left: 3px solid var(--accent-purple); }
        .nav-item i { margin-right: 12px; font-size: 18px; }

        /* 主内容 */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .page-title h2 { margin: 0; font-size: 24px; font-weight: 600; }
        .user-profile { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px 40px; }

        /* --- 宽大卡片布局 --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 25px;
        }

        .project-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* ✅ 新增：鼠标手型，提示可点击 */
            cursor: pointer;
        }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: rgba(115, 103, 240, 0.3); }

        .card-stripe { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .stripe-blue { background: var(--accent-blue); }
        .stripe-purple { background: var(--accent-purple); }
        .stripe-green { background: var(--accent-green); }

        /* 卡片内容区 */
        .card-body { padding: 25px; flex: 1; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .p-title { font-size: 20px; font-weight: bold; color: #fff; }
        .p-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: rgba(40, 199, 111, 0.15); color: var(--accent-green); }

        .p-info { display: flex; gap: 20px; font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; }
        .info-item i { margin-right: 5px; color: var(--accent-purple); }

        /* 功能入口按钮区 (彩色霓虹修复版) */
        .function-buttons { display: flex; gap: 10px; margin-top: 15px; }

        .btn-neon {
            flex: 1; border: none; padding: 12px 0; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
            /* 默认状态下文字颜色稍微亮一点 */
            color: rgba(255,255,255,0.8);
        }

        /* 电子围栏 - 紫色系 */
        .btn-map { background: rgba(115, 103, 240, 0.15); color: var(--accent-purple); border: 1px solid rgba(115, 103, 240, 0.2); }
        .btn-map:hover { background: var(--accent-purple); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(115, 103, 240, 0.4); }

        /* 楼层配置 - 蓝色系 */
        .btn-floor { background: rgba(0, 207, 232, 0.15); color: var(--accent-blue); border: 1px solid rgba(0, 207, 232, 0.2); }
        .btn-floor:hover { background: var(--accent-blue); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 207, 232, 0.4); }

        /* 数据看板 - 绿色系 (修复看不清的问题) */
        /* 使用更深的背景色，或者明确指定非悬停时的文字颜色 */
        .btn-chart { background: rgba(40, 199, 111, 0.15); color: var(--accent-green); border: 1px solid rgba(40, 199, 111, 0.2); }
        .btn-chart:hover { background: var(--accent-green); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 199, 111, 0.4); }

        /* 底部管理操作区 */
        .card-footer {
            background: rgba(0,0,0,0.2);
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        .btn-action { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: color 0.2s; }
        .btn-action:hover { color: #fff; }
        .btn-action.delete:hover { color: var(--accent-red); }

        /* 统计卡片 */
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 20px; border: 1px solid var(--border-color); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }

        /* Element UI 弹窗适配 */
        .el-dialog { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .el-dialog__title { color: var(--text-primary); }
        .el-dialog__body { color: var(--text-primary); padding: 20px 30px; }
        .el-form-item__label { color: var(--text-secondary); }
        .el-input__inner { background-color: #151521; border: 1px solid var(--border-color); color: #fff; }
    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div class="logo-area">
            <i class="el-icon-monitor"></i> XiMA 智造
        </div>
        <div class="nav-menu">
            <div class="nav-item active">
                <i class="el-icon-menu"></i> 项目概览
            </div>
            <div class="nav-item" @click="goToImport">
                <i class="el-icon-upload"></i> 项目导入
            </div>
            <div class="nav-item">
                <i class="el-icon-setting"></i> 系统设置
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div class="page-title">
                <h2>项目控制台</h2>
            </div>
            <div class="user-profile">
                <el-button type="primary" size="small" icon="el-icon-plus" round @click="goToImport">新建项目</el-button>
                <div style="text-align: right; margin-right: 10px;">
                    <div style="font-weight: bold;">{{ username }}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">管理员</div>
                </div>
                <div class="avatar">{{ username.substring(0,1).toUpperCase() }}</div>
                <i class="el-icon-switch-button" style="cursor: pointer; color: var(--accent-red); font-size: 20px;" @click="logout" title="退出"></i>
            </div>
        </div>

        <div class="content-scroll">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(115, 103, 240, 0.2); color: var(--accent-purple);"><i class="el-icon-folder-opened"></i></div>
                    <div><div style="font-size: 24px; font-weight: bold;">{{ projects.length }}</div><div style="color: var(--text-secondary);">进行中项目</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(0, 207, 232, 0.2); color: var(--accent-blue);"><i class="el-icon-data-line"></i></div>
                    <div><div style="font-size: 24px; font-weight: bold;">Online</div><div style="color: var(--text-secondary);">系统状态</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(40, 199, 111, 0.2); color: var(--accent-green);"><i class="el-icon-cpu"></i></div>
                    <div><div style="font-size: 24px; font-weight: bold;">Running</div><div style="color: var(--text-secondary);">计算服务</div></div>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center;">
                我的项目列表
                <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal; margin-left: 10px;">(共 {{ projects.length }} 个)</span>
            </h3>

            <div v-if="loading" style="text-align: center; padding: 50px;">
                <i class="el-icon-loading" style="font-size: 30px; color: var(--accent-purple);"></i>
                <p style="color: var(--text-secondary);">加载星际数据中...</p>
            </div>

            <div class="dashboard-grid" v-else>
                <div class="project-card" v-for="(item, index) in projects" :key="item.id" @click="goToDashboard(item.id)">
                    <div :class="['card-stripe', getStripeColor(index)]"></div>

                    <div class="card-body">
                        <div class="card-header">
                            <div class="p-title">{{ item.projectName }}</div>
                            <span class="p-status">进行中</span>
                        </div>

                        <div class="p-info">
                            <div class="info-item"><i class="el-icon-date"></i> {{ formatDate(item.createdAt) }}</div>
                            <div class="info-item"><i class="el-icon-folder"></i> {{ item.photoFolderKeyword }}</div>
                        </div>

                        <div class="function-buttons">
                            <button class="btn-neon btn-map" @click.stop="enterFunction('boundary', item.id)">
                                <i class="el-icon-map-location"></i> 电子围栏
                            </button>
                            <button class="btn-neon btn-floor" @click.stop="enterFunction('floor', item.id)">
                                <i class="el-icon-office-building"></i> 楼层配置
                            </button>
                            <button class="btn-neon btn-chart" @click.stop="goToDashboard(item.id)">
                                <i class="el-icon-data-analysis"></i> 数据看板
                            </button>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button class="btn-action" @click.stop="openEditModal(item)">
                            <i class="el-icon-setting"></i> 项目设置
                        </button>

                        <el-popconfirm
                            title="确定要删除这个项目及其所有数据吗？此操作不可恢复！"
                            confirm-button-text='确定删除'
                            cancel-button-text='取消'
                            icon="el-icon-info"
                            icon-color="red"
                            @confirm="deleteProject(item.id)"
                        >
                            <button class="btn-action delete" slot="reference" @click.stop>
                                <i class="el-icon-delete"></i> 删除项目
                            </button>
                        </el-popconfirm>
                    </div>
                </div>
            </div>

            <div v-if="!loading && projects.length === 0" style="text-align: center; margin-top: 50px; color: var(--text-secondary);">
                <i class="el-icon-folder" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>暂无项目，请点击右上角导入</p>
            </div>
        </div>
    </div>

    <el-dialog title="项目设置" :visible.sync="editDialogVisible" width="500px">
        <el-form :model="editForm" label-width="100px">
            <el-form-item label="项目名称">
                <el-input v-model="editForm.projectName"></el-input>
            </el-form-item>
            <el-form-item label="照片关键词">
                <el-input v-model="editForm.photoFolderKeyword"></el-input>
            </el-form-item>
            <el-form-item label="项目负责人">
                <el-input v-model="editForm.manager" placeholder="（示例字段）"></el-input>
            </el-form-item>
            <el-form-item label="备注信息">
                <el-input type="textarea" v-model="editForm.remarks" placeholder="（示例字段）"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="editDialogVisible = false" size="small">取 消</el-button>
            <el-button type="primary" @click="submitEdit" size="small" :loading="saving">保存修改</el-button>
        </span>
    </el-dialog>

</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            username: '',
            loading: true,
            saving: false,
            projects: [],
            editDialogVisible: false,
            editForm: { id: null, projectName: '', photoFolderKeyword: '', manager: '', remarks: '' }
        },
        created() {
            this.checkLogin();
            this.fetchProjects();
        },
        methods: {
            getStripeColor(index) {
                const colors = ['stripe-purple', 'stripe-blue', 'stripe-green'];
                return colors[index % 3];
            },

            checkLogin() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('username');
                if (!token) { window.location.href = 'login.html'; return; }
                this.username = user || 'Admin';
            },

            fetchProjects() {
                const token = localStorage.getItem('token');
                axios.get('/api/projects/my', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => {
                    if (res.data.status === 200 || res.data.code === 200) {
                        this.projects = res.data.data;
                    }
                }).finally(() => {
                    this.loading = false;
                });
            },

            // ✅ 新增：跳转到项目看板页
            goToDashboard(projectId) {
                localStorage.setItem('currentProjectId', projectId);
                window.location.href = 'dashboard.html';
            },

            enterFunction(type, projectId) {
                localStorage.setItem('currentProjectId', projectId);
                if (type === 'boundary') window.location.href = 'boundary.html';
                else if (type === 'floor') window.location.href = 'floor-config.html';
                // 'chart' 按钮现在也调用 goToDashboard 逻辑，或者指向旧 chart 页，这里建议直接去新的 dashboard
                // else if (type === 'chart') window.location.href = 'chart.html';
            },

            goToImport() {
                window.location.href = 'import.html';
            },

            logout() {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            },

            formatDate(str) {
                return str ? str.split('T')[0] : '未知日期';
            },

            deleteProject(id) {
                const token = localStorage.getItem('token');
                axios.delete('/api/projects/' + id, {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => {
                    if (res.data.status === 200 || res.data.code === 200) {
                        this.$message.success('删除成功');
                        this.fetchProjects();
                    } else {
                        this.$message.error('删除失败: ' + res.data.message);
                    }
                }).catch(() => {
                    this.$message.error('网络错误');
                });
            },

            openEditModal(item) {
                this.editForm = {
                    id: item.id,
                    projectName: item.projectName,
                    photoFolderKeyword: item.photoFolderKeyword,
                    manager: '',
                    remarks: ''
                };
                this.editDialogVisible = true;
            },

            submitEdit() {
                this.saving = true;
                const token = localStorage.getItem('token');
                axios.put('/api/projects/' + this.editForm.id, this.editForm, {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => {
                    if (res.data.status === 200 || res.data.code === 200) {
                        this.$message.success('更新成功');
                        this.editDialogVisible = false;
                        this.fetchProjects();
                    } else {
                        this.$message.error('更新失败');
                    }
                }).finally(() => {
                    this.saving = false;
                });
            }
        }
    })
</script>
</body>
</html>