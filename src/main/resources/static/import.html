<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®å¯¼å…¥ - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* --- 1. å…¨å±€ä¸»é¢˜å®šä¹‰ (æ·±è‰²èµ›åšé£) --- */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --border-color: rgba(255,255,255,0.08);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-primary); overflow: hidden; }
        #app { display: flex; height: 100vh; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); flex-shrink: 0; }
        .logo-area { height: 80px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .logo-area i { color: var(--accent-purple); margin-right: 10px; font-size: 24px; }
        .nav-menu { flex: 1; padding: 20px; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; margin-bottom: 10px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.3s; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: linear-gradient(90deg, rgba(115, 103, 240, 0.25), transparent); color: var(--accent-purple); border-left: 3px solid var(--accent-purple); }
        .nav-item i { margin-right: 12px; font-size: 18px; }

        /* ä¸»å†…å®¹ */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .page-title h2 { margin: 0; font-size: 24px; font-weight: 600; color: var(--text-primary); }
        .user-profile { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px 40px; }

        .neon-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 40px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.2);
            max-width: 900px;
            margin: 0 auto;
        }

        .section-title { font-size: 18px; color: var(--accent-blue); margin-bottom: 25px; display: flex; align-items: center; }
        .form-tip { font-size: 12px; color: var(--text-secondary); margin-top: 8px; line-height: 1.5; }

        /* CSS æ ·å¼è¦†ç›– */
        .el-input__inner { background-color: #151521 !important; border: 1px solid var(--border-color) !important; color: var(--text-primary) !important; height: 45px; }
        .el-input__inner:focus { border-color: var(--accent-purple) !important; }
        .el-button--primary { background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)); border: none; font-weight: bold; }
        .el-step__title.is-process { color: var(--accent-blue) !important; font-weight: bold; }
        .el-step__title.is-wait { color: var(--text-secondary) !important; }
        .el-step__title.is-success { color: var(--accent-green) !important; }

        /* è¡¨æ ¼æ ·å¼ä¿®å¤ */
        .el-table, .el-table__expanded-cell { background-color: transparent !important; color: var(--text-primary) !important; }
        .el-table th, .el-table tr { background-color: transparent !important; border-bottom: 1px solid var(--border-color) !important; }
        .el-table td { border-bottom: 1px solid var(--border-color) !important; }
        .el-table--enable-row-hover .el-table__body tr:hover>td { background-color: rgba(115, 103, 240, 0.1) !important; }

        /* âœ… é€‰ä¸­è¡Œæ ·å¼ï¼šåŠé€æ˜ç´«è‰² */
        .el-table__body tr.current-row>td { background-color: rgba(115, 103, 240, 0.3) !important; color: #fff !important; }

        .el-table::before { background-color: transparent !important; }
        .el-radio__label { color: var(--text-primary) !important; }
        .el-loading-mask { background-color: rgba(30, 30, 45, 0.9) !important; }

        /* å·²å¯¼å…¥è¡Œçš„æ ·å¼ï¼ˆç•¥å¾®æš—æ·¡ï¼Œä½†å¯ç‚¹å‡»ï¼‰ */
        .imported-row { opacity: 0.8; }

        /* ä¼ é€é—¨å¡ç‰‡ */
        .jump-card {
            background: rgba(115, 103, 240, 0.1);
            border: 1px dashed var(--accent-purple);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div class="logo-area" @click="goHome"><i class="el-icon-monitor"></i> XiMA æ™ºé€ </div>
        <div class="nav-menu">
            <div class="nav-item" @click="goToPage('index.html')"><i class="el-icon-menu"></i> é¡¹ç›®æ¦‚è§ˆ</div>
            <div class="nav-item" @click="goToPage('plan-config.html')"><i class="el-icon-date"></i> è®¡åˆ’è¿›åº¦</div>
            <div class="nav-item active"><i class="el-icon-upload"></i> é¡¹ç›®å¯¼å…¥</div>
            <div class="nav-item"><i class="el-icon-setting"></i> ç³»ç»Ÿè®¾ç½®</div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div class="page-title"><h2>æ•°æ®æ¥å…¥ä¸­å¿ƒ</h2></div>
            <div class="user-profile">
                <el-button size="small" icon="el-icon-back" @click="goHome" style="background: rgba(255,255,255,0.1); color: white; border:none;">è¿”å›ä¸»é¡µ</el-button>
                <div class="avatar">{{ username.substring(0,1).toUpperCase() }}</div>
            </div>
        </div>

        <div class="content-scroll">
            <div class="neon-card">
                <el-steps :active="activeStep" finish-status="success" align-center style="margin-bottom: 40px;">
                    <el-step title="å¤§ç–†æˆæƒ"></el-step>
                    <el-step title="å­˜å‚¨é…ç½®"></el-step>
                    <el-step title="å®Œæˆå¯¼å…¥"></el-step>
                </el-steps>

                <div v-if="activeStep === 0">
                    <div class="section-title"><i class="el-icon-key"></i> ç¬¬ä¸€æ­¥ï¼šå…³è”å¤§ç–†å¸ç©º 2 å¹³å°</div>
                    <el-form label-position="top">
                        <el-form-item>
                            <span slot="label" style="color: var(--text-primary);">ç»„ç»‡å¯†é’¥ (Organization Key)</span>
                            <el-input v-model="form.apiKey" placeholder="è¯·è¾“å…¥ eyjh å¼€å¤´çš„å¯†é’¥..." clearable></el-input>
                            <div class="form-tip">ğŸ”‘ è·å–è·¯å¾„ï¼šå¸ç©º2ç½‘é¡µç‰ˆ -> ç»„ç»‡è®¾ç½® -> å¸ç©ºSync -> å¤åˆ¶ç»„ç»‡å¯†é’¥</div>
                        </el-form-item>
                        <div style="margin-top: 40px; text-align: center;">
                            <el-button type="primary" style="width: 200px;" @click="fetchDjiProjects" :loading="loadingDji" round>ä¸‹ä¸€æ­¥ï¼šæŸ¥è¯¢é¡¹ç›®</el-button>
                        </div>
                    </el-form>
                </div>

                <div v-if="activeStep === 1">
                    <div class="section-title"><i class="el-icon-folder-opened"></i> é€‰æ‹©è¦æ¥å…¥çš„é¡¹ç›®</div>

                    <el-table :data="djiProjects" highlight-current-row @current-change="handleProjectSelect" :row-class-name="tableRowClassName" style="width: 100%; margin-bottom: 30px;">
                        <el-table-column width="50" align="center">
                            <template slot-scope="scope">
                                <el-radio v-model="selectedProjectUuid" :label="scope.row.uuid">&nbsp;</el-radio>
                            </template>
                        </el-table-column>

                        <el-table-column prop="name" label="é¡¹ç›®åç§°">
                            <template slot-scope="scope">
                                <span>{{ scope.row.name }}</span>
                                <el-tag v-if="scope.row.imported" type="success" size="mini" effect="dark" style="margin-left: 10px;">âœ… å·²åœ¨åº“ä¸­</el-tag>
                            </template>
                        </el-table-column>

                        <el-table-column prop="uuid" label="UUID" width="300"></el-table-column>
                    </el-table>

                    <transition name="el-fade-in-linear" mode="out-in">

                        <div v-if="isSelectedImported" key="exists" class="jump-card">
                            <i class="el-icon-success" style="font-size: 48px; color: var(--accent-green); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-primary); margin: 0 0 10px 0;">æ­¤é¡¹ç›®å·²å¯¼å…¥</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px;">æ— éœ€é‡å¤é…ç½®ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¿›å…¥é¡¹ç›®çœ‹æ¿ç®¡ç†æ•°æ®ã€‚</p>
                            <el-button type="primary" @click="goHome" round icon="el-icon-s-promotion">è¿›å…¥é¡¹ç›®æ¦‚è§ˆ</el-button>
                        </div>

                        <div v-else-if="selectedProjectUuid" key="new">
                            <div class="section-title" style="margin-top: 40px;"><i class="el-icon-cloudy"></i> åä¸ºäº‘ OBS é…ç½®</div>
                            <el-form :model="form" label-width="100px" label-position="left">
                                <el-row :gutter="20">
                                    <el-col :span="12"><el-form-item><span slot="label" style="color: var(--text-secondary);">Endpoint</span><el-input v-model="form.obsEndpoint"></el-input></el-form-item></el-col>
                                    <el-col :span="12"><el-form-item><span slot="label" style="color: var(--text-secondary);">Bucket</span><el-input v-model="form.obsBucketName"></el-input></el-form-item></el-col>
                                </el-row>
                                <el-row :gutter="20">
                                    <el-col :span="12"><el-form-item><span slot="label" style="color: var(--text-secondary);">AK</span><el-input v-model="form.obsAk" type="password" show-password></el-input></el-form-item></el-col>
                                    <el-col :span="12"><el-form-item><span slot="label" style="color: var(--text-secondary);">SK</span><el-input v-model="form.obsSk" type="password" show-password></el-input></el-form-item></el-col>
                                </el-row>
                                <el-form-item><span slot="label" style="color: var(--text-secondary);">å…³é”®è¯</span><el-input v-model="form.folderKeyword"></el-input><div class="form-tip">ğŸ“‚ ä»…æŠ“å–åŒ…å«æ­¤å…³é”®è¯çš„æ–‡ä»¶å¤¹ï¼ˆé»˜è®¤ï¼šæ¿€å…‰æµ‹è·ï¼‰</div></el-form-item>

                                <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                                    <el-button @click="activeStep = 0" plain>ä¸Šä¸€æ­¥</el-button>
                                    <el-button type="primary" @click="submitImport" :loading="submitting" round style="padding: 12px 40px;">ğŸš€ ç¡®è®¤æ¥å…¥</el-button>
                                </div>
                            </el-form>
                        </div>

                        <div v-else key="empty" style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                            <i class="el-icon-arrow-up"></i> è¯·å…ˆåœ¨ä¸Šæ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé¡¹ç›®
                        </div>

                    </transition>
                </div>

                <div v-if="activeStep === 3" style="text-align: center; padding: 60px 0;">
                    <div style="width: 80px; height: 80px; background: rgba(40, 199, 111, 0.2); color: var(--accent-green); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px;"><i class="el-icon-check"></i></div>
                    <h2 style="color: var(--text-primary); margin-bottom: 10px;">æ¥å…¥æˆåŠŸï¼</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 40px;">é¡¹ç›®å·²åŒæ­¥è‡³æ•°æ®åº“ï¼Œå³å°†å¼€å§‹ç…§ç‰‡åŒæ­¥ã€‚</p>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <el-button type="primary" @click="goHome" round icon="el-icon-s-home" style="width: 160px;">è¿”å›é¡¹ç›®æ¦‚è§ˆ</el-button>
                        <el-button @click="resetForm" plain round icon="el-icon-refresh-right">ç»§ç»­å¯¼å…¥</el-button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            username: 'Admin',
            activeStep: 0,
            loadingDji: false,
            submitting: false,
            djiProjects: [],
            selectedProjectUuid: null,
            form: { apiKey: '', obsEndpoint: 'obs.cn-east-3.myhuaweicloud.com', obsBucketName: 'xima-photos-whu', obsAk: '', obsSk: '', folderKeyword: 'æ¿€å…‰æµ‹è·' }
        },
        computed: {
            // è®¡ç®—å±æ€§ï¼šåˆ¤æ–­å½“å‰é€‰ä¸­çš„é¡¹ç›®æ˜¯å¦å·²å¯¼å…¥
            isSelectedImported() {
                if (!this.selectedProjectUuid) return false;
                const project = this.djiProjects.find(p => p.uuid === this.selectedProjectUuid);
                return project ? project.imported : false; // è¿™é‡Œçš„ imported å­—æ®µç”±åç«¯ DjiProjectDto è¿”å›
            }
        },
        created() { this.checkLogin(); },
        methods: {
            checkLogin() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('username');
                if (!token) { window.location.href = 'login.html'; return; }
                this.username = user || 'Admin';
            },

            // âœ… ä½¿ç”¨ location.href è·³è½¬ï¼Œé¿å…è·¯å¾„é”™è¯¯
            goToPage(url) { window.location.href = url; },
            goHome() { window.location.href = 'index.html'; },

            tableRowClassName({row}) {
                return row.imported ? 'imported-row' : '';
            },

            fetchDjiProjects() {
                if (!this.form.apiKey) return this.$message.warning('è¯·è¾“å…¥å¯†é’¥');
                this.loadingDji = true;
                axios.get('/api/projects/dji-workspaces', {
                    params: { apiKey: this.form.apiKey },
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                }).then(res => {
                    const result = res.data;
                    if (result.status === 200 || result.code === 200) {
                        this.djiProjects = result.data || [];
                        if(this.djiProjects.length > 0) {
                            this.activeStep = 1;
                        } else {
                            this.$message.info('æœªæŸ¥åˆ°é¡¹ç›®');
                        }
                    } else {
                        this.$message.error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                    }
                }).catch(() => this.$message.error('ç½‘ç»œè¿æ¥å¤±è´¥')).finally(() => this.loadingDji = false);
            },

            handleProjectSelect(row) {
                // ç°åœ¨å…è®¸é€‰ä¸­å·²å¯¼å…¥çš„è¡Œï¼Œä»è€Œè§¦å‘ v-if="isSelectedImported"
                if(row) this.selectedProjectUuid = row.uuid;
            },

            submitImport() {
                // åŒé‡ä¿é™©ï¼šè™½ç„¶å‰ç«¯éšè—äº†è¡¨å•ï¼Œä½†è¿™é‡Œå†æ ¡éªŒä¸€æ¬¡
                if(this.isSelectedImported) {
                    this.$message.warning('è¯¥é¡¹ç›®å·²å¯¼å…¥ï¼Œè¯·ç›´æ¥è¿”å›é¦–é¡µ');
                    return;
                }
                if(!this.selectedProjectUuid) return this.$message.warning('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„é¡¹ç›®');
                if(!this.form.obsAk) return this.$message.warning('è¯·è¾“å…¥AK/SK');

                this.submitting = true;
                const selectedProj = this.djiProjects.find(p => p.uuid === this.selectedProjectUuid);

                const payload = {
                    projectName: selectedProj.name,
                    djiProjectUuid: selectedProj.uuid,
                    djiOrgKey: this.form.apiKey,
                    obsEndpoint: this.form.obsEndpoint,
                    obsBucketName: this.form.obsBucketName,
                    obsAk: this.form.obsAk,
                    obsSk: this.form.obsSk,
                    photoFolderKeyword: this.form.folderKeyword
                };

                axios.post('/api/projects/import', payload, {
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                }).then(res => {
                    if(res.data.status === 200 || res.data.code === 200) {
                        this.$message.success('å¯¼å…¥æˆåŠŸï¼');
                        this.activeStep = 3;
                    } else {
                        this.$message.error(res.data.message || 'å¯¼å…¥å¤±è´¥');
                    }
                }).catch(err => this.$message.error(err.response ? err.response.data.message : 'è¯·æ±‚å¼‚å¸¸')).finally(() => this.submitting = false);
            },
            resetForm() { this.activeStep = 0; this.selectedProjectUuid = null; this.djiProjects = []; }
        }
    })
</script>
</body>
</html>