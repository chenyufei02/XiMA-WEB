<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¯¼å…¥å¤§ç–†å¸ç©º2é¡¹ç›® - XiMA Web</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }

        /* é¡¹ç›®åˆ—è¡¨æ ·å¼ */
        #project-list { margin-top: 20px; border: 1px solid #eee; display: none; }
        .project-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .project-item:last-child { border-bottom: none; }
        .project-info { flex: 1; margin-left: 10px; }
        .project-id { font-size: 12px; color: #999; }
        .rename-input { width: 200px !important; margin-left: 10px; }

        /* åä¸ºäº‘é…ç½®åŒºåŸŸ */
        #obs-config-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ ç¬¬ä¸€æ­¥ï¼šå…³è”å¤§ç–†å¸ç©º2é¡¹ç›®</h2>

    <div class="form-group">
        <label for="apiKey">å¤§ç–†ç»„ç»‡å¯†é’¥ (Organization Key)</label>
        <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥ eyjh å¼€å¤´çš„é•¿å­—ç¬¦ä¸²">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            è·å–æ–¹å¼ï¼šå¸ç©º2ç½‘é¡µç‰ˆ -> æˆ‘çš„ç»„ç»‡ -> ç»„ç»‡è®¾ç½® -> å¸ç©ºSync -> å¤åˆ¶ç»„ç»‡å¯†é’¥
        </p>
    </div>

    <button class="btn" onclick="fetchProjects()">ğŸ” æŸ¥è¯¢æˆ‘çš„é¡¹ç›®åˆ—è¡¨</button>

    <div id="project-list">
        </div>

    <div id="obs-config-area">
        <h3>â˜ï¸ ç¬¬äºŒæ­¥ï¼šé…ç½®åä¸ºäº‘å­˜å‚¨</h3>
        <div class="form-group">
            <label>OBS Endpoint</label>
            <input type="text" id="obsEndpoint" value="obs.cn-east-3.myhuaweicloud.com">
        </div>
        <div class="form-group">
            <label>Bucket Name (æ¡¶å)</label>
            <input type="text" id="obsBucketName" value="xima-photos-whu">
        </div>
        <div class="form-group">
            <label>Access Key (AK)</label>
            <input type="text" id="obsAk" placeholder="è¯·è¾“å…¥åä¸ºäº‘ AK">
        </div>
        <div class="form-group">
            <label>Secret Key (SK)</label>
            <input type="text" id="obsSk" placeholder="è¯·è¾“å…¥åä¸ºäº‘ SK">
        </div>

        <div class="form-group">
            <label>ğŸ“‚ ç…§ç‰‡æ–‡ä»¶å¤¹å…³é”®è¯ (è¿‡æ»¤è§„åˆ™)</label>
            <input type="text" id="folderKeyword" value="è¯·å‹¿åˆ " placeholder="ä¾‹å¦‚ï¼šè¯·å‹¿åˆ ">
            <p style="font-size: 12px; color: #666;">ç³»ç»ŸåªæŠ“å–åŒ…å«æ­¤å…³é”®è¯çš„æ–‡ä»¶å¤¹</p>
        </div>

        <button class="btn btn-success" onclick="submitImport()" style="width: 100%; margin-top: 20px;">âœ… ç¡®è®¤å¯¼å…¥é¡¹ç›®</button>
    </div>
</div>

<script>
    let currentDjiProjects = []; // æš‚å­˜æŸ¥åˆ°çš„é¡¹ç›®æ•°æ®

    // 1. æŸ¥è¯¢å¤§ç–†é¡¹ç›®åˆ—è¡¨
    async function fetchProjects() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert("è¯·å…ˆè¾“å…¥å¤§ç–†ç»„ç»‡å¯†é’¥ï¼");
            return;
        }

        const btn = document.querySelector('button');
        btn.innerText = "æŸ¥è¯¢ä¸­...";
        btn.disabled = true;

        try {
            // è°ƒç”¨æˆ‘ä»¬å†™çš„åç«¯æ¥å£
            const response = await fetch(`/api/projects/dji-workspaces?apiKey=${apiKey}`);
            const result = await response.json();

            if (result.data && result.data.length > 0) {
                currentDjiProjects = result.data;
                renderProjectList(result.data);
                document.getElementById('project-list').style.display = 'block';
                document.getElementById('obs-config-area').style.display = 'block';
            } else {
                alert("æŸ¥è¯¢æˆåŠŸï¼Œä½†æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é¡¹ç›®ã€‚æˆ–è€…åç«¯APIè·¯å¾„ä¸å¯¹ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚");
                console.log("åç«¯è¿”å›:", result);
            }
        } catch (error) {
            console.error("è¯·æ±‚å¤±è´¥", error);
            alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œæˆ–å¯†é’¥æ˜¯å¦æ­£ç¡®ã€‚");
        } finally {
            btn.innerText = "ğŸ” æŸ¥è¯¢æˆ‘çš„é¡¹ç›®åˆ—è¡¨";
            btn.disabled = false;
        }
    }

    // æ¸²æŸ“åˆ—è¡¨åˆ°é¡µé¢
    function renderProjectList(projects) {
        const listDiv = document.getElementById('project-list');
        listDiv.innerHTML = '<h3 style="padding:10px; background:#f9f9f9; margin:0;">è¯·å‹¾é€‰è¦å¯¼å…¥çš„é¡¹ç›®ï¼š</h3>';

        projects.forEach((proj, index) => {
            const item = document.createElement('div');
            item.className = 'project-item';
            item.innerHTML = `
                <input type="radio" name="selectedProject" value="${index}" id="proj_${index}">
                <div class="project-info">
                    <label for="proj_${index}" style="margin:0; cursor:pointer;">${proj.name}</label>
                    <div class="project-id">UUID: ${proj.workspace_id}</div>
                </div>
                <input type="text" class="rename-input" id="rename_${index}" value="${proj.name}" placeholder="é‡å‘½å...">
            `;
            listDiv.appendChild(item);
        });
    }

    // 2. æäº¤å¯¼å…¥
    async function submitImport() {
        // è·å–é€‰ä¸­çš„é¡¹ç›®
        const selectedRadio = document.querySelector('input[name="selectedProject"]:checked');
        if (!selectedRadio) {
            alert("è¯·å…ˆåœ¨åˆ—è¡¨ä¸­å‹¾é€‰ä¸€ä¸ªå¤§ç–†é¡¹ç›®ï¼");
            return;
        }

        const index = selectedRadio.value;
        const originalProj = currentDjiProjects[index];
        const newName = document.getElementById(`rename_${index}`).value;

        // æ„é€ å‘é€ç»™åç«¯çš„ DTO æ•°æ®
        const payload = {
            projectName: newName,
            djiProjectUuid: originalProj.workspace_id,
            djiOrgKey: document.getElementById('apiKey').value.trim(),

            obsEndpoint: document.getElementById('obsEndpoint').value.trim(),
            obsBucketName: document.getElementById('obsBucketName').value.trim(),
            obsAk: document.getElementById('obsAk').value.trim(),
            obsSk: document.getElementById('obsSk').value.trim(),

            photoFolderKeyword: document.getElementById('folderKeyword').value.trim()
        };

        try {
            const response = await fetch('/api/projects/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.message && result.message.includes("æˆåŠŸ")) {
                alert("ğŸ‰ é¡¹ç›®å¯¼å…¥æˆåŠŸï¼æ•°æ®åº“å·²æ›´æ–°ã€‚");
                // å¯ä»¥è·³è½¬åˆ°é¦–é¡µæˆ–æ¸…ç©ºè¡¨å•
            } else {
                alert("å¯¼å…¥å¤±è´¥: " + JSON.stringify(result));
            }
        } catch (e) {
            alert("ç½‘ç»œè¯·æ±‚å¼‚å¸¸");
        }
    }
</script>

</body>
</html>