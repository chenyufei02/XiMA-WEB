<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®å¯¼å…¥ - XiMA Web</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* ================== å¤ç”¨ index.html çš„åŸºç¡€æ ·å¼ ================== */
        body { margin: 0; font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif; background-color: #f0f2f5; }

        /* é¡¶éƒ¨å¯¼èˆªæ ï¼š100% è¿˜åŸä¸»é¡µé£æ ¼ */
        .header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 999; }
        .logo { font-size: 20px; font-weight: bold; color: #409EFF; cursor: pointer; } /* ä¸»è‰²è°ƒ #409EFF */
        .user-info { display: flex; align-items: center; }
        .user-name { margin-right: 15px; font-size: 14px; color: #606266; }

        /* ä¸»å†…å®¹å®¹å™¨ï¼šä¿æŒä¸ä¸»é¡µä¸€è‡´çš„å®½åº¦å’Œå†…è¾¹è· */
        .main-container { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* ================== æœ¬é¡µç‰¹æœ‰æ ·å¼ (Element UI é£æ ¼) ================== */
        .page-header-box { margin-bottom: 20px; background: #fff; padding: 15px 20px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .step-card { min-height: 500px; }
        .form-tip { font-size: 12px; color: #909399; margin-top: 5px; line-height: 1.5; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 20px; border-left: 4px solid #409EFF; padding-left: 10px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="logo" @click="goHome">ğŸ—ï¸ è‡ªåŠ¨è¿›åº¦ç®¡æ§ç³»ç»Ÿ</div>
            <div class="user-info">
                <span class="user-name">æ¬¢è¿, {{ username }}</span>
                <el-button type="text" @click="logout" style="color: #F56C6C">é€€å‡ºç™»å½•</el-button>
            </div>
        </div>

        <div class="main-container">
            <div class="page-header-box">
                <el-page-header @back="goHome" content="å¯¼å…¥æ–°é¡¹ç›®">
                </el-page-header>
            </div>

            <el-card class="step-card" shadow="hover">
                <el-steps :active="activeStep" finish-status="success" simple style="margin-bottom: 30px;">
                    <el-step title="å¤§ç–†æˆæƒ" icon="el-icon-key"></el-step>
                    <el-step title="å­˜å‚¨é…ç½®" icon="el-icon-upload-filled"></el-step>
                    <el-step title="å®Œæˆ" icon="el-icon-check"></el-step>
                </el-steps>

                <div v-if="activeStep === 0" style="max-width: 600px; margin: 40px auto;">
                    <div class="section-title">å…³è”å¤§ç–†å¸ç©º 2 å¹³å°</div>
                    <el-form label-position="top" size="medium">
                        <el-form-item label="å¤§ç–†ç»„ç»‡å¯†é’¥ (Organization Key)">
                            <el-input
                                v-model="form.apiKey"
                                placeholder="è¯·è¾“å…¥ eyjh å¼€å¤´çš„é•¿å­—ç¬¦ä¸²"
                                clearable>
                            </el-input>
                            <div class="form-tip">
                                è·å–è·¯å¾„ï¼šå¸ç©º2ç½‘é¡µç‰ˆ -> ç»„ç»‡è®¾ç½® -> å¸ç©ºSync -> å¤åˆ¶ç»„ç»‡å¯†é’¥
                            </div>
                        </el-form-item>
                        <el-form-item style="margin-top: 30px;">
                            <el-button type="primary" style="width: 100%;" @click="fetchDjiProjects" :loading="loadingDji">
                                ä¸‹ä¸€æ­¥ï¼šæŸ¥è¯¢æˆ‘çš„é¡¹ç›®
                            </el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <div v-if="activeStep === 1">
                    <div class="section-title">é€‰æ‹©è¦å¯¼å…¥çš„é¡¹ç›®</div>

                    <el-table :data="djiProjects" border highlight-current-row @current-change="handleProjectSelect" style="width: 100%; margin-bottom: 20px;">
                        <el-table-column width="55" align="center">
                            <template slot-scope="scope">
                                <el-radio v-model="selectedProjectUuid" :label="scope.row.uuid">&nbsp;</el-radio>
                            </template>
                        </el-table-column>
                        <el-table-column prop="name" label="å¸ç©ºé¡¹ç›®åç§°" width="250">
                            <template slot-scope="scope">
                                <span style="font-weight: bold;">{{ scope.row.name }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="uuid" label="é¡¹ç›® UUID">
                            <template slot-scope="scope">
                                <el-tag size="small" type="info">{{ scope.row.uuid }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="é‡å‘½å (å¯é€‰)" width="250">
                            <template slot-scope="scope">
                                <el-input size="small" v-model="scope.row.rename" placeholder="ä¸ä¿®æ”¹åˆ™ä¿æŒåŸå"></el-input>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div class="section-title" style="margin-top: 30px;">åä¸ºäº‘ OBS å­˜å‚¨é…ç½®</div>
                    <el-form :model="form" label-width="120px" size="medium" style="max-width: 900px;">
                        <el-row :gutter="40">
                            <el-col :span="12">
                                <el-form-item label="Endpoint" required>
                                    <el-input v-model="form.obsEndpoint" placeholder="obs.cn-east-3.myhuaweicloud.com"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="Bucket æ¡¶å" required>
                                    <el-input v-model="form.obsBucketName" placeholder="xima-photos-whu"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row :gutter="40">
                            <el-col :span="12">
                                <el-form-item label="Access Key" required>
                                    <el-input v-model="form.obsAk" type="password" show-password placeholder="åä¸ºäº‘ AK"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item label="Secret Key" required>
                                    <el-input v-model="form.obsSk" type="password" show-password placeholder="åä¸ºäº‘ SK"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-form-item label="æ–‡ä»¶å¤¹å…³é”®è¯">
                            <el-input v-model="form.folderKeyword" style="width: 100%"></el-input>
                            <div class="form-tip">ç³»ç»Ÿå°†è‡ªåŠ¨æŠ“å–åŒ…å«æ­¤å…³é”®è¯çš„æ–‡ä»¶å¤¹ï¼ˆé»˜è®¤ï¼šæ¿€å…‰æµ‹è·ï¼‰ï¼Œç”¨äºè¿‡æ»¤éå·¥ç¨‹ç…§ç‰‡ã€‚</div>
                        </el-form-item>

                        <div style="text-align: center; margin-top: 40px;">
                            <el-button @click="activeStep = 0">ä¸Šä¸€æ­¥</el-button>
                            <el-button type="primary" @click="submitImport" :loading="submitting" icon="el-icon-upload">ç¡®è®¤å¹¶å¯¼å…¥</el-button>
                        </div>
                    </el-form>
                </div>

                <div v-if="activeStep === 3" style="text-align: center; padding: 60px 0;">
                    <i class="el-icon-success" style="font-size: 80px; color: #67C23A; margin-bottom: 20px;"></i>
                    <h2 style="color: #303133; font-weight: 500;">å¯¼å…¥æˆåŠŸï¼</h2>
                    <p style="color: #606266; margin-bottom: 30px;">é¡¹ç›®åŸºç¡€ä¿¡æ¯å·²å»ºç«‹ï¼Œåå°æ­£åœ¨å¼‚æ­¥åŒæ­¥å½±åƒæ•°æ®ã€‚</p>
                    <el-button type="primary" @click="goHome">è¿”å›é¡¹ç›®åˆ—è¡¨</el-button>
                    <el-button @click="resetForm">ç»§ç»­å¯¼å…¥</el-button>
                </div>

            </el-card>
        </div>
    </div>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                username: '',
                activeStep: 0,
                loadingDji: false,
                submitting: false,
                djiProjects: [],
                selectedProjectUuid: null,

                // è¡¨å•æ•°æ®
                form: {
                    apiKey: '',
                    obsEndpoint: 'obs.cn-east-3.myhuaweicloud.com', // é»˜è®¤å€¼
                    obsBucketName: 'xima-photos-whu',
                    obsAk: '',
                    obsSk: '',
                    folderKeyword: 'æ¿€å…‰æµ‹è·'
                }
            },
            created() {
                this.checkLogin();
            },
            methods: {
                // 1. ç™»å½•æ£€æŸ¥ï¼šé€»è¾‘ä¸ index.html å®Œå…¨ä¸€è‡´
                checkLogin() {
                    const token = localStorage.getItem('token');
                    const user = localStorage.getItem('username');

                    if (!token) {
                        this.$message.warning('è¯·å…ˆç™»å½•');
                        window.location.href = 'login.html';
                        return;
                    }
                    this.username = user || 'ç”¨æˆ·';
                },

                // 2. é€€å‡ºç™»å½•
                logout() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    window.location.href = 'login.html';
                },

                // 3. è¿”å›ä¸»é¡µ
                goHome() {
                    window.location.href = 'index.html';
                },

                // 4. è·å–å¤§ç–†é¡¹ç›® (ä¸šåŠ¡é€»è¾‘ä¸å˜)
                fetchDjiProjects() {
                    if (!this.form.apiKey) {
                        this.$message.warning('è¯·è¾“å…¥å¤§ç–†ç»„ç»‡å¯†é’¥');
                        return;
                    }

                    this.loadingDji = true;
                    axios.get('/api/projects/dji-workspaces', {
                        params: { apiKey: this.form.apiKey },
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                    })
                    .then(res => {
                        const result = res.data;
                        if (result.data && Array.isArray(result.data)) {
                            // ç»™æ¯ä¸ªé¡¹ç›®åŠ ä¸€ä¸ª rename å­—æ®µï¼Œé»˜è®¤ç­‰äºåŸå
                            this.djiProjects = result.data.map(p => ({
                                ...p,
                                rename: p.name
                            }));

                            if (this.djiProjects.length === 0) {
                                this.$message.info('æœªæŸ¥è¯¢åˆ°ä»»ä½•é¡¹ç›®');
                            } else {
                                this.activeStep = 1; // åªæœ‰æˆåŠŸæŸ¥åˆ°æ•°æ®æ‰è¿›å…¥ä¸‹ä¸€æ­¥
                            }
                        } else {
                            this.$message.error(result.message || 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¼‚å¸¸');
                    })
                    .finally(() => {
                        this.loadingDji = false;
                    });
                },

                // 5. è¡¨æ ¼é€‰ä¸­å¤„ç†
                handleProjectSelect(row) {
                    if (row) {
                        this.selectedProjectUuid = row.uuid;
                    }
                },

                // 6. æäº¤å¯¼å…¥ (ä¸šåŠ¡é€»è¾‘ä¸å˜)
                submitImport() {
                    if (!this.selectedProjectUuid) {
                        this.$message.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤§ç–†é¡¹ç›®');
                        return;
                    }
                    if (!this.form.obsAk || !this.form.obsSk) {
                        this.$message.warning('è¯·è¡¥å…¨ OBS å¯†é’¥');
                        return;
                    }

                    const selectedProj = this.djiProjects.find(p => p.uuid === this.selectedProjectUuid);

                    // æ„é€ åç«¯éœ€è¦çš„ DTO æ ¼å¼
                    const payload = {
                        projectName: selectedProj.rename || selectedProj.name, // ä½¿ç”¨é‡å‘½ååçš„åå­—
                        djiProjectUuid: selectedProj.uuid,
                        djiOrgKey: this.form.apiKey,

                        obsEndpoint: this.form.obsEndpoint,
                        obsBucketName: this.form.obsBucketName,
                        obsAk: this.form.obsAk,
                        obsSk: this.form.obsSk,

                        photoFolderKeyword: this.form.folderKeyword
                    };

                    this.submitting = true;
                    axios.post('/api/projects/import', payload, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    })
                    .then(res => {
                        if (res.data.code === 200 || res.data.success) {
                            this.activeStep = 3; // æˆåŠŸè·³è½¬
                        } else {
                            this.$message.error('å¯¼å…¥å¤±è´¥: ' + res.data.message);
                        }
                    })
                    .catch(err => {
                        this.$message.error('è¯·æ±‚å¼‚å¸¸');
                    })
                    .finally(() => {
                        this.submitting = false;
                    });
                },

                // 7. é‡ç½®
                resetForm() {
                    this.activeStep = 0;
                    this.selectedProjectUuid = null;
                    this.djiProjects = [];
                }
            }
        });
    </script>
</body>
</html>