<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®šä¹‰ç”µå­å›´æ  - æ‹ç‚¹é€‰æ‹©æ³•</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; }

        /* å·¦ä¾§ï¼šç…§ç‰‡é€‰æ‹©åŒº */
        .sidebar { width: 320px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #f8f9fa; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #ddd; background: #fff; }
        .sidebar-title { margin: 0 0 10px 0; font-size: 16px; color: #333; font-weight: 600; }

        #photo-list { flex: 1; overflow-y: auto; padding: 10px; }
        .photo-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; background: #fff; border-radius: 4px; margin-bottom: 8px; transition: all 0.2s; }
        .photo-item:hover { background: #e6f7ff; border-color: #1890ff; }
        .photo-item img { width: 60px; height: 60px; object-fit: cover; margin-right: 12px; border-radius: 4px; border: 1px solid #eee; }
        .photo-info { font-size: 12px; color: #666; }
        .photo-name { font-weight: bold; color: #333; margin-bottom: 4px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 180px; }

        /* å³ä¾§ï¼šç”»å¸ƒåŒº */
        .main { flex: 1; position: relative; background: #fff; display: flex; flex-direction: column; }

        .toolbar { padding: 12px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; }
        .input-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        input[type="text"], input[type="number"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        input:focus { border-color: #1890ff; }

        .btn { padding: 6px 15px; border-radius: 4px; cursor: pointer; border: none; font-size: 14px; transition: background 0.3s; }
        .btn-primary { background: #1890ff; color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-danger { background: #ff4d4f; color: white; }
        .btn-danger:hover { background: #ff7875; }
        .btn-success { background: #52c41a; color: white; }
        .btn-success:hover { background: #73d13d; }

        #canvas-container { flex: 1; position: relative; margin: 20px; background: #f0f2f5; border: 1px solid #e8e8e8; border-radius: 4px; overflow: hidden; }

        /* ç”»å¸ƒå…ƒç´  */
        .point-marker {
            position: absolute; width: 16px; height: 16px; background: #ff4d4f; border-radius: 50%;
            transform: translate(-50%, -50%); cursor: pointer; border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 10;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;
        }
        .point-marker:hover { transform: translate(-50%, -50%) scale(1.2); }

        /* æç¤ºå±‚ */
        .empty-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; pointer-events: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3 class="sidebar-title">ğŸ“¸ 1. é€‰æ‹©æ‹è§’ç…§ç‰‡</h3>
        <p style="font-size:12px; color:#999; margin:0 0 10px 0;">è¯·å‹¾é€‰ä»£è¡¨å»ºç­‘ç‰©é¡¶å±‚æ‹è§’çš„ç…§ç‰‡</p>

        <div style="border-top:1px dashed #eee; padding-top:10px;">
            <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">ğŸ“‚ æŒ‰ä»»åŠ¡ç­›é€‰ï¼š</label>
            <select id="folderSelect" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;" onchange="filterPhotosByFolder()">
                <option value="all">åŠ è½½ä¸­...</option>
            </select>
        </div>
    </div>
    <div id="photo-list">
        <div style="text-align:center; margin-top:20px; color:#999;">è¯·ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½ç…§ç‰‡</div>
    </div>
</div>

<div class="main">
    <div class="toolbar">
        <div class="input-group">
            <label>é¡¹ç›®ID:</label>
            <input type="number" id="projectIdInput" readonly style="width:60px; background:#f5f5f5; color:#999">
        </div>
        <button class="btn btn-primary" onclick="initPage()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

        <div style="width: 1px; height: 20px; background: #ddd; margin: 0 10px;"></div>

        <div class="input-group">
            <label>ğŸ  æ¥¼æ ‹åç§°:</label>
            <input type="text" id="buildingNameInput" placeholder="ä¾‹å¦‚: 1å·æ¥¼" style="width:150px">
        </div>

        <div style="flex:1"></div>

        <button class="btn btn-danger" onclick="resetSelection()">ğŸ—‘ï¸ é‡ç½®ç”»å¸ƒ</button>
        <button class="btn btn-success" onclick="saveBoundary()">ğŸ’¾ ä¿å­˜è¯¥æ¥¼æ ‹å›´æ </button>
    </div>

    <div id="canvas-container">
        <div class="empty-tip">
            <h3>ğŸ‘ˆ è¯·åœ¨å·¦ä¾§é€‰æ‹©ä»»åŠ¡å¹¶å‹¾é€‰ç…§ç‰‡</h3>
            <p>ç³»ç»Ÿå°†è‡ªåŠ¨è¯»å–ç…§ç‰‡çœŸå®çš„ç»çº¬åº¦(XMP)ç”Ÿæˆå›´æ </p>
        </div>
        <svg id="svg-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 5;"></svg>
        <svg id="svg-existing-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 1;"></svg>
    </div>
</div>

<script>
    let allPhotos = [];
    let selectedPhotos = [];
    let existingBuildings = [];
    let folderNames = new Set();

    // è·å– Token å¹¶ç¡®ä¿åŒ…å« Bearer å‰ç¼€
    let token = localStorage.getItem('token');
    if (token && !token.startsWith('Bearer ')) {
        token = 'Bearer ' + token;
    }

    window.onload = function() {
        const pid = localStorage.getItem('currentProjectId');
        if(pid) {
            document.getElementById('projectIdInput').value = pid;
            initPage();
        } else {
            document.getElementById('projectIdInput').value = 1; // é»˜è®¤æµ‹è¯•
            initPage();
        }
    }

    function initPage() {
        loadPhotos();
        loadExistingBuildings();
    }

    // 1. åŠ è½½ç…§ç‰‡
    async function loadPhotos() {
        const projectId = document.getElementById('projectIdInput').value;
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '<p style="padding:10px; text-align:center">æ­£åœ¨ä»æ•°æ®åº“åŠ è½½ç…§ç‰‡...</p>';

        try {
            const res = await fetch(`/api/projects/${projectId}/photos`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();

            console.log("ğŸ” åç«¯è¿”å›æ•°æ®:", json); // è°ƒè¯•ç”¨

            // âœ…âœ…âœ… æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œå¿…é¡»æ£€æŸ¥ json.status è€Œä¸æ˜¯ json.code
            if (json.status === 200 && json.data) {
                allPhotos = json.data;
                console.log(`âœ… æˆåŠŸè·å– ${allPhotos.length} å¼ ç…§ç‰‡`);
                extractFolders(allPhotos);
                filterPhotosByFolder();
            } else {
                // å¦‚æœ status ä¸æ˜¯ 200ï¼Œæ‰æ˜¾ç¤ºé”™è¯¯
                listDiv.innerHTML = `<p style="padding:10px; color:red">åŠ è½½å¤±è´¥: ${json.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                document.getElementById('folderSelect').innerHTML = '<option value="all">æ— æ•°æ®</option>';
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<p style="padding:10px; color:red">ç½‘ç»œè¯·æ±‚é”™è¯¯</p>';
        }
    }

    // 2. æ™ºèƒ½æå–ä»»åŠ¡å (ä»è·¯å¾„ä¸­è§£æ)
    function extractFolders(photos) {
        folderNames.clear();
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="all">ğŸ“‚ æ˜¾ç¤ºå…¨éƒ¨ç…§ç‰‡</option>';

        // æ‚¨çš„æ—¥å¿—è·¯å¾„ç»“æ„:
        // projects/1/æ¿€å…‰æµ‹è·/CQæ­¦æ±‰å¸‚æ”¿.../Remote-Control/DJI_xxx.jpeg

        photos.forEach(p => {
            if (p.photoUrl) {
                // è§£ç URLï¼Œå¤„ç†ä¸­æ–‡
                const path = decodeURIComponent(p.photoUrl);
                const parts = path.split('/');

                // å€’æ•°ç¬¬2çº§é€šå¸¸æ˜¯æ–‡ä»¶å¤¹å (Remote-Control)
                // å€’æ•°ç¬¬3çº§é€šå¸¸æ˜¯ä»»åŠ¡å (CQæ­¦æ±‰å¸‚æ”¿...)
                if (parts.length >= 3) {
                    let folder = parts[parts.length - 2];

                    // å¦‚æœé‡åˆ° Remote-Control æˆ– origin è¿™ç§å¤§ç–†ç”Ÿæˆçš„å­æ–‡ä»¶å¤¹ï¼Œå°±å¾€ä¸Šæ‰¾ä¸€çº§
                    if (folder === 'Remote-Control' || folder === 'origin' || folder === 'Photos') {
                        folder = parts[parts.length - 3];
                    }

                    // è¿‡æ»¤æ‰é¡¹ç›®IDå’Œæ ¹ç›®å½•å
                    if (folder && folder !== 'projects' && folder !== String(document.getElementById('projectIdInput').value)) {
                         folderNames.add(folder);
                    }
                }
            }
        });

        if (folderNames.size === 0) {
            console.warn("âš ï¸ æœªèƒ½ä»è·¯å¾„ä¸­æå–åˆ°ä»»åŠ¡åï¼Œè·¯å¾„ç¤ºä¾‹:", photos[0]?.photoUrl);
        }

        folderNames.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder;
            option.innerText = "ğŸ“ " + folder;
            select.appendChild(option);
        });

        // é»˜è®¤é€‰ä¸­æœ€æ–°çš„ä¸€ä¸ªä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
        if (folderNames.size > 0) {
            const firstFolder = folderNames.values().next().value;
            select.value = firstFolder;
        }
    }

    function filterPhotosByFolder() {
        const select = document.getElementById('folderSelect');
        const selectedFolder = select.value;

        if (!allPhotos || allPhotos.length === 0) return;

        let filtered = [];
        if (selectedFolder === 'all') {
            filtered = allPhotos;
        } else {
            // åªè¦è·¯å¾„é‡ŒåŒ…å«é€‰ä¸­çš„ä»»åŠ¡åï¼Œå°±æ˜¾ç¤º
            filtered = allPhotos.filter(p => {
                const path = decodeURIComponent(p.photoUrl || '');
                return path.includes(selectedFolder);
            });
        }
        renderPhotoList(filtered);
    }

    function renderPhotoList(photos) {
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '';

        if (photos.length === 0) {
            listDiv.innerHTML = '<p style="padding:10px; color:#999">è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰ç…§ç‰‡ã€‚</p>';
            return;
        }

        photos.forEach(p => {
            const realLat = p.gpsLat || 0;
            const realLng = p.gpsLng || 0;
            if (realLat === 0 && realLng === 0) return; // è¿‡æ»¤æ— åæ ‡ç…§ç‰‡

            const isChecked = selectedPhotos.some(sel => sel.id == p.id) ? 'checked' : '';

            // æå–ç®€çŸ­æ–‡ä»¶å
            let displayName = "æœªçŸ¥æ–‡ä»¶";
            if(p.photoUrl) {
                const parts = p.photoUrl.split('/');
                displayName = parts[parts.length - 1];
                // å»æ‰å‰é¢çš„UUIDå‰ç¼€(å¦‚æœæœ‰)ï¼Œåªæ˜¾ç¤º DJI_xxx.jpg æ›´å¥½çœ‹
                // è¿™é‡Œç®€å•å¤„ç†ï¼Œæ˜¾ç¤ºæœ€åä¸€æ®µ
            }

            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <input type="checkbox" style="margin-right:10px; transform:scale(1.2);"
                       ${isChecked}
                       onchange="togglePhoto('${p.id}', ${realLat}, ${realLng}, this)">

                <img src="${p.photoUrl}" onerror="this.src='https://via.placeholder.com/60?text=Error'">

                <div class="photo-info">
                    <span class="photo-name" title="${displayName}">${displayName}</span>
                    <div style="color:#999">ğŸ“… ${formatTime(p.shootTime)}</div>
                    <div style="font-size:10px; color:#ccc;">ğŸ“ ${Number(realLat).toFixed(6)}, ${Number(realLng).toFixed(6)}</div>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    function formatTime(t) {
        return t ? t.replace('T', ' ') : 'æœªçŸ¥æ—¶é—´';
    }

    // 3. åŠ è½½å·²å­˜åœ¨çš„æ¥¼æ ‹
    async function loadExistingBuildings() {
        const projectId = document.getElementById('projectIdInput').value;
        try {
            const res = await fetch(`/api/buildings/list?projectId=${projectId}`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();
            // åŒæ ·ä½¿ç”¨ status === 200
            if (json.status === 200) {
                existingBuildings = json.data;
                drawCanvas();
            }
        } catch (e) { console.error("åŠ è½½æ¥¼æ ‹å¤±è´¥", e); }
    }

    function togglePhoto(id, lat, lng, checkbox) {
        if (checkbox.checked) {
            selectedPhotos.push({id, lat, lng});
        } else {
            selectedPhotos = selectedPhotos.filter(p => p.id != id);
        }
        drawCanvas();
    }

    function resetSelection() {
        selectedPhotos = [];
        const checkboxes = document.querySelectorAll('#photo-list input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        drawCanvas();
    }

    // 4. ç»˜å›¾ç®—æ³•
    function drawCanvas() {
        const container = document.getElementById('canvas-container');
        document.querySelectorAll('.point-marker').forEach(e => e.remove());
        const svgLayer = document.getElementById('svg-layer');
        const existingLayer = document.getElementById('svg-existing-layer');

        svgLayer.innerHTML = '';
        existingLayer.innerHTML = '';

        let allLats = selectedPhotos.map(p => p.lat);
        let allLngs = selectedPhotos.map(p => p.lng);

        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                try {
                    const coords = JSON.parse(b.boundaryCoords);
                    coords.forEach(c => { allLats.push(c.lat); allLngs.push(c.lng); });
                } catch(e){}
            }
        });

        if(allLats.length === 0) {
            document.querySelector('.empty-tip').style.display = 'block';
            return;
        }
        document.querySelector('.empty-tip').style.display = 'none';

        const minLat = Math.min(...allLats), maxLat = Math.max(...allLats);
        const minLng = Math.min(...allLngs), maxLng = Math.max(...allLngs);

        const latSpan = maxLat - minLat;
        const lngSpan = maxLng - minLng;
        const pad = Math.max(latSpan, lngSpan) * 0.1 || 0.0001;

        const viewMinLat = minLat - pad;
        const viewMaxLat = maxLat + pad;
        const viewMinLng = minLng - pad;
        const viewMaxLng = maxLng + pad;

        const latRange = viewMaxLat - viewMinLat;
        const lngRange = viewMaxLng - viewMinLng;
        const width = container.clientWidth;
        const height = container.clientHeight;

        const toScreen = (lat, lng) => {
            const x = ((lng - viewMinLng) / lngRange) * width;
            const y = height - ((lat - viewMinLat) / latRange) * height;
            return {x, y};
        };

        // ç»˜åˆ¶å·²æœ‰æ¥¼æ ‹
        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                try {
                    const coords = JSON.parse(b.boundaryCoords);
                    if(coords.length > 0) {
                        const pointsStr = coords.map(c => {
                            const p = toScreen(c.lat, c.lng);
                            return `${p.x},${p.y}`;
                        }).join(' ');

                        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                        polygon.setAttribute("points", pointsStr);
                        polygon.setAttribute("style", "fill:rgba(82, 196, 26, 0.2); stroke:#52c41a; stroke-width:2; stroke-dasharray:5,5;");
                        existingLayer.appendChild(polygon);

                        const firstP = toScreen(coords[0].lat, coords[0].lng);
                        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        text.setAttribute("x", firstP.x);
                        text.setAttribute("y", firstP.y - 10);
                        text.setAttribute("fill", "#52c41a");
                        text.setAttribute("font-weight", "bold");
                        text.textContent = b.name;
                        existingLayer.appendChild(text);
                    }
                } catch(e){}
            }
        });

        // ç»˜åˆ¶å½“å‰é€‰åŒº
        if (selectedPhotos.length >= 2) {
            const pointsStr = selectedPhotos.map(p => {
                const s = toScreen(p.lat, p.lng);
                return `${s.x},${s.y}`;
            }).join(' ');

            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute("points", pointsStr);
            polygon.setAttribute("style", "fill:rgba(255, 77, 79, 0.2); stroke:#ff4d4f; stroke-width:2");
            svgLayer.appendChild(polygon);
        }

        selectedPhotos.forEach((p, index) => {
            const screen = toScreen(p.lat, p.lng);
            const dot = document.createElement('div');
            dot.className = 'point-marker';
            dot.style.left = screen.x + 'px';
            dot.style.top = screen.y + 'px';
            dot.innerText = index + 1;
            dot.title = "ç‚¹å‡»å¯å–æ¶ˆ";
            dot.onclick = () => {
                const cb = document.querySelector(`input[onchange*="'${p.id}'"]`);
                if(cb) { cb.click(); }
            };
            container.appendChild(dot);
        });
    }

    // 5. ä¿å­˜å›´æ 
    async function saveBoundary() {
        if (selectedPhotos.length < 3) {
            alert("âš ï¸ è‡³å°‘éœ€è¦3ä¸ªç‚¹æ‰èƒ½æ„æˆä¸€ä¸ªå›´æ ï¼");
            return;
        }
        const buildingName = document.getElementById('buildingNameInput').value.trim();
        if (!buildingName) {
            alert("âš ï¸ è¯·è¾“å…¥æ¥¼æ ‹åç§°ï¼ˆä¾‹å¦‚ï¼š1å·æ¥¼ï¼‰");
            document.getElementById('buildingNameInput').focus();
            return;
        }

        const projectId = document.getElementById('projectIdInput').value;
        const coords = selectedPhotos.map(p => ({ lat: p.lat, lng: p.lng }));

        const btn = document.querySelector('.btn-success');
        const originalText = btn.innerText;
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/projects/${projectId}/boundary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify(coords)
            });
            const json = await res.json();

            // åŒæ ·ä¿®å¤ status æ£€æŸ¥
            if (json.status === 200) {
                alert("âœ… ä¿å­˜æˆåŠŸï¼");
                loadExistingBuildings();
                resetSelection();
            } else {
                alert("âŒ ä¿å­˜å¤±è´¥: " + json.message);
            }
        } catch (e) {
            console.error(e);
            alert('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    window.onresize = drawCanvas;
</script>

</body>
</html>