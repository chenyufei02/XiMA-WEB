<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®šä¹‰ç”µå­å›´æ  - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* --- 1. å…¨å±€æš—é»‘ä¸»é¢˜å˜é‡ (ä¸é¦–é¡µç»Ÿä¸€) --- */
        :root {
            --bg-color: #1e1e2d;         /* æ·±è“é»‘èƒŒæ™¯ */
            --sidebar-bg: #151521;       /* ä¾§è¾¹æ èƒŒæ™¯ */
            --card-bg: #2b2b40;          /* å¡ç‰‡/å·¥å…·æ èƒŒæ™¯ */
            --text-primary: #e1e1e6;     /* ä¸»æ–‡å­— */
            --text-secondary: #a2a2b8;   /* æ¬¡æ–‡å­— */
            --accent-purple: #7367f0;    /* å¼ºè°ƒè‰²ï¼šç´« */
            --accent-blue: #00cfe8;      /* å¼ºè°ƒè‰²ï¼šè“ */
            --border-color: rgba(255,255,255,0.08);
        }

        body { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; background-color: var(--bg-color); color: var(--text-primary); }

        /* --- 2. å·¦ä¾§ä¾§è¾¹æ  (æ”¯æŒæ‹–æ‹½) --- */
        .sidebar {
            width: 320px;
            min-width: 240px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            position: relative; /* å…³é”®ï¼šä¸ºäº†å®šä½æ‹–æ‹½æ¡ */
            z-index: 10;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--sidebar-bg); }
        .sidebar-title { margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px; }

        /* ğŸš€ æ ¸å¿ƒï¼šæ‹–æ‹½æ¡æ ·å¼ */
        .resizer {
            width: 6px;
            height: 100%;
            background: transparent;
            position: absolute;
            right: 0;
            top: 0;
            cursor: col-resize;
            z-index: 20;
            transition: background 0.2s;
        }
        .resizer:hover, .resizer.active {
            background: var(--accent-blue); /* é¼ æ ‡æ”¾ä¸Šå»å˜äº®è“ */
        }

        /* ç…§ç‰‡åˆ—è¡¨æ ·å¼ */
        #photo-list { flex: 1; overflow-y: auto; padding: 10px; }
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        #photo-list::-webkit-scrollbar { width: 6px; }
        #photo-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        #photo-list::-webkit-scrollbar-track { background: transparent; }

        .photo-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: var(--card-bg); border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; border: 1px solid transparent; }
        .photo-item:hover { background: rgba(115, 103, 240, 0.15); border-color: var(--accent-purple); }
        .photo-item img { width: 60px; height: 60px; object-fit: cover; margin-right: 12px; border-radius: 6px; border: 1px solid var(--border-color); }
        .photo-info { font-size: 12px; color: var(--text-secondary); overflow: hidden; }
        .photo-name { font-weight: bold; color: var(--text-primary); margin-bottom: 4px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; }

        /* --- 3. å³ä¾§ä¸»åŒºåŸŸ --- */
        .main { flex: 1; position: relative; display: flex; flex-direction: column; min-width: 0; background: var(--bg-color); }

        .toolbar { padding: 0 20px; background: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; gap: 15px; align-items: center; height: 60px; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .input-group { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-secondary); }

        /* ç”»å¸ƒå®¹å™¨ */
        #canvas-container { flex: 1; position: relative; margin: 20px; background: #1e1e2d; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: inset 0 0 30px rgba(0,0,0,0.5); }

        /* ç”»å¸ƒä¸Šçš„ç‚¹ */
        .point-marker { position: absolute; width: 14px; height: 14px; background: var(--accent-purple); border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; border: 2px solid white; box-shadow: 0 0 10px var(--accent-purple); z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; }
        .point-marker:hover { transform: translate(-50%, -50%) scale(1.3); background: var(--accent-blue); }

        .empty-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); pointer-events: none; }

        /* --- 4. Element UI æš—é»‘æ ·å¼å¼ºåŠ›è¦†ç›– --- */
        .el-input__inner { background-color: #151521 !important; border-color: var(--border-color) !important; color: white !important; }
        .el-select-dropdown { background-color: var(--card-bg) !important; border-color: var(--border-color) !important; }
        .el-select-dropdown__item { color: var(--text-secondary) !important; }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover { background-color: rgba(255,255,255,0.05) !important; }
        /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
        .el-button--default { background: transparent !important; border: 1px solid var(--text-secondary) !important; color: var(--text-secondary) !important; }
        .el-button--default:hover { color: var(--accent-blue) !important; border-color: var(--accent-blue) !important; }
        .el-button--primary { background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)) !important; border: none !important; color: white !important; }
        .el-button--danger { background: rgba(234, 84, 85, 0.2) !important; color: #ea5455 !important; border: 1px solid #ea5455 !important; }
        .el-button--success { background: linear-gradient(45deg, #28c76f, #48da89) !important; border: none !important; color: white !important; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="resizer" id="dragMe" title="æ‹–åŠ¨æ”¹å˜å®½åº¦"></div>

    <div class="sidebar-header">
        <h3 class="sidebar-title"><i class="el-icon-camera"></i> æ‹ç‚¹ç…§ç‰‡é€‰æ‹©</h3>
        <p style="font-size:12px; color:var(--text-secondary); margin:5px 0 15px 0;">å‹¾é€‰ä»£è¡¨å»ºç­‘ç‰©é¡¶è§’çš„ç…§ç‰‡</p>

        <div>
            <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:8px;">ğŸ“‚ ä»»åŠ¡ç­›é€‰ï¼š</label>
            <select id="folderSelect" style="width:100%; padding:8px; background:#151521; color:white; border:1px solid rgba(255,255,255,0.1); border-radius:4px; outline:none;" onchange="filterPhotosByFolder()">
                <option value="all">åŠ è½½ä¸­...</option>
            </select>
        </div>
    </div>

    <div id="photo-list">
        <div style="text-align:center; margin-top:40px; color:var(--text-secondary);">
            <i class="el-icon-loading"></i> æ•°æ®åŠ è½½ä¸­...
        </div>
    </div>
</div>

<div class="main">
    <div class="toolbar">
        <div class="input-group">
            <label>ID:</label>
            <el-input v-model="projectId" size="mini" disabled style="width: 50px;"></el-input>
        </div>

        <el-divider direction="vertical"></el-divider>

        <div class="input-group">
            <label>ğŸ  æ¥¼æ ‹åç§°:</label>
            <el-input v-model="buildingName" placeholder="å¦‚: 1å·æ¥¼" size="small" style="width: 150px;"></el-input>
        </div>

        <div style="flex:1"></div>

        <el-button size="small" icon="el-icon-refresh" @click="initPage">åˆ·æ–°</el-button>
        <el-button type="danger" size="small" icon="el-icon-delete" @click="resetSelection">é‡ç½®</el-button>
        <el-button type="success" size="small" icon="el-icon-check" @click="saveBoundary">ä¿å­˜å›´æ </el-button>

        <el-divider direction="vertical"></el-divider>
        <el-button size="small" icon="el-icon-s-home" @click="goHome">è¿”å›é¦–é¡µ</el-button>
    </div>

    <div id="canvas-container">
        <div class="empty-tip" v-if="selectedPhotos.length === 0">
            <i class="el-icon-edit-outline" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>è¯·åœ¨å·¦ä¾§å‹¾é€‰ç…§ç‰‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿çº¿ç”Ÿæˆå›´æ </p>
        </div>
        <svg id="svg-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 5;"></svg>
        <svg id="svg-existing-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 1;"></svg>
    </div>
</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>

<script>
    // ==========================================
    // 1. æ‹–æ‹½ä¾§è¾¹æ é€»è¾‘ (åŸç”Ÿ JS)
    // ==========================================
    const resizer = document.getElementById('dragMe');
    const sidebar = document.getElementById('sidebar');
    let x = 0;
    let w = 0;

    const mouseDownHandler = function(e) {
        x = e.clientX;
        const sbWidth = window.getComputedStyle(sidebar).width;
        w = parseInt(sbWidth, 10);
        resizer.classList.add('active'); // é«˜äº®æ˜¾ç¤º
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
    };

    const mouseMoveHandler = function(e) {
        const dx = e.clientX - x;
        sidebar.style.width = `${w + dx}px`;
    };

    const mouseUpHandler = function() {
        resizer.classList.remove('active');
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
        // æ‹–æ‹½ç»“æŸåï¼Œè§¦å‘ä¸€æ¬¡çª—å£resizeï¼Œå¼ºåˆ¶é‡ç»˜ç”»å¸ƒ
        window.dispatchEvent(new Event('resize'));
    };

    resizer.addEventListener('mousedown', mouseDownHandler);

    // ==========================================
    // 2. Vue å®ä¾‹ (æ¥ç®¡å³ä¾§å·¥å…·æ å’Œå¼¹çª—)
    // ==========================================
    new Vue({
        el: '.main',
        data: {
            projectId: 1,
            buildingName: '',
            selectedPhotos: [] // ç”¨äºæ§åˆ¶ç©ºçŠ¶æ€æç¤ºçš„æ˜¾ç¤º
        },
        mounted() {
            // è·å–é¡¹ç›®ID
            const pid = localStorage.getItem('currentProjectId');
            if(pid) this.projectId = pid;

            // æš´éœ²ç»™å…¨å±€å‡½æ•°è°ƒç”¨
            window.vueInstance = this;

            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿é¡µé¢æ¸²æŸ“å®Œæ¯•
            setTimeout(initPage, 300);
        },
        methods: {
            initPage() { initPage(); },
            resetSelection() { resetSelection(); },
            saveBoundary() { saveBoundary(); },
            goHome() { window.location.href = 'index.html'; }
        }
    });

    // ==========================================
    // 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å¤ç”¨ä¹‹å‰éªŒè¯æˆåŠŸçš„ä»£ç )
    // ==========================================
    let allPhotos = [];
    let selectedPhotos = [];
    let existingBuildings = [];
    let folderNames = new Set();

    // å¤„ç† Token
    let token = localStorage.getItem('token');
    if (token && !token.startsWith('Bearer ')) token = 'Bearer ' + token;

    // åŒæ­¥çŠ¶æ€ç»™ Vue (ç”¨äºæ˜¾ç¤º/éšè—ç©ºæç¤º)
    function updateVueState() {
        if(window.vueInstance) window.vueInstance.selectedPhotos = selectedPhotos;
    }

    async function initPage() {
        await loadPhotos();
        await loadExistingBuildings();
    }

    async function loadPhotos() {
        const projectId = localStorage.getItem('currentProjectId') || 1;
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '<div style="text-align:center;margin-top:20px;color:#999"><i class="el-icon-loading"></i> åŠ è½½ä¸­...</div>';

        try {
            const res = await fetch(`/api/projects/${projectId}/photos`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();

            // âœ… æ ¸å¿ƒä¿®å¤ï¼šå…¼å®¹ status/code
            const code = json.code !== undefined ? json.code : json.status;

            if (code === 200 && json.data) {
                allPhotos = json.data;
                extractFolders(allPhotos);
                filterPhotosByFolder();
            } else {
                listDiv.innerHTML = `<p style="padding:10px; color:#ea5455; text-align:center;">${json.message || 'åŠ è½½å¤±è´¥'}</p>`;
                document.getElementById('folderSelect').innerHTML = '<option value="all">æ— æ•°æ®</option>';
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<p style="padding:10px; color:#ea5455; text-align:center;">ç½‘ç»œè¯·æ±‚é”™è¯¯</p>';
        }
    }

    function extractFolders(photos) {
        folderNames.clear();
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="all">ğŸ“‚ æ˜¾ç¤ºå…¨éƒ¨ç…§ç‰‡</option>';

        photos.forEach(p => {
            if (p.photoUrl) {
                const parts = decodeURIComponent(p.photoUrl).split('/');
                if (parts.length >= 3) {
                    let folder = parts[parts.length - 2];
                    // è¿‡æ»¤å¤§ç–†ç”Ÿæˆçš„å­æ–‡ä»¶å¤¹
                    if (['Remote-Control','origin','Photos'].includes(folder)) folder = parts[parts.length - 3];
                    if (folder && folder !== 'projects') folderNames.add(folder);
                }
            }
        });

        folderNames.forEach(folder => {
            const op = document.createElement('option');
            op.value = folder; op.innerText = "ğŸ“ " + folder;
            select.appendChild(op);
        });

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        if (folderNames.size > 0) select.value = folderNames.values().next().value;
    }

    function filterPhotosByFolder() {
        const sel = document.getElementById('folderSelect').value;
        const filtered = (sel === 'all') ? allPhotos : allPhotos.filter(p => decodeURIComponent(p.photoUrl||'').includes(sel));
        renderPhotoList(filtered);
    }

    function renderPhotoList(photos) {
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '';
        if (photos.length === 0) { listDiv.innerHTML = '<p style="text-align:center;color:#666;margin-top:20px">æš‚æ— ç…§ç‰‡</p>'; return; }

        photos.forEach(p => {
            if(!p.gpsLat) return;
            const isChecked = selectedPhotos.some(s => s.id == p.id) ? 'checked' : '';
            const name = p.photoUrl ? p.photoUrl.split('/').pop() : 'æœªçŸ¥æ–‡ä»¶';

            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <input type="checkbox" style="margin-right:10px; transform:scale(1.2);" ${isChecked} onchange="togglePhoto('${p.id}', ${p.gpsLat}, ${p.gpsLng}, this)">
                <img src="${p.photoUrl}" onerror="this.src='https://via.placeholder.com/60/333/999?text=IMG'">
                <div class="photo-info">
                    <span class="photo-name" title="${name}">${name}</span>
                    <div style="color:var(--text-secondary)">ğŸ“… ${p.shootTime ? p.shootTime.replace('T',' ') : '-'}</div>
                </div>`;
            listDiv.appendChild(div);
        });
    }

    async function loadExistingBuildings() {
        const pid = localStorage.getItem('currentProjectId') || 1;
        try {
            const res = await fetch(`/api/buildings/list?projectId=${pid}`, { headers: { 'Authorization': token } });
            const json = await res.json();
            if ((json.code||json.status) === 200) { existingBuildings = json.data; drawCanvas(); }
        } catch(e){}
    }

    window.togglePhoto = function(id, lat, lng, cb) {
        if(cb.checked) selectedPhotos.push({id, lat, lng}); else selectedPhotos = selectedPhotos.filter(p=>p.id!=id);
        updateVueState(); drawCanvas();
    }

    window.resetSelection = function() {
        selectedPhotos = [];
        document.querySelectorAll('#photo-list input').forEach(c=>c.checked=false);
        updateVueState(); drawCanvas();
    }

    window.drawCanvas = function() {
        const container = document.getElementById('canvas-container');
        document.querySelectorAll('.point-marker').forEach(e => e.remove());
        const svg = document.getElementById('svg-layer');
        const existSvg = document.getElementById('svg-existing-layer');
        svg.innerHTML = ''; existSvg.innerHTML = '';

        let lats = selectedPhotos.map(p=>p.lat), lngs = selectedPhotos.map(p=>p.lng);
        existingBuildings.forEach(b => {
            if(b.boundaryCoords) JSON.parse(b.boundaryCoords).forEach(c=>{lats.push(c.lat);lngs.push(c.lng)});
        });

        if(lats.length===0) { updateVueState(); return; }

        // åŠ¨æ€ç¼©æ”¾
        const minLat=Math.min(...lats), maxLat=Math.max(...lats), minLng=Math.min(...lngs), maxLng=Math.max(...lngs);
        const pad = Math.max(maxLat-minLat, maxLng-minLng)*0.1 || 0.0001;
        const width = container.clientWidth, height = container.clientHeight;
        const toScreen = (lat, lng) => ({
            x: ((lng - (minLng-pad)) / ((maxLng+pad)-(minLng-pad))) * width,
            y: height - ((lat - (minLat-pad)) / ((maxLat+pad)-(minLat-pad))) * height
        });

        // ç”»å·²æœ‰æ¥¼æ ‹ (ç»¿è‰²è™šçº¿)
        existingBuildings.forEach(b=>{
            if(b.boundaryCoords) {
                const pts = JSON.parse(b.boundaryCoords).map(c=>{const s=toScreen(c.lat,c.lng);return `${s.x},${s.y}`}).join(' ');
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                poly.setAttribute("points", pts);
                poly.setAttribute("style", "fill:rgba(40, 199, 111, 0.2); stroke:#28c76f; stroke-width:2; stroke-dasharray:5,5;");
                existSvg.appendChild(poly);
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const s = toScreen(JSON.parse(b.boundaryCoords)[0].lat, JSON.parse(b.boundaryCoords)[0].lng);
                txt.setAttribute("x",s.x); txt.setAttribute("y",s.y-10); txt.setAttribute("fill","#28c76f"); txt.textContent=b.name;
                existSvg.appendChild(txt);
            }
        });

        // ç”»å½“å‰é€‰åŒº (ç´«è‰²å®çº¿)
        if(selectedPhotos.length>=2) {
            const pts = selectedPhotos.map(p=>{const s=toScreen(p.lat,p.lng);return `${s.x},${s.y}`}).join(' ');
            const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            poly.setAttribute("points", pts);
            poly.setAttribute("style", "fill:rgba(115, 103, 240, 0.2); stroke:#7367f0; stroke-width:2;");
            svg.appendChild(poly);
        }

        // ç”»ç‚¹
        selectedPhotos.forEach((p,i)=>{
            const s = toScreen(p.lat,p.lng);
            const dot = document.createElement('div'); dot.className='point-marker';
            dot.style.left=s.x+'px'; dot.style.top=s.y+'px'; dot.innerText=i+1;
            dot.onclick=()=>{ document.querySelector(`input[onchange*="'${p.id}'"]`).click(); };
            container.appendChild(dot);
        });
        updateVueState();
    }

    window.saveBoundary = async function() {
        if(selectedPhotos.length<3) { window.vueInstance.$message.warning("è‡³å°‘3ä¸ªç‚¹"); return; }
        if(!window.vueInstance.buildingName) { window.vueInstance.$message.warning("è¯·è¾“å…¥æ¥¼å"); return; }
        try {
            const pid = localStorage.getItem('currentProjectId');
            const res = await fetch(`/api/projects/${pid}/boundary?buildingName=${window.vueInstance.buildingName}`, {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':token},
                body:JSON.stringify(selectedPhotos.map(p=>({lat:p.lat,lng:p.lng})))
            });
            const json = await res.json();
            if((json.code||json.status)===200) {
                window.vueInstance.$message.success("ä¿å­˜æˆåŠŸ");
                loadExistingBuildings(); resetSelection();
            } else window.vueInstance.$message.error(json.message);
        } catch(e){ window.vueInstance.$message.error("è¯·æ±‚å¤±è´¥"); }
    }

    window.onresize = drawCanvas;
</script>
</body>
</html>