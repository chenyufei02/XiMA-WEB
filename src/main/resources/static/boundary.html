<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®šä¹‰ç”µå­å›´æ  - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* =========================================================
           1. å…¨å±€æ·±è‰²ä¸»é¢˜å˜é‡å®šä¹‰ (ä¿æŒåŸæ ·)
           ========================================================= */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --border-color: rgba(255,255,255,0.08);
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* =========================================================
           2. ä¾§è¾¹æ æ ·å¼ (æ‹–æ‹½ã€åˆ—è¡¨)
           ========================================================= */
        .sidebar {
            width: 320px;
            min-width: 240px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
        }

        /* ğŸ”´ ä¿®å¤ï¼šå°†æ‹–æ‹½æ¡å®Œå…¨ç§»å‡ºä¾§è¾¹æ ï¼Œé¿å…é®æŒ¡æ»šåŠ¨æ¡ */
        .resizer {
            width: 12px; /*ç¨å¾®åŠ å®½ï¼Œæ›´å¥½æŠ“å–*/
            height: 100%;
            background: transparent;
            position: absolute;
            right: -12px; /* ğŸ”´ å…³é”®ä¿®æ”¹ï¼šå®Œå…¨ç§»åˆ°å³ä¾§å¤–éƒ¨ï¼Œä¸å å†…éƒ¨ç©ºé—´ */
            top: 0;
            cursor: col-resize;
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            transition: background 0.2s;
        }
        /* æ‹–æ‹½æ—¶æˆ–æ‚¬åœæ—¶æ˜¾ç¤ºè“è‰²æç¤ºæ¡ */
        .resizer:hover, .resizer:active {
            background: rgba(0, 207, 232, 0.3);
        }

        #photo-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            /* ç¡®ä¿æ»šåŠ¨æ¡åœ¨å³ä¾§è¾¹ç¼˜ */
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #photo-list::-webkit-scrollbar { width: 6px; }
        #photo-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        /* é˜²æ­¢æ»šåŠ¨æ¡ä¸å†…å®¹é‡å  */
        #photo-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .photo-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .photo-item:hover {
            background: rgba(115, 103, 240, 0.15);
            border-color: var(--accent-purple);
        }
        .photo-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .photo-info {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            flex: 1;
        }
        .photo-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* =========================================================
           3. ä¸»æ“ä½œåŒºæ ·å¼ (ç”»å¸ƒã€å·¥å…·æ )
           ========================================================= */
        .main {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-color);
        }

        .toolbar {
            padding: 0 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            align-items: center;
            height: 60px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #canvas-container {
            flex: 1;
            position: relative;
            margin: 20px;
            background: #1e1e2d;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        /* é€‰ç‚¹æ ‡è®° (é»˜è®¤çŠ¶æ€ï¼šç°è‰²å°ç‚¹) */
        .point-marker {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.2s;
        }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* =========================================================
           4. Element UI æš—é»‘æ¨¡å¼æ·±åº¦é€‚é…
           ========================================================= */
        .el-input__inner {
            background-color: #151521 !important;
            border-color: var(--border-color) !important;
            color: white !important;
        }
        .el-select-dropdown {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }
        .el-select-dropdown__item {
            color: var(--text-secondary) !important;
        }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover {
            background-color: rgba(255,255,255,0.05) !important;
        }

        /* å¼¹çª—æ ·å¼é€‚é… */
        .el-dialog {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        .el-dialog__title {
            color: var(--text-primary) !important;
        }
        .el-dialog__body {
            color: var(--text-primary) !important;
            padding: 20px 30px !important;
        }
        .el-form-item__label {
            color: var(--text-secondary) !important;
        }

        /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
        .el-button--default {
            background: transparent !important;
            border: 1px solid var(--text-secondary) !important;
            color: var(--text-secondary) !important;
            cursor: pointer !important; /* ğŸ”´ å¼ºåˆ¶æ‰‹å‹å…‰æ ‡ */
        }
        .el-button--default:hover {
            color: var(--accent-blue) !important;
            border-color: var(--accent-blue) !important;
        }
        .el-button--primary {
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)) !important;
            border: none !important;
            color: white !important;
            cursor: pointer !important; /* ğŸ”´ å¼ºåˆ¶æ‰‹å‹å…‰æ ‡ */
        }
        .el-button--success {
            background: linear-gradient(45deg, #28c76f, #48da89) !important;
            border: none !important;
            color: white !important;
            cursor: pointer !important;
        }
        .el-button--danger {
            background: rgba(234, 84, 85, 0.2) !important;
            color: #ea5455 !important;
            border: 1px solid #ea5455 !important;
            cursor: pointer !important; /* ğŸ”´ å¼ºåˆ¶æ‰‹å‹å…‰æ ‡ */
        }
        .el-tag--dark { border-color: transparent; }

        /* é˜²æ­¢æ–‡å­—é€‰ä¸­ï¼Œä¼˜åŒ–æŒ‰é’®ä½“éªŒ */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* =========================================================
           5. åº•å›¾äº¤äº’å¢å¼ºæ ·å¼ (ç”¨äºå®ç°ç‚¹å‡»ä¿®æ”¹åŠŸèƒ½)
           ========================================================= */
        .building-label {
            cursor: pointer;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            transition: all 0.2s;
        }
        .building-label:hover {
            fill: #fff !important;
            text-decoration: underline;
            font-size: 14px;
        }

        .building-polygon {
            cursor: pointer;
            transition: all 0.2s;
        }
        .building-polygon:hover {
            stroke: #fff !important;
            stroke-width: 2 !important;
            fill-opacity: 0.3 !important;
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="resizer" id="dragMe"></div>
    <div class="sidebar-header">
        <h3 style="margin:0 0 10px 0; color:var(--text-primary); display:flex; align-items:center;">
            <i class="el-icon-camera-solid" style="margin-right:8px; color:var(--accent-purple);"></i> æ‹ç‚¹ç…§ç‰‡é€‰æ‹©
        </h3>
        <p style="font-size:12px; color:var(--text-secondary); margin:5px 0 15px 0;">ç¬¬ä¸€æ­¥ï¼šå‹¾é€‰ä»£è¡¨å»ºç­‘ç‰©é¡¶è§’çš„ç…§ç‰‡<br>ç¬¬äºŒæ­¥ï¼šåœ¨å³ä¾§åœ°å›¾ä¸Šä¾æ¬¡ç‚¹å‡»ç‚¹ä½è¿çº¿</p>

        <div>
            <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:8px;">ğŸ“‚ ä»»åŠ¡æ–‡ä»¶å¤¹ç­›é€‰ï¼š</label>
            <select id="folderSelect" style="width:100%; padding:8px; background:#151521; color:white; border:1px solid rgba(255,255,255,0.1); border-radius:4px; outline:none;" onchange="filterPhotosByFolder()">
                <option value="all">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px;">
            <el-button type="primary" size="mini" plain style="width:50%; cursor: pointer !important;" class="no-select" onclick="window.vueInstance.selectAllInFolder()">
                <i class="el-icon-check"></i> å…¨é€‰å½“å‰
            </el-button>
            <el-button type="danger" size="mini" plain style="width:50%; cursor: pointer !important;" class="no-select" onclick="window.vueInstance.clearSelection()">
                <i class="el-icon-close"></i> å–æ¶ˆå…¨é€‰
            </el-button>
        </div>
    </div>

    <div id="photo-list">
        <div style="text-align:center; margin-top:40px; color:var(--text-secondary);">
            <i class="el-icon-loading"></i> æ•°æ®åŠ è½½ä¸­...
        </div>
    </div>
</div>

<div class="main">
    <div class="toolbar">
        <div class="input-group">
            <i class="el-icon-folder-opened"></i>
            <label>å½“å‰é¡¹ç›®ID:</label>
            <el-tag size="small" type="info" effect="dark">{{ projectId }}</el-tag>
        </div>

        <div style="flex:1"></div>

        <el-button size="small" icon="el-icon-refresh" @click="initPage">åˆ·æ–°æ•°æ®</el-button>
        <el-button type="danger" size="small" icon="el-icon-delete" @click="resetSelection" :disabled="selectedPhotos.length===0">æ¸…ç©ºç”»å¸ƒ</el-button>

        <el-button type="success" size="small" icon="el-icon-check" @click="openSaveDialog" :disabled="fenceSequence.length<3">ä¿å­˜å›´æ </el-button>

        <el-button
            type="primary"
            size="small"
            icon="el-icon-cpu"
            :loading="calculating"
            @click="handleRecalculate"
            style="background: var(--accent-purple); border:none;">
            æ‰‹åŠ¨é‡ç®—è¿›åº¦
        </el-button>

        <el-divider direction="vertical"></el-divider>

        <el-button size="small" icon="el-icon-back" @click="goBack" v-if="isProjectMode">è¿”å›çœ‹æ¿</el-button>
        <el-button size="small" icon="el-icon-s-home" @click="goHome">è¿”å›é¦–é¡µ</el-button>
    </div>

    <div id="canvas-container">
        <div class="empty-tip" v-if="selectedPhotos.length === 0">
            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"><i class="el-icon-edit-outline"></i></div>
            <p>1. è¯·å…ˆåœ¨å·¦ä¾§ã€Œå…¨é€‰ã€æˆ–å‹¾é€‰ç…§ç‰‡åŠ è½½ç‚¹ä½</p>
            <p>2. ç„¶ååœ¨åœ°å›¾ä¸Šä¾æ¬¡ç‚¹å‡»ç°è‰²ç‚¹ä½è¿›è¡Œè¿çº¿</p>
            <p style="font-size:12px; opacity:0.6; margin-top:10px; color:var(--accent-green);">(æç¤ºï¼šç‚¹å‡»åº•å›¾ä¸­çš„ç»¿è‰²æ¥¼æ ‹åï¼Œå¯ä»¥ä¿®æ”¹å‘½åæˆ–ç»‘å®šè®¡åˆ’)</p>
        </div>

        <svg id="svg-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 5;"></svg>

        <svg id="svg-existing-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 1;"></svg>
    </div>

    <el-dialog :title="editMode ? 'ç¼–è¾‘æ¥¼æ ‹ä¿¡æ¯' : 'ä¿å­˜ç”µå­å›´æ '" :visible.sync="saveDialogVisible" width="480px" :close-on-click-modal="false" append-to-body>
        <div style="margin-bottom:20px; color:var(--text-secondary); font-size:13px; background:rgba(115,103,240,0.1); padding:10px; border-radius:4px;">
            <i class="el-icon-info"></i> {{ editMode ? 'åœ¨è¿™é‡Œä¿®æ”¹æ¥¼æ ‹åç§°æˆ–é‡æ–°å…³è”è®¡åˆ’æ¨¡å‹ã€‚' : 'ä¿å­˜åï¼Œè¯·é€‰æ‹©è¯¥å›´æ å¯¹åº”çš„ BIM æ¨¡å‹æ¥¼å·ï¼Œä»¥ä¾¿ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æ–½å·¥è¿›åº¦ã€‚' }}
        </div>

        <el-form :model="saveForm" label-width="100px" size="small">
            <el-form-item label="æ¥¼æ ‹å‘½å" required>
                <el-input v-model="saveForm.name" placeholder="ä¾‹å¦‚ï¼šç»¼åˆæ•™å­¦æ¥¼"></el-input>
            </el-form-item>

            <el-form-item label="å…³è”è®¡åˆ’">
                <el-select v-model="saveForm.plan" placeholder="è¯·é€‰æ‹©å¯¹åº”æ¨¡å‹" style="width:100%" clearable>
                    <el-option label="æš‚ä¸ç»‘å®š (ä»…ä¿å­˜å›´æ )" value=""></el-option>
                    <el-option v-for="item in planOptions" :key="item" :label="'ğŸ—ï¸ æ¨¡å‹: ' + item + 'å·æ¥¼'" :value="item"></el-option>
                </el-select>
            </el-form-item>
        </el-form>

        <span slot="footer" class="dialog-footer" style="display:flex; justify-content:space-between; align-items:center;">
            <div v-if="editMode">
                <el-popconfirm title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¥¼æ ‹å—ï¼Ÿ" icon="el-icon-info" icon-color="red" @confirm="deleteCurrentBuilding">
                    <el-button slot="reference" type="text" style="color:var(--accent-red)">åˆ é™¤æ­¤æ¥¼æ ‹</el-button>
                </el-popconfirm>
            </div>
            <div v-else></div> <div>
                <el-button @click="saveDialogVisible = false" size="small">å– æ¶ˆ</el-button>
                <el-button type="primary" @click="confirmSave" :loading="saving" size="small" icon="el-icon-check">
                    {{ editMode ? 'æ›´æ–°ä¿¡æ¯' : 'ç¡®è®¤ä¿å­˜' }}
                </el-button>
            </div>
        </span>
    </el-dialog>

</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    // ==========================================
    // 1. ä¾§è¾¹æ æ‹–æ‹½é€»è¾‘ (å®Œæ•´ä¿ç•™)
    // ==========================================
    const resizer = document.getElementById('dragMe');
    const sidebar = document.getElementById('sidebar');
    let x = 0, w = 0;

    resizer.addEventListener('mousedown', e => {
        x = e.clientX;
        w = parseInt(window.getComputedStyle(sidebar).width, 10);
        document.addEventListener('mousemove', mouseMove);
        document.addEventListener('mouseup', mouseUp);
    });

    const mouseMove = e => sidebar.style.width = `${w + e.clientX - x}px`;

    const mouseUp = () => {
        document.removeEventListener('mousemove', mouseMove);
        document.removeEventListener('mouseup', mouseUp);
        window.dispatchEvent(new Event('resize')); // è§¦å‘ç”»å¸ƒé‡ç»˜
    };

    // ==========================================
    // 2. Vue æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    // ==========================================
    new Vue({
        el: '.main',
        data: {
            projectId: 1,
            selectedPhotos: [], // ğŸ”´ ä»…ç”¨äºå­˜å‚¨"å¯è§çš„å€™é€‰ç‚¹"(Pool)ï¼Œä¸ä»£è¡¨è¿çº¿é¡ºåº
            fenceSequence: [],  // ğŸ”´ æ–°å¢ï¼šç”¨äºå­˜å‚¨"å®é™…è¿çº¿çš„æœ‰åºID"(Path)

            // å¼¹çª—æ§åˆ¶
            saveDialogVisible: false,
            saving: false,
            calculating: false, // è®¡ç®—loadingçŠ¶æ€

            // ç¼–è¾‘çŠ¶æ€æ§åˆ¶
            editMode: false,
            currentEditId: null,

            // è¡¨å•æ•°æ®
            planOptions: [],
            saveForm: {
                name: '',
                plan: ''
            },

            // âœ… æ–°å¢ï¼šä¾§è¾¹æ æ¨¡å¼åˆ¤æ–­
            isProjectMode: false
        },
        mounted() {
            // ä» LocalStorage è·å–å½“å‰é¡¹ç›®ID
            const pid = localStorage.getItem('currentProjectId');
            const fromDash = localStorage.getItem('fromDashboard');

            if(pid) this.projectId = pid;
            if(fromDash === 'true') this.isProjectMode = true;

            // æš´éœ²ç»™å…¨å±€ä»¥ä¾¿åŸç”ŸJSè°ƒç”¨
            window.vueInstance = this;

            // åˆå§‹åŒ–æ•°æ®
            setTimeout(initPage, 300);
        },
        methods: {
            initPage() { initPage(); },
            resetSelection() { resetSelection(); },

            // âœ… è¿”å›é€»è¾‘
            goHome() {
                localStorage.removeItem('fromDashboard');
                window.location.href = 'index.html';
            },
            goBack() {
                window.location.href = 'dashboard.html';
            },

            // æ‰‹åŠ¨è§¦å‘è¿›åº¦è®¡ç®—
            handleRecalculate() {
                this.calculating = true;
                const token = localStorage.getItem('token');

                axios.post(`/api/progress/calculate?projectId=${this.projectId}`, {}, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.$message.success("è¿›åº¦é‡ç®—å®Œæˆï¼");
                    } else {
                        this.$message.error(res.data.message || "è®¡ç®—å¤±è´¥");
                    }
                }).catch(err => {
                    this.$message.error("è¯·æ±‚å¤±è´¥");
                }).finally(() => {
                    this.calculating = false;
                });
            },

            // ğŸ”´ æ–°å¢ï¼šå…¨é€‰å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ç…§ç‰‡ (åªåŠ è½½ç‚¹ä½ï¼Œä¸è¿çº¿)
            selectAllInFolder() {
                const sel = document.getElementById('folderSelect').value;
                // æ‰¾å‡ºå½“å‰ç­›é€‰åçš„æ‰€æœ‰ç…§ç‰‡
                const targets = (sel === 'all')
                    ? window.allPhotos
                    : window.allPhotos.filter(p => decodeURIComponent(p.photoUrl || '').includes(sel));

                // å°†å®ƒä»¬å…¨éƒ¨åŠ å…¥"å€™é€‰æ± " (selectedPhotos)ï¼Œä½†æš‚ä¸åŠ å…¥è¿çº¿
                // ä½¿ç”¨ Map å»é‡
                const map = new Map();
                this.selectedPhotos.forEach(p => map.set(p.id, p));
                targets.forEach(p => {
                    if(p.gpsLat) map.set(p.id, { id: p.id, lat: p.gpsLat, lng: p.gpsLng });
                });
                this.selectedPhotos = Array.from(map.values());

                // æ›´æ–°å·¦ä¾§åˆ—è¡¨å‹¾é€‰çŠ¶æ€
                this.$nextTick(() => {
                    const checkboxes = document.querySelectorAll('#photo-list input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = true);
                });

                // è§¦å‘é‡ç»˜
                window.drawCanvas();
                this.$message.success(`å·²åŠ è½½ ${targets.length} ä¸ªç‚¹ä½åˆ°åœ°å›¾ï¼Œè¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ç‚¹ä½è¿›è¡Œè¿çº¿`);
            },

            // ğŸ”´ æ–°å¢ï¼šæ¸…ç©ºæ‰€æœ‰é€‰æ‹©å’Œè¿çº¿
            clearSelection() {
                this.selectedPhotos = [];
                this.fenceSequence = [];

                // æ¸…ç©ºå·¦ä¾§å‹¾é€‰æ¡†
                const checkboxes = document.querySelectorAll('#photo-list input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);

                window.drawCanvas();
            },

            // æ‰“å¼€ä¿å­˜å¯¹è¯æ¡† (æ–°å¢æ¨¡å¼)
            openSaveDialog() {
                // ğŸ”´ ä¿®æ”¹åˆ¤æ–­ï¼šåŸºäºè¿çº¿æ•°é‡åˆ¤æ–­
                if(this.fenceSequence.length < 3) {
                    this.$message.warning("è¯·åœ¨åœ°å›¾ä¸Šè‡³å°‘ç‚¹å‡»è¿æ¥ 3 ä¸ªç‚¹ä»¥æ„æˆé—­åˆåŒºåŸŸ");
                    return;
                }
                this.editMode = false;
                this.currentEditId = null;

                this.loadPlanOptions();

                this.saveForm.name = '';
                this.saveForm.plan = '';
                this.saveDialogVisible = true;
            },

            // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡† (ä¿®æ”¹æ¨¡å¼)
            openEditDialog(building) {
                this.editMode = true;
                this.currentEditId = building.id; // å­˜ä¸‹ ID ç”¨äºæ›´æ–°

                this.loadPlanOptions();

                // å›æ˜¾æ•°æ®
                this.saveForm.name = building.name;
                this.saveForm.plan = building.planBuildingName;
                this.saveDialogVisible = true;
            },

            // åŠ è½½æœªç»‘å®šçš„è®¡åˆ’åˆ—è¡¨
            loadPlanOptions() {
                const token = localStorage.getItem('token');
                axios.get(`/api/buildings/options/unbound-plans?projectId=${this.projectId}`, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    const result = res.data;
                    if((result.code || result.status) === 200) {
                        this.planOptions = result.data;

                        // ç»†èŠ‚ä¼˜åŒ–ï¼šå¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¸”å½“å‰å·²ç»‘å®šçš„è®¡åˆ’ä¸åœ¨"æœªç»‘å®šåˆ—è¡¨"ä¸­
                        // (å› ä¸ºå®ƒå·²ç»è¢«å½“å‰æ¥¼æ ‹ç»‘å®šäº†)ï¼Œå¾—æŠŠå®ƒåŠ å›æ¥æ˜¾ç¤ºï¼Œå¦åˆ™å›æ˜¾ä¼šæ˜¯ç©ºç™½
                        if (this.editMode && this.saveForm.plan && !this.planOptions.includes(this.saveForm.plan)) {
                            this.planOptions.unshift(this.saveForm.plan);
                        }
                    }
                });
            },

            // ç¡®è®¤ä¿å­˜ / æ›´æ–°
            confirmSave() {
                if(!this.saveForm.name) {
                    this.$message.warning("è¯·è¾“å…¥æ¥¼æ ‹åç§°");
                    return;
                }

                this.saving = true;
                const token = localStorage.getItem('token');
                const authHeader = { 'Authorization': token ? 'Bearer ' + token : '', 'Content-Type': 'application/json' };

                if (this.editMode) {
                    // --- æ ¸å¿ƒé€»è¾‘ 1ï¼šç¼–è¾‘æ¨¡å¼ (ä¿æŒä¸å˜) ---
                    axios.post('/api/buildings/bind', {
                        id: this.currentEditId,
                        projectId: this.projectId,
                        displayName: this.saveForm.name,
                        planBuildingName: this.saveForm.plan
                    }, { headers: authHeader }).then(res => {
                        if ((res.data.code || res.data.status) === 200) {
                            this.$message.success("ä¿®æ”¹æˆåŠŸ");
                            this.saveDialogVisible = false;
                            loadExistingBuildings(); // åˆ·æ–°åº•å›¾
                        } else {
                            this.$message.error(res.data.message || "ä¿®æ”¹å¤±è´¥");
                        }
                    }).finally(() => {
                        this.saving = false;
                    });

                } else {
                    // --- æ ¸å¿ƒé€»è¾‘ 2ï¼šæ–°å¢æ¨¡å¼ (ğŸ”´ é‡æ„ï¼šåŸºäº fenceSequence æ’åº) ---

                    // æ„é€ æœ‰åºåæ ‡æ•°ç»„
                    const orderedCoords = this.fenceSequence.map(id => {
                        const p = this.selectedPhotos.find(item => item.id == id);
                        return { lat: p.lat, lng: p.lng };
                    });

                    const payload = {
                        projectId: this.projectId,
                        buildingName: this.saveForm.name,
                        coords: orderedCoords, // ğŸ”´ ä½¿ç”¨æ’åºåçš„åæ ‡
                        photoIds: this.fenceSequence // ğŸ”´ ä½¿ç”¨æ’åºåçš„ID
                    };

                    axios.post('/api/buildings/boundary', payload, {
                        headers: authHeader
                    }).then(res => {
                        const result = res.data;
                        if((result.code || result.status) === 200) {
                            const newBuildingId = result.data;
                            if (this.saveForm.plan) {
                                return axios.post('/api/buildings/bind', {
                                    id: newBuildingId,
                                    projectId: this.projectId,
                                    currentName: this.saveForm.name,
                                    planBuildingName: this.saveForm.plan
                                }, { headers: authHeader });
                            }
                            return Promise.resolve({ data: { code: 200 } });
                        } else {
                            throw new Error(result.message || "å›´æ ä¿å­˜å¤±è´¥");
                        }
                    }).then(res => {
                        if((res.data.code || res.data.status) === 200) {
                            this.$message.success("ä¿å­˜æˆåŠŸï¼");
                            this.saveDialogVisible = false;
                            loadExistingBuildings();
                            this.clearSelection(); // ğŸ”´ ä¿å­˜åæ¸…ç©º
                        }
                    }).catch(err => {
                        this.$message.error(err.message || "è¯·æ±‚å¤±è´¥");
                    }).finally(() => {
                        this.saving = false;
                    });
                }
            },

            // åˆ é™¤æ¥¼æ ‹
            deleteCurrentBuilding() {
                const token = localStorage.getItem('token');
                axios.delete(`/api/buildings/${this.currentEditId}`, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.$message.success("æ¥¼æ ‹å·²åˆ é™¤");
                        this.saveDialogVisible = false;
                        loadExistingBuildings();
                    } else {
                        this.$message.error("åˆ é™¤å¤±è´¥");
                    }
                });
            }
        }
    });

    // ==========================================
    // 3. åŸç”Ÿ JS é€»è¾‘ (è´Ÿè´£ Canvas ç»˜å›¾ä¸æ•°æ®åŠ è½½)
    // ==========================================
    let allPhotos = [];
    let selectedPhotos = []; // åŸç”Ÿå¼•ç”¨
    let existingBuildings = []; // å·²ä¿å­˜çš„æ¥¼æ ‹
    let folderNames = new Set();

    let token = localStorage.getItem('token');
    if (token && !token.startsWith('Bearer ')) token = 'Bearer ' + token;

    function updateVueState() {
        if(window.vueInstance) window.vueInstance.selectedPhotos = selectedPhotos;
    }

    async function initPage() {
        await loadPhotos();
        await loadExistingBuildings(); // åŠ è½½åº•å›¾
    }

    // åŠ è½½å·¦ä¾§ç…§ç‰‡åˆ—è¡¨
    async function loadPhotos() {
        const projectId = localStorage.getItem('currentProjectId') || 1;
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '<div style="text-align:center;margin-top:20px;color:#999"><i class="el-icon-loading"></i> æ­£åœ¨åŠ è½½ç…§ç‰‡...</div>';

        try {
            const res = await fetch(`/api/projects/${projectId}/photos`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();

            if ((json.code || json.status) === 200 && json.data) {
                allPhotos = json.data;
                window.allPhotos = allPhotos; // æš´éœ²ç»™ Vue
                extractFolders(allPhotos);
                filterPhotosByFolder(); // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
            } else {
                listDiv.innerHTML = '<p style="text-align:center">åŠ è½½å¤±è´¥</p>';
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<p style="text-align:center">ç½‘ç»œé”™è¯¯</p>';
        }
    }

    // æå–æ–‡ä»¶å¤¹å
    function extractFolders(photos) {
        folderNames.clear();
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="all">ğŸ“‚ æ˜¾ç¤ºå…¨éƒ¨ç…§ç‰‡</option>';

        photos.forEach(p => {
            if (p.photoUrl) {
                const parts = decodeURIComponent(p.photoUrl).split('/');
                if (parts.length >= 3) {
                    let folder = parts[parts.length - 2];
                    if (['Remote-Control', 'origin', 'Photos'].includes(folder)) {
                        folder = parts[parts.length - 3];
                    }
                    if (folder && folder !== 'projects') folderNames.add(folder);
                }
            }
        });

        folderNames.forEach(f => {
            const op = document.createElement('option');
            op.value = f;
            op.innerText = "ğŸ“ " + f;
            select.appendChild(op);
        });

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹
        if (folderNames.size > 0) {
            select.value = folderNames.values().next().value;
        }
    }

    function filterPhotosByFolder() {
        const sel = document.getElementById('folderSelect').value;
        const filtered = (sel === 'all')
            ? allPhotos
            : allPhotos.filter(p => decodeURIComponent(p.photoUrl || '').includes(sel));
        renderPhotoList(filtered);
    }

    function renderPhotoList(photos) {
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '';

        if (photos.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center;color:#666">è¯¥ç›®å½•ä¸‹æš‚æ— ç…§ç‰‡</p>';
            return;
        }

        photos.forEach(p => {
            if(!p.gpsLat) return; // æ²¡åæ ‡çš„ä¸æ˜¾ç¤º

            // ğŸ”´ ä¿®æ”¹ï¼šå‹¾é€‰çŠ¶æ€åªåæ˜  selectedPhotos (å€™é€‰æ± )
            const isChecked = window.vueInstance.selectedPhotos.some(s => s.id == p.id) ? 'checked' : '';
            const name = p.photoUrl ? p.photoUrl.split('/').pop() : 'æœªçŸ¥æ–‡ä»¶';

            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <input type="checkbox" style="margin-right:10px" ${isChecked} onchange="togglePhoto('${p.id}', ${p.gpsLat}, ${p.gpsLng}, this)">
                <img src="${p.photoUrl}" onerror="this.src='https://via.placeholder.com/60/333/999?text=IMG'">
                <div class="photo-info">
                    <span class="photo-name" title="${name}">${name}</span>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // åŠ è½½å·²å­˜åœ¨çš„å›´æ  (ä½œä¸ºåº•å›¾)
    async function loadExistingBuildings() {
        const pid = localStorage.getItem('currentProjectId') || 1;
        try {
            const res = await fetch(`/api/buildings/list?projectId=${pid}`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();
            if ((json.code || json.status) === 200) {
                existingBuildings = json.data;
                drawCanvas(); // é‡ç»˜
            }
        } catch(e) {}
    }

    // ğŸ”´ ä¿®æ”¹ï¼šå‹¾é€‰/å–æ¶ˆå‹¾é€‰ (åªç®¡ç†å€™é€‰æ± ï¼Œä¸è¿çº¿)
    window.togglePhoto = function(id, lat, lng, cb) {
        if(cb.checked) {
            // åŠ å…¥å€™é€‰æ± 
            if(!window.vueInstance.selectedPhotos.some(p => p.id == id)) {
                window.vueInstance.selectedPhotos.push({id, lat, lng});
            }
        } else {
            // ç§»å‡ºå€™é€‰æ± ï¼ŒåŒæ—¶ä¹Ÿè¦ä»è¿çº¿ä¸­ç§»é™¤
            window.vueInstance.selectedPhotos = window.vueInstance.selectedPhotos.filter(p => p.id != id);
            window.vueInstance.fenceSequence = window.vueInstance.fenceSequence.filter(fid => fid != id);
        }
        drawCanvas();
    }

    window.resetSelection = function() {
        window.vueInstance.clearSelection();
    }

    // ğŸ”´ æ ¸å¿ƒé‡å†™ï¼šç»˜å›¾å‡½æ•°
    window.drawCanvas = function() {
        const container = document.getElementById('canvas-container');
        document.querySelectorAll('.point-marker').forEach(e => e.remove());

        const svg = document.getElementById('svg-layer');
        const existSvg = document.getElementById('svg-existing-layer');
        svg.innerHTML = '';
        existSvg.innerHTML = '';

        const candidates = window.vueInstance.selectedPhotos; // æ‰€æœ‰å¯è§ç‚¹
        const fenceIds = window.vueInstance.fenceSequence;    // å·²è¿çº¿çš„æœ‰åºID

        // 1. è®¡ç®—åæ ‡èŒƒå›´ (åŸºäºæ‰€æœ‰å€™é€‰ç‚¹)
        let lats = candidates.map(p => p.lat);
        let lngs = candidates.map(p => p.lng);

        // ä¹ŸåŒ…å«åº•å›¾çš„èŒƒå›´
        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                JSON.parse(b.boundaryCoords).forEach(c => {
                    lats.push(c.lat);
                    lngs.push(c.lng);
                });
            }
        });

        if(lats.length === 0) return;

        const minLat = Math.min(...lats);
        const maxLat = Math.max(...lats);
        const minLng = Math.min(...lngs);
        const maxLng = Math.max(...lngs);
        const pad = Math.max(maxLat - minLat, maxLng - minLng) * 0.1 || 0.0001;
        const width = container.clientWidth;
        const height = container.clientHeight;

        const toScreen = (lat, lng) => ({
            x: ((lng - (minLng - pad)) / ((maxLng + pad) - (minLng - pad))) * width,
            y: height - ((lat - (minLat - pad)) / ((maxLat + pad) - (minLat - pad))) * height
        });

        // 2. ç»˜åˆ¶å·²å­˜åœ¨çš„æ¥¼æ ‹ (ç»¿è‰²è™šçº¿) - ä¿æŒä¸å˜
        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                const pts = JSON.parse(b.boundaryCoords).map(c => {
                    const s = toScreen(c.lat, c.lng);
                    return `${s.x},${s.y}`;
                }).join(' ');

                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.onclick = () => { window.vueInstance.openEditDialog(b); };

                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                poly.setAttribute("points", pts);
                poly.setAttribute("class", "building-polygon");
                poly.setAttribute("style", "fill:rgba(40, 199, 111, 0.1); stroke:#28c76f; stroke-width:1.5; stroke-dasharray:5,5; cursor:pointer; pointer-events:all;");

                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const firstPt = toScreen(JSON.parse(b.boundaryCoords)[0].lat, JSON.parse(b.boundaryCoords)[0].lng);
                txt.setAttribute("x", firstPt.x);
                txt.setAttribute("y", firstPt.y - 10);
                txt.setAttribute("fill", "#28c76f");
                txt.setAttribute("class", "building-label");
                txt.setAttribute("style", "cursor: pointer; pointer-events: bounding-box;");
                txt.textContent = b.name + " (âœï¸)";
                txt.onclick = (e) => { e.stopPropagation(); window.vueInstance.openEditDialog(b); };

                g.appendChild(poly);
                g.appendChild(txt);
                existSvg.appendChild(g);
            }
        });

        // 3. ç»˜åˆ¶å½“å‰è¿çº¿ (åŸºäº fenceIds çš„é¡ºåº) - ğŸ”´ é‡å†™éƒ¨åˆ†
        if(fenceIds.length >= 2) {
            const pts = fenceIds.map(id => {
                const p = candidates.find(item => item.id == id);
                if(!p) return null;
                const s = toScreen(p.lat, p.lng);
                return `${s.x},${s.y}`;
            }).filter(pt => pt).join(' ');

            const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            poly.setAttribute("points", pts);
            poly.setAttribute("style", "fill:rgba(115, 103, 240, 0.2); stroke:#7367f0; stroke-width:3; stroke-linejoin:round;");
            svg.appendChild(poly);
        }

        // 4. ç»˜åˆ¶æ‰€æœ‰ç‚¹ (åŒºåˆ†çŠ¶æ€) - ğŸ”´ é‡å†™éƒ¨åˆ†
        candidates.forEach(p => {
            const s = toScreen(p.lat, p.lng);
            const dot = document.createElement('div');

            // æ£€æŸ¥è¯¥ç‚¹æ˜¯å¦åœ¨ fenceSequence ä¸­
            const index = fenceIds.indexOf(p.id);
            const isSelected = index !== -1;

            dot.className = 'point-marker';
            dot.style.left = s.x + 'px';
            dot.style.top = s.y + 'px';

            if (isSelected) {
                // é€‰ä¸­çŠ¶æ€ï¼šå¤§çº¢ç‚¹ï¼Œæ˜¾ç¤ºåºå·
                dot.innerText = index + 1;
                dot.style.backgroundColor = '#ea5455'; // çº¢è‰²
                dot.style.zIndex = 100;
                dot.style.transform = 'translate(-50%, -50%) scale(1.2)';
            } else {
                // å€™é€‰çŠ¶æ€ï¼šå°ç°ç‚¹ï¼Œæ— åºå·
                dot.innerText = '';
                dot.style.backgroundColor = '#a2a2b8'; // ç°è‰²
                dot.style.opacity = 0.6;
                dot.style.width = '10px';
                dot.style.height = '10px';
            }

            // ç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢é€‰ä¸­/æœªé€‰ä¸­
            dot.onclick = () => {
                if (isSelected) {
                    // å·²é€‰ -> ç§»é™¤ (å–æ¶ˆè¿çº¿)
                    window.vueInstance.fenceSequence.splice(index, 1);
                } else {
                    // æœªé€‰ -> åŠ å…¥ (è¿çº¿åˆ°æœ«å°¾)
                    window.vueInstance.fenceSequence.push(p.id);
                }
                drawCanvas(); // é‡ç»˜
            };

            container.appendChild(dot);
        });
    }

    window.onresize = drawCanvas;
</script>
</body>
</html>