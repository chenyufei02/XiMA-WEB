<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®šä¹‰ç”µå­å›´æ  - æ‹ç‚¹é€‰æ‹©æ³•</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
        /* å·¦ä¾§ï¼šç…§ç‰‡é€‰æ‹©åŒº */
        .sidebar { width: 300px; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; background: #f9f9f9; }
        .photo-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .photo-item:hover { background: #eef; }
        .photo-item img { width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 4px; }
        .photo-info { font-size: 12px; }

        /* å³ä¾§ï¼šç”»å¸ƒåŒº */
        .main { flex: 1; position: relative; background: #fff; display: flex; flex-direction: column; }
        #canvas-container { flex: 1; position: relative; border: 2px dashed #ddd; margin: 20px; border-radius: 8px; }

        /* ç”»å¸ƒä¸Šçš„ç‚¹ */
        .point-marker {
            position: absolute; width: 14px; height: 14px; background: red; border-radius: 50%;
            transform: translate(-50%, -50%); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }
        .point-marker.selected { background: blue; z-index: 10; }

        .toolbar { padding: 10px 20px; background: #eee; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>ğŸ“¸ 1. é€‰æ‹©æ‹è§’ç…§ç‰‡</h3>
    <p style="font-size:12px; color:#666;">è¯·å‹¾é€‰ä»£è¡¨å»ºç­‘ç‰©è¾¹ç¼˜æ‹è§’çš„ç…§ç‰‡ï¼ˆè‡³å°‘3å¼ ï¼‰</p>
    <div id="photo-list">
        <p>åŠ è½½ä¸­...</p>
    </div>
</div>

<div class="main">
    <div class="toolbar">
        <span>å½“å‰é¡¹ç›®ID: <input type="number" id="projectIdInput" value="1" style="width:50px"></span>
        <button onclick="loadPhotos()">ğŸ”„ åˆ·æ–°ç…§ç‰‡</button>
        <div style="flex:1"></div>
        <button onclick="clearCanvas()">ğŸ—‘ï¸ é‡ç½®ç”»å¸ƒ</button>
        <button onclick="saveBoundary()" style="background: green; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ğŸ’¾ ä¿å­˜å›´æ </button>
    </div>

    <div id="canvas-container">
        <p style="position:absolute; top:45%; left:0; width:100%; text-align:center; color:#ccc; pointer-events: none;">
            é€‰ä¸­å·¦ä¾§ç…§ç‰‡åï¼Œæ­¤å¤„å°†è‡ªåŠ¨æ ¹æ®GPSç”Ÿæˆç›¸å¯¹ä½ç½®å›¾ã€‚<br>
            è¯·æŒ‰é¡ºæ—¶é’ˆç‚¹å‡»çº¢ç‚¹è¿›è¡Œè¿çº¿ã€‚
        </p>
        <svg id="svg-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none;"></svg>
    </div>
</div>

<script>
    let allPhotos = [];
    let selectedPhotos = []; // å­˜ {lat, lng, id}

    // 1. åŠ è½½ç…§ç‰‡
    async function loadPhotos() {
        const projectId = document.getElementById('projectIdInput').value;
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = 'åŠ è½½ä¸­...';

        try {
            const res = await fetch(`/api/projects/${projectId}/photos`);
            const json = await res.json();

            if (json.code === 200 && json.data) {
                allPhotos = json.data;
                renderPhotoList(json.data);
            } else {
                listDiv.innerHTML = 'åŠ è½½å¤±è´¥: ' + (json.message || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = 'ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°';
        }
    }

    function renderPhotoList(photos) {
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '';

        if (photos.length === 0) {
            listDiv.innerHTML = 'æ²¡æœ‰æ‰¾åˆ°ç…§ç‰‡ï¼Œè¯·æ£€æŸ¥å…³é”®å­—è®¾ç½®ã€‚';
            return;
        }

        photos.forEach(p => {
            // æ¨¡æ‹Ÿ GPS æ•°æ® (å› ä¸ºAPIåˆ—è¡¨å¯èƒ½ä¸è¿”å›GPSï¼Œå®é™…é¡¹ç›®å¯èƒ½éœ€è¦å•ç‹¬æŸ¥è¯¦æƒ…)
            // TODO: æ­£å¼ä¸Šçº¿æ—¶ï¼Œè¿™é‡Œå¿…é¡»ä» p.metadata ä¸­è·å–çœŸå® lat/lng
            // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘è¿™é‡Œå…ˆéšæœºç”Ÿæˆä¸€ä¸‹ï¼Œç­‰ä½ ç¡®è®¤æ¥å£èƒ½è¿”å›GPSæˆ‘ä»¬å†æ”¹
            const mockLat = 30.5 + Math.random() * 0.001;
            const mockLng = 114.3 + Math.random() * 0.001;

            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <input type="checkbox" style="margin-right:10px" onchange="togglePhoto('${p.file_id}', ${mockLat}, ${mockLng}, this)">
                <img src="${p.url || '#'}" alt="å›¾">
                <div class="photo-info">
                    <div>${p.name}</div>
                    <div style="color:#999; font-size:10px;">${mockLat.toFixed(5)}, ${mockLng.toFixed(5)}</div>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // 2. å‹¾é€‰/å–æ¶ˆç…§ç‰‡ -> æ›´æ–°ç”»å¸ƒ
    function togglePhoto(id, lat, lng, checkbox) {
        if (checkbox.checked) {
            selectedPhotos.push({id, lat, lng});
        } else {
            selectedPhotos = selectedPhotos.filter(p => p.id !== id);
        }
        drawCanvas();
    }

    // 3. æ ¸å¿ƒç®—æ³•ï¼šæŠŠ GPS æ˜ å°„åˆ° DIV ç”»å¸ƒä¸Š
    function drawCanvas() {
        const container = document.getElementById('canvas-container');
        // æ¸…ç©ºæ—§ç‚¹
        document.querySelectorAll('.point-marker').forEach(e => e.remove());

        if (selectedPhotos.length === 0) return;

        // æ‰¾å‡ºç»çº¬åº¦çš„æœ€å¤§æœ€å°å€¼ï¼Œç¡®å®šç¼©æ”¾æ¯”ä¾‹
        const lats = selectedPhotos.map(p => p.lat);
        const lngs = selectedPhotos.map(p => p.lng);
        const minLat = Math.min(...lats), maxLat = Math.max(...lats);
        const minLng = Math.min(...lngs), maxLng = Math.max(...lngs);

        const latRange = maxLat - minLat || 0.0001; // é˜²æ­¢é™¤ä»¥0
        const lngRange = maxLng - minLng || 0.0001;

        const width = container.clientWidth - 100; // ç•™ç™½
        const height = container.clientHeight - 100;

        selectedPhotos.forEach((p, index) => {
            // å½’ä¸€åŒ–åæ ‡ (0.0 ~ 1.0) -> åƒç´ åæ ‡
            // æ³¨æ„ï¼šçº¬åº¦è¶Šå¤§è¶Šé ä¸Š(yè¶Šå°)ï¼Œæ‰€ä»¥ y è¦åè¿‡æ¥
            const x = ((p.lng - minLng) / lngRange) * width + 50;
            const y = height - ((p.lat - minLat) / latRange) * height + 50;

            const dot = document.createElement('div');
            dot.className = 'point-marker';
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
            dot.innerText = index + 1;
            dot.title = `Lat:${p.lat}, Lng:${p.lng}`;

            // å­˜å‚¨è®¡ç®—åçš„åƒç´ åæ ‡ä¾›è¿çº¿ç”¨
            p.screenX = x;
            p.screenY = y;

            container.appendChild(dot);
        });

        drawPolygon();
    }

    // 4. ç”»è¿çº¿ (SVG)
    function drawPolygon() {
        const svg = document.getElementById('svg-layer');
        if (selectedPhotos.length < 2) {
            svg.innerHTML = '';
            return;
        }

        // ç®€å•æŒ‰å‹¾é€‰é¡ºåºè¿çº¿ (å®é™…å¯èƒ½éœ€è¦ç”¨æˆ·ç‚¹å‡»æ’åºï¼Œè¿™é‡Œå…ˆæ¼”ç¤ºé—­åˆå¤šè¾¹å½¢)
        let pointsStr = selectedPhotos.map(p => `${p.screenX},${p.screenY}`).join(' ');

        svg.innerHTML = `
            <polygon points="${pointsStr}" style="fill:rgba(0,0,255,0.1);stroke:blue;stroke-width:2" />
        `;
    }

    // 5. ä¿å­˜
    async function saveBoundary() {
        if (selectedPhotos.length < 3) {
            alert("è¯·è‡³å°‘é€‰æ‹©3å¼ ç…§ç‰‡æ„æˆä¸€ä¸ªé¢ï¼");
            return;
        }

        const projectId = document.getElementById('projectIdInput').value;
        // æ„é€ ä¼ ç»™åç«¯çš„æ•°æ®ï¼šåªä¼ ç»çº¬åº¦ï¼Œä¸ä¼ å±å¹•åæ ‡
        const coords = selectedPhotos.map(p => ({ lat: p.lat, lng: p.lng }));

        try {
            const res = await fetch(`/api/projects/${projectId}/boundary`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(coords)
            });
            const json = await res.json();
            alert(json.message || 'ä¿å­˜ç»“æœæœªçŸ¥');
        } catch (e) {
            alert('ä¿å­˜å¤±è´¥');
        }
    }

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–é‡ç»˜
    window.onresize = drawCanvas;
</script>

</body>
</html>