<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®šä¹‰ç”µå­å›´æ  - XiMA æ™ºé€ </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* =========================================================
           1. å…¨å±€æ·±è‰²ä¸»é¢˜å˜é‡å®šä¹‰ (ä¿æŒåŸæ ·)
           ========================================================= */
        :root {
            --bg-color: #1e1e2d;
            --sidebar-bg: #151521;
            --card-bg: #2b2b40;
            --text-primary: #e1e1e6;
            --text-secondary: #a2a2b8;
            --accent-purple: #7367f0;
            --accent-blue: #00cfe8;
            --accent-green: #28c76f;
            --accent-red: #ea5455;
            --border-color: rgba(255,255,255,0.08);
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* =========================================================
           2. ä¾§è¾¹æ æ ·å¼ (æ‹–æ‹½ã€åˆ—è¡¨)
           ========================================================= */
        .sidebar {
            width: 320px;
            min-width: 240px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
        }

        /* æ‹–æ‹½æ‰‹æŸ„æ¡ */
        .resizer {
            width: 6px;
            height: 100%;
            background: transparent;
            position: absolute;
            right: 0;
            top: 0;
            cursor: col-resize;
            z-index: 20;
            transition: background 0.2s;
        }
        .resizer:hover, .resizer.active {
            background: var(--accent-blue);
        }

        #photo-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #photo-list::-webkit-scrollbar { width: 6px; }
        #photo-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .photo-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .photo-item:hover {
            background: rgba(115, 103, 240, 0.15);
            border-color: var(--accent-purple);
        }
        .photo-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .photo-info {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            flex: 1;
        }
        .photo-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* =========================================================
           3. ä¸»æ“ä½œåŒºæ ·å¼ (ç”»å¸ƒã€å·¥å…·æ )
           ========================================================= */
        .main {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-color);
        }

        .toolbar {
            padding: 0 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            align-items: center;
            height: 60px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #canvas-container {
            flex: 1;
            position: relative;
            margin: 20px;
            background: #1e1e2d;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        /* é€‰ç‚¹æ ‡è®° (çº¢è‰²åœ†ç‚¹) */
        .point-marker {
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--accent-purple);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px var(--accent-purple);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* =========================================================
           4. Element UI æš—é»‘æ¨¡å¼æ·±åº¦é€‚é…
           ========================================================= */
        .el-input__inner {
            background-color: #151521 !important;
            border-color: var(--border-color) !important;
            color: white !important;
        }
        .el-select-dropdown {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }
        .el-select-dropdown__item {
            color: var(--text-secondary) !important;
        }
        .el-select-dropdown__item.hover, .el-select-dropdown__item:hover {
            background-color: rgba(255,255,255,0.05) !important;
        }

        /* å¼¹çª—æ ·å¼é€‚é… */
        .el-dialog {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        .el-dialog__title {
            color: var(--text-primary) !important;
        }
        .el-dialog__body {
            color: var(--text-primary) !important;
            padding: 20px 30px !important;
        }
        .el-form-item__label {
            color: var(--text-secondary) !important;
        }

        /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
        .el-button--default {
            background: transparent !important;
            border: 1px solid var(--text-secondary) !important;
            color: var(--text-secondary) !important;
        }
        .el-button--default:hover {
            color: var(--accent-blue) !important;
            border-color: var(--accent-blue) !important;
        }
        .el-button--primary {
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue)) !important;
            border: none !important;
            color: white !important;
        }
        .el-button--success {
            background: linear-gradient(45deg, #28c76f, #48da89) !important;
            border: none !important;
            color: white !important;
        }
        .el-button--danger {
            background: rgba(234, 84, 85, 0.2) !important;
            color: #ea5455 !important;
            border: 1px solid #ea5455 !important;
        }
        .el-tag--dark { border-color: transparent; }

        /* =========================================================
           5. åº•å›¾äº¤äº’å¢å¼ºæ ·å¼ (ç”¨äºå®ç°ç‚¹å‡»ä¿®æ”¹åŠŸèƒ½)
           ========================================================= */
        .building-label {
            cursor: pointer;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            transition: all 0.2s;
        }
        .building-label:hover {
            fill: #fff !important;
            text-decoration: underline;
            font-size: 14px;
        }

        .building-polygon {
            cursor: pointer;
            transition: all 0.2s;
        }
        .building-polygon:hover {
            stroke: #fff !important;
            stroke-width: 2 !important;
            fill-opacity: 0.3 !important;
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="resizer" id="dragMe"></div>
    <div class="sidebar-header">
        <h3 style="margin:0 0 10px 0; color:var(--text-primary); display:flex; align-items:center;">
            <i class="el-icon-camera-solid" style="margin-right:8px; color:var(--accent-purple);"></i> æ‹ç‚¹ç…§ç‰‡é€‰æ‹©
        </h3>
        <p style="font-size:12px; color:var(--text-secondary); margin:5px 0 15px 0;">å‹¾é€‰ä»£è¡¨å»ºç­‘ç‰©é¡¶è§’çš„ç…§ç‰‡ä»¥ç»˜åˆ¶å›´æ </p>

        <div>
            <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:8px;">ğŸ“‚ ä»»åŠ¡æ–‡ä»¶å¤¹ç­›é€‰ï¼š</label>
            <select id="folderSelect" style="width:100%; padding:8px; background:#151521; color:white; border:1px solid rgba(255,255,255,0.1); border-radius:4px; outline:none;" onchange="filterPhotosByFolder()">
                <option value="all">åŠ è½½ä¸­...</option>
            </select>
        </div>
    </div>

    <div id="photo-list">
        <div style="text-align:center; margin-top:40px; color:var(--text-secondary);">
            <i class="el-icon-loading"></i> æ•°æ®åŠ è½½ä¸­...
        </div>
    </div>
</div>

<div class="main">
    <div class="toolbar">
        <div class="input-group">
            <i class="el-icon-folder-opened"></i>
            <label>å½“å‰é¡¹ç›®ID:</label>
            <el-tag size="small" type="info" effect="dark">{{ projectId }}</el-tag>
        </div>

        <div style="flex:1"></div>

        <el-button size="small" icon="el-icon-refresh" @click="initPage">åˆ·æ–°æ•°æ®</el-button>
        <el-button type="danger" size="small" icon="el-icon-delete" @click="resetSelection" :disabled="selectedPhotos.length===0">æ¸…ç©ºç”»å¸ƒ</el-button>

        <el-button type="success" size="small" icon="el-icon-check" @click="openSaveDialog" :disabled="selectedPhotos.length<3">ä¿å­˜å›´æ </el-button>

        <el-divider direction="vertical"></el-divider>
        <el-button size="small" icon="el-icon-s-home" @click="goHome">è¿”å›é¦–é¡µ</el-button>
    </div>

    <div id="canvas-container">
        <div class="empty-tip" v-if="selectedPhotos.length === 0">
            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"><i class="el-icon-edit-outline"></i></div>
            <p>è¯·åœ¨å·¦ä¾§å‹¾é€‰ç…§ç‰‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿çº¿ç”Ÿæˆå›´æ </p>
            <p style="font-size:12px; opacity:0.6; margin-top:10px; color:var(--accent-green);">(æç¤ºï¼šç‚¹å‡»åº•å›¾ä¸­çš„ç»¿è‰²æ¥¼æ ‹åï¼Œå¯ä»¥ä¿®æ”¹å‘½åæˆ–ç»‘å®šè®¡åˆ’)</p>
        </div>

        <svg id="svg-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 5;"></svg>

        <svg id="svg-existing-layer" style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events: none; z-index: 1;"></svg>
    </div>

    <el-dialog :title="editMode ? 'ç¼–è¾‘æ¥¼æ ‹ä¿¡æ¯' : 'ä¿å­˜ç”µå­å›´æ '" :visible.sync="saveDialogVisible" width="480px" :close-on-click-modal="false" append-to-body>
        <div style="margin-bottom:20px; color:var(--text-secondary); font-size:13px; background:rgba(115,103,240,0.1); padding:10px; border-radius:4px;">
            <i class="el-icon-info"></i> {{ editMode ? 'åœ¨è¿™é‡Œä¿®æ”¹æ¥¼æ ‹åç§°æˆ–é‡æ–°å…³è”è®¡åˆ’æ¨¡å‹ã€‚' : 'ä¿å­˜åï¼Œè¯·é€‰æ‹©è¯¥å›´æ å¯¹åº”çš„ BIM æ¨¡å‹æ¥¼å·ï¼Œä»¥ä¾¿ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æ–½å·¥è¿›åº¦ã€‚' }}
        </div>

        <el-form :model="saveForm" label-width="100px" size="small">
            <el-form-item label="æ¥¼æ ‹å‘½å" required>
                <el-input v-model="saveForm.name" placeholder="ä¾‹å¦‚ï¼šç»¼åˆæ•™å­¦æ¥¼"></el-input>
            </el-form-item>

            <el-form-item label="å…³è”è®¡åˆ’">
                <el-select v-model="saveForm.plan" placeholder="è¯·é€‰æ‹©å¯¹åº”æ¨¡å‹" style="width:100%" clearable>
                    <el-option label="æš‚ä¸ç»‘å®š (ä»…ä¿å­˜å›´æ )" value=""></el-option>
                    <el-option v-for="item in planOptions" :key="item" :label="'ğŸ—ï¸ æ¨¡å‹: ' + item + 'å·æ¥¼'" :value="item"></el-option>
                </el-select>
            </el-form-item>
        </el-form>

        <span slot="footer" class="dialog-footer" style="display:flex; justify-content:space-between; align-items:center;">
            <div v-if="editMode">
                <el-popconfirm title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¥¼æ ‹å—ï¼Ÿ" icon="el-icon-info" icon-color="red" @confirm="deleteCurrentBuilding">
                    <el-button slot="reference" type="text" style="color:var(--accent-red)">åˆ é™¤æ­¤æ¥¼æ ‹</el-button>
                </el-popconfirm>
            </div>
            <div v-else></div> <div>
                <el-button @click="saveDialogVisible = false" size="small">å– æ¶ˆ</el-button>
                <el-button type="primary" @click="confirmSave" :loading="saving" size="small" icon="el-icon-check">
                    {{ editMode ? 'æ›´æ–°ä¿¡æ¯' : 'ç¡®è®¤ä¿å­˜' }}
                </el-button>
            </div>
        </span>
    </el-dialog>

</div>

<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    // ==========================================
    // 1. ä¾§è¾¹æ æ‹–æ‹½é€»è¾‘ (å®Œæ•´ä¿ç•™)
    // ==========================================
    const resizer = document.getElementById('dragMe');
    const sidebar = document.getElementById('sidebar');
    let x = 0, w = 0;

    resizer.addEventListener('mousedown', e => {
        x = e.clientX;
        w = parseInt(window.getComputedStyle(sidebar).width, 10);
        document.addEventListener('mousemove', mouseMove);
        document.addEventListener('mouseup', mouseUp);
    });

    const mouseMove = e => sidebar.style.width = `${w + e.clientX - x}px`;

    const mouseUp = () => {
        document.removeEventListener('mousemove', mouseMove);
        document.removeEventListener('mouseup', mouseUp);
        window.dispatchEvent(new Event('resize')); // è§¦å‘ç”»å¸ƒé‡ç»˜
    };

    // ==========================================
    // 2. Vue æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    // ==========================================
    new Vue({
        el: '.main',
        data: {
            projectId: 1,
            selectedPhotos: [], // å½“å‰é€‰ä¸­çš„ç…§ç‰‡ç‚¹

            // å¼¹çª—æ§åˆ¶
            saveDialogVisible: false,
            saving: false,

            // ç¼–è¾‘çŠ¶æ€æ§åˆ¶
            editMode: false,
            currentEditId: null,

            // è¡¨å•æ•°æ®
            planOptions: [],
            saveForm: {
                name: '',
                plan: ''
            }
        },
        mounted() {
            // ä» LocalStorage è·å–å½“å‰é¡¹ç›®ID
            const pid = localStorage.getItem('currentProjectId');
            if(pid) this.projectId = pid;

            // æš´éœ²ç»™å…¨å±€ä»¥ä¾¿åŸç”ŸJSè°ƒç”¨
            window.vueInstance = this;

            // åˆå§‹åŒ–æ•°æ®
            setTimeout(initPage, 300);
        },
        methods: {
            initPage() { initPage(); },
            resetSelection() { resetSelection(); },
            goHome() { window.location.href = 'index.html'; },

            // æ‰“å¼€ä¿å­˜å¯¹è¯æ¡† (æ–°å¢æ¨¡å¼)
            openSaveDialog() {
                if(this.selectedPhotos.length < 3) {
                    this.$message.warning("ç”µå­å›´æ è‡³å°‘éœ€è¦ 3 ä¸ªåæ ‡ç‚¹æ‰èƒ½æ„æˆé—­åˆåŒºåŸŸ");
                    return;
                }
                this.editMode = false;
                this.currentEditId = null;

                this.loadPlanOptions();

                this.saveForm.name = '';
                this.saveForm.plan = '';
                this.saveDialogVisible = true;
            },

            // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡† (ä¿®æ”¹æ¨¡å¼)
            openEditDialog(building) {
                this.editMode = true;
                this.currentEditId = building.id; // å­˜ä¸‹ ID ç”¨äºæ›´æ–°

                this.loadPlanOptions();

                // å›æ˜¾æ•°æ®
                this.saveForm.name = building.name;
                this.saveForm.plan = building.planBuildingName;
                this.saveDialogVisible = true;
            },

            // åŠ è½½æœªç»‘å®šçš„è®¡åˆ’åˆ—è¡¨
            loadPlanOptions() {
                const token = localStorage.getItem('token');
                axios.get(`/api/buildings/options/unbound-plans?projectId=${this.projectId}`, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    const result = res.data;
                    if((result.code || result.status) === 200) {
                        this.planOptions = result.data;

                        // ç»†èŠ‚ä¼˜åŒ–ï¼šå¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¸”å½“å‰å·²ç»‘å®šçš„è®¡åˆ’ä¸åœ¨"æœªç»‘å®šåˆ—è¡¨"ä¸­
                        // (å› ä¸ºå®ƒå·²ç»è¢«å½“å‰æ¥¼æ ‹ç»‘å®šäº†)ï¼Œå¾—æŠŠå®ƒåŠ å›æ¥æ˜¾ç¤ºï¼Œå¦åˆ™å›æ˜¾ä¼šæ˜¯ç©ºç™½
                        if (this.editMode && this.saveForm.plan && !this.planOptions.includes(this.saveForm.plan)) {
                            this.planOptions.unshift(this.saveForm.plan);
                        }
                    }
                });
            },

            // ç¡®è®¤ä¿å­˜ / æ›´æ–°
            confirmSave() {
                if(!this.saveForm.name) {
                    this.$message.warning("è¯·è¾“å…¥æ¥¼æ ‹åç§°");
                    return;
                }

                this.saving = true;
                const token = localStorage.getItem('token');
                const authHeader = { 'Authorization': token ? 'Bearer ' + token : '', 'Content-Type': 'application/json' };

                if (this.editMode) {
                    // --- æ ¸å¿ƒé€»è¾‘ 1ï¼šç¼–è¾‘æ¨¡å¼ ---
                    // ç›´æ¥è°ƒç”¨ bind æ¥å£ (å¸¦ ID)ï¼Œåç«¯ä¼šæ‰§è¡Œæ›´æ–°æ“ä½œ
                    axios.post('/api/buildings/bind', {
                        id: this.currentEditId, // ä¼  IDï¼Œç¡®ä¿æ”¹åèƒ½æ‰¾åˆ°äºº
                        projectId: this.projectId,
                        displayName: this.saveForm.name,
                        planBuildingName: this.saveForm.plan
                    }, { headers: authHeader }).then(res => {
                        if ((res.data.code || res.data.status) === 200) {
                            this.$message.success("ä¿®æ”¹æˆåŠŸ");
                            this.saveDialogVisible = false;
                            loadExistingBuildings(); // åˆ·æ–°åº•å›¾
                        } else {
                            this.$message.error(res.data.message || "ä¿®æ”¹å¤±è´¥");
                        }
                    }).finally(() => {
                        this.saving = false;
                    });

                } else {
                    // --- æ ¸å¿ƒé€»è¾‘ 2ï¼šæ–°å¢æ¨¡å¼ ---
                    const coords = this.selectedPhotos.map(p => ({ lat: p.lat, lng: p.lng }));

                    // ç¬¬ä¸€æ­¥ï¼šä¿å­˜å›´æ å‡ ä½•ä¿¡æ¯ï¼Œæ‹¿å› ID
                    axios.post(`/api/buildings/boundary?projectId=${this.projectId}&buildingName=${this.saveForm.name}`, coords, {
                        headers: authHeader
                    }).then(res => {
                        const result = res.data;
                        if((result.code || result.status) === 200) {
                            // å›´æ ä¿å­˜æˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦ç»‘å®šè®¡åˆ’
                            if (this.saveForm.plan) {
                                // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨ç»‘å®šæ¥å£ (ä½¿ç”¨åˆšæ‹¿åˆ°çš„ ID)
                                return axios.post('/api/buildings/bind', {
                                    id: result.data, // result.data æ˜¯åç«¯è¿”å›çš„ ID
                                    projectId: this.projectId,
                                    currentName: this.saveForm.name,
                                    planBuildingName: this.saveForm.plan
                                }, { headers: authHeader });
                            }
                            // æ²¡é€‰è®¡åˆ’ï¼Œç›´æ¥é€šè¿‡
                            return Promise.resolve({ data: { code: 200 } });
                        } else {
                            throw new Error(result.message || "å›´æ ä¿å­˜å¤±è´¥");
                        }
                    }).then(res => {
                        if((res.data.code || res.data.status) === 200) {
                            this.$message.success("ä¿å­˜æˆåŠŸï¼");
                            this.saveDialogVisible = false;
                            loadExistingBuildings(); // åˆ·æ–°åº•å›¾
                            resetSelection();        // æ¸…ç©ºå½“å‰ç”»ç¬”
                        }
                    }).catch(err => {
                        this.$message.error(err.message || "è¯·æ±‚å¤±è´¥");
                    }).finally(() => {
                        this.saving = false;
                    });
                }
            },

            // åˆ é™¤æ¥¼æ ‹
            deleteCurrentBuilding() {
                const token = localStorage.getItem('token');
                axios.delete(`/api/buildings/${this.currentEditId}`, {
                    headers: { 'Authorization': token ? 'Bearer ' + token : '' }
                }).then(res => {
                    if((res.data.code || res.data.status) === 200) {
                        this.$message.success("æ¥¼æ ‹å·²åˆ é™¤");
                        this.saveDialogVisible = false;
                        loadExistingBuildings(); // åˆ·æ–°
                    } else {
                        this.$message.error("åˆ é™¤å¤±è´¥");
                    }
                });
            }
        }
    });

    // ==========================================
    // 3. åŸç”Ÿ JS é€»è¾‘ (è´Ÿè´£ Canvas ç»˜å›¾ä¸æ•°æ®åŠ è½½)
    // ==========================================
    let allPhotos = [];
    let selectedPhotos = [];
    let existingBuildings = []; // å·²ä¿å­˜çš„æ¥¼æ ‹
    let folderNames = new Set();

    let token = localStorage.getItem('token');
    if (token && !token.startsWith('Bearer ')) token = 'Bearer ' + token;

    function updateVueState() {
        if(window.vueInstance) window.vueInstance.selectedPhotos = selectedPhotos;
    }

    async function initPage() {
        await loadPhotos();
        await loadExistingBuildings(); // åŠ è½½åº•å›¾
    }

    // åŠ è½½å·¦ä¾§ç…§ç‰‡åˆ—è¡¨
    async function loadPhotos() {
        const projectId = localStorage.getItem('currentProjectId') || 1;
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '<div style="text-align:center;margin-top:20px;color:#999"><i class="el-icon-loading"></i> æ­£åœ¨åŠ è½½ç…§ç‰‡...</div>';

        try {
            const res = await fetch(`/api/projects/${projectId}/photos`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();

            if ((json.code || json.status) === 200 && json.data) {
                allPhotos = json.data;
                extractFolders(allPhotos);
                filterPhotosByFolder(); // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
            } else {
                listDiv.innerHTML = '<p style="text-align:center">åŠ è½½å¤±è´¥</p>';
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = '<p style="text-align:center">ç½‘ç»œé”™è¯¯</p>';
        }
    }

    // æå–æ–‡ä»¶å¤¹å
    function extractFolders(photos) {
        folderNames.clear();
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="all">ğŸ“‚ æ˜¾ç¤ºå…¨éƒ¨ç…§ç‰‡</option>';

        photos.forEach(p => {
            if (p.photoUrl) {
                const parts = decodeURIComponent(p.photoUrl).split('/');
                if (parts.length >= 3) {
                    let folder = parts[parts.length - 2];
                    if (['Remote-Control', 'origin', 'Photos'].includes(folder)) {
                        folder = parts[parts.length - 3];
                    }
                    if (folder && folder !== 'projects') folderNames.add(folder);
                }
            }
        });

        folderNames.forEach(f => {
            const op = document.createElement('option');
            op.value = f;
            op.innerText = "ğŸ“ " + f;
            select.appendChild(op);
        });

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹
        if (folderNames.size > 0) {
            select.value = folderNames.values().next().value;
        }
    }

    function filterPhotosByFolder() {
        const sel = document.getElementById('folderSelect').value;
        const filtered = (sel === 'all')
            ? allPhotos
            : allPhotos.filter(p => decodeURIComponent(p.photoUrl || '').includes(sel));
        renderPhotoList(filtered);
    }

    function renderPhotoList(photos) {
        const listDiv = document.getElementById('photo-list');
        listDiv.innerHTML = '';

        if (photos.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center;color:#666">è¯¥ç›®å½•ä¸‹æš‚æ— ç…§ç‰‡</p>';
            return;
        }

        photos.forEach(p => {
            if(!p.gpsLat) return; // æ²¡åæ ‡çš„ä¸æ˜¾ç¤º

            const isChecked = selectedPhotos.some(s => s.id == p.id) ? 'checked' : '';
            const name = p.photoUrl ? p.photoUrl.split('/').pop() : 'æœªçŸ¥æ–‡ä»¶';

            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <input type="checkbox" style="margin-right:10px" ${isChecked} onchange="togglePhoto('${p.id}', ${p.gpsLat}, ${p.gpsLng}, this)">
                <img src="${p.photoUrl}" onerror="this.src='https://via.placeholder.com/60/333/999?text=IMG'">
                <div class="photo-info">
                    <span class="photo-name" title="${name}">${name}</span>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // åŠ è½½å·²å­˜åœ¨çš„å›´æ  (ä½œä¸ºåº•å›¾)
    async function loadExistingBuildings() {
        const pid = localStorage.getItem('currentProjectId') || 1;
        try {
            const res = await fetch(`/api/buildings/list?projectId=${pid}`, {
                headers: { 'Authorization': token }
            });
            const json = await res.json();
            if ((json.code || json.status) === 200) {
                existingBuildings = json.data;
                drawCanvas(); // é‡ç»˜
            }
        } catch(e) {}
    }

    window.togglePhoto = function(id, lat, lng, cb) {
        if(cb.checked) {
            selectedPhotos.push({id, lat, lng});
        } else {
            selectedPhotos = selectedPhotos.filter(p => p.id != id);
        }
        updateVueState();
        drawCanvas();
    }

    window.resetSelection = function() {
        selectedPhotos = [];
        // å–æ¶ˆæ‰€æœ‰å‹¾é€‰æ¡†
        document.querySelectorAll('#photo-list input').forEach(c => c.checked = false);
        updateVueState();
        drawCanvas();
    }

    // æ ¸å¿ƒç»˜å›¾å‡½æ•°
    window.drawCanvas = function() {
        const container = document.getElementById('canvas-container');
        document.querySelectorAll('.point-marker').forEach(e => e.remove());

        const svg = document.getElementById('svg-layer'); // åŠ¨æ€å±‚
        const existSvg = document.getElementById('svg-existing-layer'); // åº•å›¾å±‚
        svg.innerHTML = '';
        existSvg.innerHTML = '';

        // 1. è®¡ç®—åæ ‡èŒƒå›´
        let lats = selectedPhotos.map(p => p.lat);
        let lngs = selectedPhotos.map(p => p.lng);

        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                JSON.parse(b.boundaryCoords).forEach(c => {
                    lats.push(c.lat);
                    lngs.push(c.lng);
                });
            }
        });

        if(lats.length === 0) {
            updateVueState();
            return;
        }

        const minLat = Math.min(...lats);
        const maxLat = Math.max(...lats);
        const minLng = Math.min(...lngs);
        const maxLng = Math.max(...lngs);
        const pad = Math.max(maxLat - minLat, maxLng - minLng) * 0.1 || 0.0001;
        const width = container.clientWidth;
        const height = container.clientHeight;

        const toScreen = (lat, lng) => ({
            x: ((lng - (minLng - pad)) / ((maxLng + pad) - (minLng - pad))) * width,
            y: height - ((lat - (minLat - pad)) / ((maxLat + pad) - (minLat - pad))) * height
        });

        // 2. ç»˜åˆ¶å·²å­˜åœ¨çš„æ¥¼æ ‹ (ç»¿è‰²è™šçº¿)
        existingBuildings.forEach(b => {
            if(b.boundaryCoords) {
                const pts = JSON.parse(b.boundaryCoords).map(c => {
                    const s = toScreen(c.lat, c.lng);
                    return `${s.x},${s.y}`;
                }).join(' ');

                // âœ… ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘ç¼–è¾‘
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.onclick = () => { window.vueInstance.openEditDialog(b); };

                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                poly.setAttribute("points", pts);
                poly.setAttribute("class", "building-polygon");
                poly.setAttribute("style", "fill:rgba(40, 199, 111, 0.1); stroke:#28c76f; stroke-width:1.5; stroke-dasharray:5,5; cursor:pointer; pointer-events:all;");

                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                const firstPt = toScreen(JSON.parse(b.boundaryCoords)[0].lat, JSON.parse(b.boundaryCoords)[0].lng);
                txt.setAttribute("x", firstPt.x);
                txt.setAttribute("y", firstPt.y - 10);
                txt.setAttribute("fill", "#28c76f");
                txt.setAttribute("class", "building-label");
                // æ˜¾å¼è®¾ç½® pointer-eventsï¼Œå¹¶ç›´æ¥ç»‘å®šç‚¹å‡»äº‹ä»¶
                txt.setAttribute("style", "cursor: pointer; pointer-events: bounding-box;");
                txt.textContent = b.name + " (âœï¸)";

                // åŒé‡ä¿é™©ï¼šç»™æ–‡å­—å•ç‹¬ç»‘ç‚¹å‡»
                txt.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢å†’æ³¡å¯¼è‡´è§¦å‘ä¸¤æ¬¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    window.vueInstance.openEditDialog(b);
                };

                g.appendChild(poly);
                g.appendChild(txt);
                existSvg.appendChild(g);
            }
        });

        // 3. ç»˜åˆ¶å½“å‰æ­£åœ¨ç”»çš„å›´æ  (ç´«è‰²å®çº¿)
        if(selectedPhotos.length >= 2) {
            const pts = selectedPhotos.map(p => {
                const s = toScreen(p.lat, p.lng);
                return `${s.x},${s.y}`;
            }).join(' ');

            const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            poly.setAttribute("points", pts);
            poly.setAttribute("style", "fill:rgba(115, 103, 240, 0.2); stroke:#7367f0; stroke-width:2;");
            svg.appendChild(poly);
        }

        // 4. ç»˜åˆ¶ç‚¹
        selectedPhotos.forEach((p, i) => {
            const s = toScreen(p.lat, p.lng);
            const dot = document.createElement('div'); dot.className = 'point-marker';
            dot.style.left = s.x + 'px'; dot.style.top = s.y + 'px'; dot.innerText = i + 1;
            dot.onclick = () => { document.querySelector(`input[onchange*="'${p.id}'"]`).click(); };
            container.appendChild(dot);
        });

        updateVueState();
    }

    window.onresize = drawCanvas;
</script>
</body>
</html>